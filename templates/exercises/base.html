{% extends 'main/base.html' %}
{% load static %}

{% block title %}Exercices - GenEX{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* Th√®me rouge et blanc pour les exercices */
    .exercises-hero {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 4rem 0;
        margin-bottom: 3rem;
    }
    
    .exercises-hero h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .exercises-hero p {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .exercise-card {
        background: white;
        border: 2px solid #f8f9fa;
        border-radius: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1);
        overflow: hidden;
    }
    
    .exercise-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 35px rgba(220, 53, 69, 0.2);
        border-color: #dc3545;
    }
    
    .exercise-card-header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 1.5rem;
        position: relative;
    }
    
    .exercise-card-header::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 15px solid transparent;
        border-right: 15px solid transparent;
        border-top: 10px solid #c82333;
    }
    
    .difficulty-badge {
        font-size: 0.8em;
        padding: 0.4em 0.8em;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .difficulty-very-easy { background: #d4edda; color: #155724; }
    .difficulty-easy { background: #cce5ff; color: #004085; }
    .difficulty-medium { background: #fff3cd; color: #856404; }
    .difficulty-hard { background: #f8d7da; color: #721c24; }
    .difficulty-expert { background: #dc3545; color: white; }
    
    .category-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.4em;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }
    
    .ai-generated {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .ai-generated::before {
        content: 'ü§ñ';
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2em;
        opacity: 0.8;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        border-radius: 25px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
    }
    
    .btn-outline-primary {
        border: 2px solid #dc3545;
        color: #dc3545;
        border-radius: 25px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover {
        background: #dc3545;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
    }
    
    .filter-section {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1);
        margin-bottom: 2rem;
    }
    
    .filter-section h3 {
        color: #dc3545;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }
    
    .form-select, .form-control {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.6rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-select:focus, .form-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .progress-ring {
        width: 60px;
        height: 60px;
    }
    
    .progress-ring circle {
        fill: transparent;
        stroke: #e0e0e0;
        stroke-width: 4;
    }
    
    .progress-ring .progress {
        stroke: #dc3545;
        stroke-dasharray: 0 100;
        transition: stroke-dasharray 0.3s ease;
    }
    
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1);
        border: 2px solid #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.15);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #dc3545;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #dc3545;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #dc3545;
        margin-bottom: 1rem;
    }
    
    .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 15px 35px rgba(220, 53, 69, 0.2);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border-radius: 20px 20px 0 0;
        border: none;
    }
    
    .modal-title {
        font-weight: 700;
    }
    
    .btn-close {
        filter: invert(1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="exercises-hero">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1><i class="fas fa-brain me-3"></i>Exercices IA Intelligents</h1>
                <p class="lead">G√©n√©rez et r√©solvez des exercices universitaires avec l'intelligence artificielle. Apprenez, pratiquez et progressez avec des corrections automatiques personnalis√©es.</p>
                
                <!-- Navigation rapide -->
                <div class="mt-4">
                    <div class="btn-group" role="group">
                        <a href="{% url 'exercises:favorites-list' %}" class="btn btn-light btn-lg me-2">
                            <i class="fas fa-heart"></i> Mes Favoris
                        </a>
                        <a href="{% url 'exercises:wishlist-list' %}" class="btn btn-light btn-lg me-2">
                            <i class="fas fa-bookmark"></i> Ma Wishlist
                        </a>
                        <a href="{% url 'exercises:collections-list' %}" class="btn btn-light btn-lg">
                            <i class="fas fa-folder"></i> Mes Collections
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                <div class="stats-card d-inline-block">
                    <div class="stats-number" id="totalExercises">0</div>
                    <div class="stats-label">Exercices Disponibles</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
        <div class="row">
            <!-- Contenu principal - Pleine largeur -->
            <div class="col-12">
            <div class="container-fluid">
                <!-- En-t√™te -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h2 class="mb-0">
                            <i class="fas fa-graduation-cap text-primary"></i>
                            Exercices Intelligents
                        </h2>
                        <p class="text-muted">G√©n√©rez et r√©solvez des exercices adapt√©s √† votre niveau</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary" id="generateAI">
                                <i class="fas fa-robot"></i> G√©n√©rer avec IA
                            </button>
                            <button class="btn btn-outline-secondary" id="createSession">
                                <i class="fas fa-play"></i> Nouvelle Session
                            </button>
                            <button class="btn btn-outline-info" id="manageCollections">
                                <i class="fas fa-folder"></i> Mes Collections
                            </button>
                            <button class="btn btn-outline-warning" id="viewHistory">
                                <i class="fas fa-history"></i> Historique
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Statistiques rapides -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <i class="fas fa-tasks fa-2x mb-2 text-danger"></i>
                            <div class="stats-number" id="totalExercises">0</div>
                            <div class="stats-label">Exercices disponibles</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                            <div class="stats-number" id="completedExercises">0</div>
                            <div class="stats-label">Exercices r√©solus</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <i class="fas fa-robot fa-2x mb-2 text-warning"></i>
                            <div class="stats-number" id="aiGeneratedCount">0</div>
                            <div class="stats-label">G√©n√©r√©s par IA</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <i class="fas fa-chart-line fa-2x mb-2 text-info"></i>
                            <div class="stats-number" id="averageScore">0%</div>
                            <div class="stats-label">Score moyen</div>
                        </div>
                    </div>
                </div>
                
                <!-- Barre de recherche -->
                <div class="row mb-4">
                    <div class="col">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Rechercher des exercices...">
                            <button class="btn btn-outline-secondary" id="clearSearch">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Liste des exercices -->
                <div id="exercisesContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 text-muted">Chargement des exercices...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Pagination des exercices" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination sera g√©n√©r√©e dynamiquement -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal de g√©n√©ration IA -->
<div class="modal fade" id="aiGenerationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-robot text-primary"></i>
                    G√©n√©ration d'exercices par IA
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="aiGenerationForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-book me-2"></i>Mati√®re / Cours
                                </label>
                                <input type="text" class="form-control" name="subject" required 
                                       placeholder="Ex: Math√©matiques, Physique, Histoire, Programmation...">
                                <div class="form-text">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    √âcrivez le nom de la mati√®re ou du cours pour lequel vous voulez des exercices
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-chart-line me-2"></i>Difficult√©
                                </label>
                                <select class="form-select" name="difficulty" required>
                                    <option value="">S√©lectionner un niveau</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Type d'exercice</label>
                                <select class="form-select" name="exercise_type" required>
                                    <option value="">S√©lectionner un type</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre d'exercices</label>
                                <select class="form-select" name="count">
                                    <option value="1">1 exercice</option>
                                    <option value="2">2 exercices</option>
                                    <option value="3" selected>3 exercices</option>
                                    <option value="4">4 exercices</option>
                                    <option value="5">5 exercices</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Prompt personnalis√© (optionnel)</label>
                        <textarea class="form-control" name="custom_prompt" rows="3" 
                                  placeholder="D√©crivez le type d'exercices que vous souhaitez g√©n√©rer..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Sujets sp√©cifiques (optionnel)</label>
                        <input type="text" class="form-control" name="specific_topics" 
                               placeholder="Ex: √©quations, g√©om√©trie, alg√®bre (s√©par√©s par des virgules)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="generateExercises">
                    <i class="fas fa-magic"></i> G√©n√©rer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de session -->
<div class="modal fade" id="sessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play text-success"></i>
                    Nouvelle Session d'exercices
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sessionForm">
                    <div class="mb-3">
                        <label class="form-label">Nom de la session</label>
                        <input type="text" class="form-control" name="name" required 
                               placeholder="Ex: R√©vision Math√©matiques">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2" 
                                  placeholder="Description de la session..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cat√©gorie</label>
                                <select class="form-select" name="category">
                                    <option value="">Toutes</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Difficult√©</label>
                                <select class="form-select" name="difficulty">
                                    <option value="">Tous niveaux</option>
                                    {% for difficulty in difficulties %}
                                        <option value="{{ difficulty.id }}">{{ difficulty.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre d'exercices</label>
                                <input type="number" class="form-control" name="exercise_count" 
                                       min="1" max="20" value="5">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Limite de temps (minutes)</label>
                                <input type="number" class="form-control" name="time_limit" 
                                       min="5" max="180" placeholder="Optionnel">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="createSessionBtn">
                    <i class="fas fa-play"></i> Cr√©er la session
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ajouter √† une collection -->
<div class="modal fade" id="collectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder-plus text-info"></i>
                    Ajouter √† une collection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">S√©lectionner une collection</label>
                    <select class="form-select" id="collectionSelect">
                        <option value="">S√©lectionner une collection</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <a href="#" onclick="showCreateCollectionModal()">Cr√©er une nouvelle collection</a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-info" onclick="addToCollection()">
                    <i class="fas fa-plus"></i> Ajouter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour cr√©er une collection -->
<div class="modal fade" id="createCollectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder-plus text-success"></i>
                    Cr√©er une nouvelle collection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCollectionForm">
                    <div class="mb-3">
                        <label class="form-label">Nom de la collection</label>
                        <input type="text" class="form-control" name="name" required 
                               placeholder="Ex: Mes exercices de math√©matiques">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2" 
                                  placeholder="Description de la collection..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Couleur</label>
                                <select class="form-select" name="color">
                                    <option value="#dc3545">Rouge</option>
                                    <option value="#007bff">Bleu</option>
                                    <option value="#28a745">Vert</option>
                                    <option value="#ffc107">Jaune</option>
                                    <option value="#6f42c1">Violet</option>
                                    <option value="#fd7e14">Orange</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ic√¥ne</label>
                                <select class="form-select" name="icon">
                                    <option value="fas fa-folder">Dossier</option>
                                    <option value="fas fa-book">Livre</option>
                                    <option value="fas fa-graduation-cap">Dipl√¥me</option>
                                    <option value="fas fa-star">√âtoile</option>
                                    <option value="fas fa-heart">C≈ìur</option>
                                    <option value="fas fa-fire">Feu</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_public" id="isPublic">
                        <label class="form-check-label" for="isPublic">
                            Collection publique (visible par d'autres utilisateurs)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" onclick="createCollection()">
                    <i class="fas fa-plus"></i> Cr√©er
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour g√©rer les collections -->
<div class="modal fade" id="manageCollectionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder text-info"></i>
                    Mes Collections
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6>Mes Collections</h6>
                    <button class="btn btn-success btn-sm" onclick="showCreateCollectionModal()">
                        <i class="fas fa-plus"></i> Nouvelle collection
                    </button>
                </div>
                <div id="collectionsList">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 text-muted">Chargement des collections...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour l'historique -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history text-warning"></i>
                    Historique des exercices
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="historyList">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 text-muted">Chargement de l'historique...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Configuration de l'API
const API_BASE = '/exercises/api/';

// Variables globales
let currentPage = 1;
let currentFilters = {};
let exercises = [];
let categories = [];
let difficulties = [];
let types = [];

// Fonction generateExercises int√©gr√©e dans l'√©v√©nement

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== INITIALISATION PAGE EXERCICES ===');
    loadInitialData();
    setupEventListeners();
    console.log('=== INITIALISATION TERMINEE ===');
});

// Charger les donn√©es initiales
async function loadInitialData() {
    try {
        console.log('=== CHARGEMENT DONNEES INITIALES ===');
        
        // Charger d'abord les donn√©es de base
        await Promise.all([
            loadCategories(),
            loadDifficulties(),
            loadTypes()
        ]);
        
        console.log('Donn√©es de base charg√©es, chargement des exercices...');
        
        // Puis charger les exercices
        await loadExercises();
        
        updateStatistics();
        console.log('=== FIN CHARGEMENT DONNEES INITIALES ===');
    } catch (error) {
        console.error('Erreur lors du chargement des donn√©es:', error);
        showError('Erreur lors du chargement des donn√©es');
    }
}

// Charger les cat√©gories (pour les filtres uniquement)
async function loadCategories() {
    try {
        console.log('Chargement des cat√©gories...');
        const response = await fetch(`${API_BASE}categories/`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        categories = data.results || data;
        console.log('Cat√©gories charg√©es:', categories);
        
        // Peupler le filtre de cat√©gories (pas le modal de g√©n√©ration)
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter) {
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categoryFilter.appendChild(option);
            });
            console.log('Cat√©gories ajout√©es au filtre');
        }
    } catch (error) {
        console.error('Erreur lors du chargement des cat√©gories:', error);
    }
}

// Charger les difficult√©s
async function loadDifficulties() {
    try {
        console.log('Chargement des difficult√©s...');
        const response = await fetch(`${API_BASE}difficulties/`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        difficulties = data.results || data;
        console.log('Difficult√©s charg√©es:', difficulties);
        
        const difficultySelects = document.querySelectorAll('select[name="difficulty"]');
        console.log('S√©lecteurs de difficult√©s trouv√©s:', difficultySelects.length);
        
        difficultySelects.forEach(select => {
            difficulties.forEach(difficulty => {
                const option = document.createElement('option');
                option.value = difficulty.id;
                option.textContent = difficulty.name;
                select.appendChild(option);
            });
        });
        console.log('Difficult√©s ajout√©es aux s√©lecteurs');
    } catch (error) {
        console.error('Erreur lors du chargement des difficult√©s:', error);
    }
}

// Charger les types
async function loadTypes() {
    try {
        console.log('Chargement des types...');
        const response = await fetch(`${API_BASE}types/`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        types = data.results || data;
        console.log('Types charg√©s:', types);
        
        const typeSelects = document.querySelectorAll('select[name="exercise_type"]');
        console.log('S√©lecteurs de types trouv√©s:', typeSelects.length);
        
        typeSelects.forEach(select => {
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        });
        console.log('Types ajout√©s aux s√©lecteurs');
    } catch (error) {
        console.error('Erreur lors du chargement des types:', error);
    }
}

// Charger les exercices
async function loadExercises() {
    console.log('=== DEBUT CHARGEMENT EXERCICES ===');
    const container = document.getElementById('exercisesContainer');
    if (!container) {
        console.error('Container exercisesContainer non trouv√©!');
        return;
    }
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Chargement des exercices...</p></div>';
    
    try {
        const params = new URLSearchParams({
            page: currentPage,
            ...currentFilters
        });
        
        const url = `${API_BASE}exercises/?${params}`;
        console.log('URL de requ√™te:', url);
        console.log('Filtres actuels:', currentFilters);
        
        const response = await fetch(url);
        console.log('R√©ponse re√ßue:', response.status, response.statusText);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Donn√©es re√ßues:', data);
        
        exercises = data.results || data;
        console.log('Exercices extraits:', exercises.length, 'exercices');
        
        displayExercises(exercises);
        console.log('=== FIN CHARGEMENT EXERCICES ===');
    } catch (error) {
        console.error('Erreur lors du chargement des exercices:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement des exercices: ' + error.message + '</div>';
    }
}

// Afficher les exercices
function displayExercises(exercises) {
    console.log('=== DEBUT AFFICHAGE EXERCICES ===');
    console.log('Exercices √† afficher:', exercises.length);
    console.log('Categories disponibles:', categories.length);
    console.log('Difficult√©s disponibles:', difficulties.length);
    
    const container = document.getElementById('exercisesContainer');
    
    if (exercises.length === 0) {
        console.log('Aucun exercice √† afficher');
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Aucun exercice trouv√©</h5>
                <p class="text-muted">Essayez de modifier vos filtres ou g√©n√©rez de nouveaux exercices avec l'IA</p>
            </div>
        `;
        return;
    }
    
    console.log('Cr√©ation des cartes d\'exercices...');
    const exercisesHtml = exercises.map(exercise => createExerciseCard(exercise)).join('');
    container.innerHTML = `<div class="row">${exercisesHtml}</div>`;
    
    // Mettre √† jour le compteur dans le hero
    document.getElementById('totalExercises').textContent = exercises.length;
    
    console.log('=== FIN AFFICHAGE EXERCICES ===');
}

// Cr√©er une carte d'exercice
function createExerciseCard(exercise) {
    const category = categories.find(c => c.id === exercise.category);
    const difficulty = difficulties.find(d => d.id === exercise.difficulty);
    
    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card exercise-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="category-icon me-2" style="background-color: ${category?.color || '#007bff'}">
                            <i class="fas fa-${category?.icon || 'book'}"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">${category?.name || 'Inconnu'}</h6>
                            <small class="text-muted">${exercise.exercise_type_name || 'Exercice'}</small>
                        </div>
                    </div>
                    ${exercise.is_ai_generated ? '<span class="badge ai-generated"><i class="fas fa-robot"></i> IA</span>' : ''}
                </div>
                
                <div class="card-body">
                    <h5 class="card-title">${exercise.title}</h5>
                    <p class="card-text text-muted">${exercise.content_preview}</p>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge difficulty-badge" style="background-color: ${difficulty?.color || '#28a745'}">
                            ${difficulty?.name || 'Inconnu'}
                        </span>
                        <div class="text-muted small">
                            <i class="fas fa-clock"></i> ${exercise.estimated_time}min
                            <i class="fas fa-star ms-2"></i> ${exercise.points}pts
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-user"></i> ${exercise.created_by_username}
                        </small>
                        <small class="text-muted">
                            ${new Date(exercise.created_at).toLocaleDateString()}
                        </small>
                    </div>
                </div>
                
                <div class="card-footer bg-transparent">
                    <!-- Actions principales -->
                    <div class="d-grid gap-2 mb-2">
                        <button class="btn btn-primary btn-sm" onclick="startExercise(${exercise.id})">
                            <i class="fas fa-play"></i> Commencer
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="viewExercise(${exercise.id})">
                            <i class="fas fa-eye"></i> Voir
                        </button>
                    </div>
                    
                    <!-- Actions secondaires -->
                    <div class="d-flex justify-content-between">
                        <button class="btn ${exercise.user_status && exercise.user_status.is_favorite ? 'btn-danger' : 'btn-outline-danger'} btn-sm" 
                                onclick="toggleFavorite(${exercise.id})" 
                                id="favoriteBtn${exercise.id}" 
                                title="${exercise.user_status && exercise.user_status.is_favorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                            <i class="${exercise.user_status && exercise.user_status.is_favorite ? 'fas' : 'far'} fa-heart"></i>
                        </button>
                        <button class="btn ${exercise.user_status && exercise.user_status.is_wishlist ? 'btn-warning' : 'btn-outline-warning'} btn-sm" 
                                onclick="addToWishlist(${exercise.id})" 
                                id="wishlistBtn${exercise.id}" 
                                title="${exercise.user_status && exercise.user_status.is_wishlist ? 'Retirer de la wishlist' : 'Ajouter √† la wishlist'}">
                            <i class="${exercise.user_status && exercise.user_status.is_wishlist ? 'fas' : 'far'} fa-bookmark"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showCollectionModal(${exercise.id})" 
                                title="Ajouter √† une collection">
                            <i class="fas fa-folder-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Mettre √† jour les statistiques
function updateStatistics() {
    // Cette fonction serait impl√©ment√©e pour charger les vraies statistiques
    document.getElementById('totalExercises').textContent = exercises.length;
    document.getElementById('completedExercises').textContent = '0';
    document.getElementById('aiGeneratedCount').textContent = exercises.filter(e => e.is_ai_generated).length;
    document.getElementById('averageScore').textContent = '0%';
}

// Configurer les √©couteurs d'√©v√©nements
function setupEventListeners() {
    console.log('=== CONFIGURATION DES EVENEMENTS ===');
    
    // Filtres supprim√©s - interface simplifi√©e
    
    // Recherche
    document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
    document.getElementById('clearSearch').addEventListener('click', clearSearch);
    
    // Boutons
    const generateAI = document.getElementById('generateAI');
    const createSession = document.getElementById('createSession');
    const generateExercises = document.getElementById('generateExercises');
    const createSessionBtn = document.getElementById('createSessionBtn');
    
    console.log('√âl√©ments trouv√©s:');
    console.log('- generateAI:', generateAI ? 'OK' : 'MANQUANT');
    console.log('- createSession:', createSession ? 'OK' : 'MANQUANT');
    console.log('- generateExercises:', generateExercises ? 'OK' : 'MANQUANT');
    console.log('- createSessionBtn:', createSessionBtn ? 'OK' : 'MANQUANT');
    
    if (generateAI) generateAI.addEventListener('click', showAIGenerationModal);
    if (createSession) createSession.addEventListener('click', showSessionModal);
    if (generateExercises) {
        generateExercises.addEventListener('click', async function() {
            console.log('Bouton G√©n√©rer cliqu√© !');
            console.log('=== FONCTION generateExercises APPELEE ===');
            console.log('D√©but de la g√©n√©ration d\'exercices...');
            
            const form = document.getElementById('aiGenerationForm');
            if (!form) {
                console.error('Formulaire aiGenerationForm non trouv√© !');
                return;
            }
            
            const formData = new FormData(form);
            
            // V√©rifier que tous les champs requis sont remplis
            const subject = formData.get('subject');
            const difficulty = formData.get('difficulty');
            const exercise_type = formData.get('exercise_type');
            
            console.log('Valeurs du formulaire:');
            console.log('- subject:', subject);
            console.log('- difficulty:', difficulty);
            console.log('- exercise_type:', exercise_type);
            
            if (!subject || !difficulty || !exercise_type) {
                console.error('Champs manquants:', { subject, difficulty, exercise_type });
                showError('Veuillez remplir tous les champs requis');
                return;
            }
            
            const data = {
                subject: subject,
                difficulty: parseInt(difficulty),
                exercise_type: parseInt(exercise_type),
                count: parseInt(formData.get('count')),
                custom_prompt: formData.get('custom_prompt'),
                specific_topics: formData.get('specific_topics') ? formData.get('specific_topics').split(',').map(s => s.trim()) : []
            };
            
            console.log('Donn√©es √† envoyer:', data);
            
            try {
                console.log('Envoi de la requ√™te √†:', `${API_BASE}exercises/generate_ai/`);
                
                const response = await fetch(`${API_BASE}exercises/generate_ai/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('R√©ponse re√ßue:', response.status, response.statusText);
                const result = await response.json();
                console.log('R√©sultat:', result);
                
                if (result.success) {
                    console.log('G√©n√©ration r√©ussie, rechargement de la liste...');
                    showSuccess('Exercices g√©n√©r√©s avec succ√®s!');
                    bootstrap.Modal.getInstance(document.getElementById('aiGenerationModal')).hide();
                    
                    // Attendre un peu avant de recharger pour que la base de donn√©es soit mise √† jour
                    setTimeout(() => {
                        console.log('Rechargement des exercices...');
                        loadExercises();
                    }, 1000);
                } else {
                    showError(result.error || 'Erreur lors de la g√©n√©ration');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur lors de la g√©n√©ration des exercices');
            }
        });
    }
    if (createSessionBtn) createSessionBtn.addEventListener('click', createSession);
    
    // Bouton g√©rer collections
    const manageCollectionsBtn = document.getElementById('manageCollections');
    if (manageCollectionsBtn) {
        manageCollectionsBtn.addEventListener('click', showManageCollectionsModal);
    }
    
    // Bouton historique
    const viewHistoryBtn = document.getElementById('viewHistory');
    if (viewHistoryBtn) {
        viewHistoryBtn.addEventListener('click', showHistoryModal);
    }
    
    console.log('=== EVENEMENTS CONFIGURES ===');
}

// Appliquer les filtres
function applyFilters() {
    currentFilters = {
        category: document.getElementById('categoryFilter').value,
        difficulty: document.getElementById('difficultyFilter').value,
        exercise_type: document.getElementById('typeFilter').value,
        search: document.getElementById('searchInput').value,
        is_ai_generated: document.getElementById('aiGeneratedFilter').checked
    };
    
    // Nettoyer les filtres vides
    Object.keys(currentFilters).forEach(key => {
        if (!currentFilters[key]) {
            delete currentFilters[key];
        }
    });
    
    currentPage = 1;
    loadExercises();
}

// Effacer la recherche
function clearSearch() {
    document.getElementById('searchInput').value = '';
    applyFilters();
}

// Fonction debounce
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Afficher le modal de g√©n√©ration IA
function showAIGenerationModal() {
    const modal = new bootstrap.Modal(document.getElementById('aiGenerationModal'));
    modal.show();
}

// Afficher le modal de session
function showSessionModal() {
    const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
    modal.show();
}

// Fonction generateExercises maintenant int√©gr√©e dans l'√©v√©nement

// Cr√©er une session
async function createSession() {
    const form = document.getElementById('sessionForm');
    const formData = new FormData(form);
    
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        category: formData.get('category') ? parseInt(formData.get('category')) : null,
        difficulty: formData.get('difficulty') ? parseInt(formData.get('difficulty')) : null,
        exercise_count: parseInt(formData.get('exercise_count')),
        time_limit: formData.get('time_limit') ? parseInt(formData.get('time_limit')) : null
    };
    
    try {
        const response = await fetch(`${API_BASE}sessions/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showSuccess('Session cr√©√©e avec succ√®s!');
            bootstrap.Modal.getInstance(document.getElementById('sessionModal')).hide();
        } else {
            const error = await response.json();
            showError(error.detail || 'Erreur lors de la cr√©ation de la session');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la cr√©ation de la session');
    }
}

// Commencer un exercice
function startExercise(exerciseId) {
    window.location.href = `/exercises/${exerciseId}/solve/`;
}

// Voir un exercice
function viewExercise(exerciseId) {
    // Enregistrer la consultation dans l'historique
    trackExerciseView(exerciseId);
    window.location.href = `/exercises/${exerciseId}/`;
}

// Enregistrer la consultation d'un exercice
async function trackExerciseView(exerciseId) {
    try {
        await fetch(`${API_BASE}exercises/${exerciseId}/track_view/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                time_spent: 0 // Temps initial
            })
        });
    } catch (error) {
        console.log('Erreur lors de l\'enregistrement de la consultation:', error);
    }
}

// Fonctions pour les favoris et collections
async function toggleFavorite(exerciseId) {
    const button = document.getElementById(`favoriteBtn${exerciseId}`);
    const icon = button.querySelector('i');
    
    try {
        // V√©rifier si c'est d√©j√† un favori
        const isFavorite = icon.classList.contains('fas');
        
        const response = await fetch(`${API_BASE}exercises/${exerciseId}/favorite/`, {
            method: isFavorite ? 'DELETE' : 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            if (isFavorite) {
                icon.classList.remove('fas');
                icon.classList.add('far');
                button.classList.remove('btn-danger');
                button.classList.add('btn-outline-danger');
                showSuccess('Exercice retir√© des favoris');
            } else {
                icon.classList.remove('far');
                icon.classList.add('fas');
                button.classList.remove('btn-outline-danger');
                button.classList.add('btn-danger');
                showSuccess('Exercice ajout√© aux favoris');
            }
        } else {
            showError('Erreur lors de la modification des favoris');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la modification des favoris');
    }
}

async function addToWishlist(exerciseId) {
    const button = document.getElementById(`wishlistBtn${exerciseId}`);
    const icon = button.querySelector('i');
    
    try {
        // V√©rifier si c'est d√©j√† dans la wishlist
        const isInWishlist = icon.classList.contains('fas');
        
        const response = await fetch(`${API_BASE}exercises/${exerciseId}/wishlist/`, {
            method: isInWishlist ? 'DELETE' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Mettre √† jour l'ic√¥ne
            if (data.is_wishlist) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                button.classList.remove('btn-outline-warning');
                button.classList.add('btn-warning');
                button.title = 'Retirer de la wishlist';
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                button.classList.remove('btn-warning');
                button.classList.add('btn-outline-warning');
                button.title = 'Ajouter √† la wishlist';
            }
            
            showSuccess(data.message);
        } else {
            throw new Error('Erreur lors de la modification de la wishlist');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la modification de la wishlist');
    }
}

function showCollectionModal(exerciseId) {
    // Stocker l'ID de l'exercice pour l'utiliser dans le modal
    window.currentExerciseId = exerciseId;
    
    // Charger les collections de l'utilisateur
    loadUserCollections();
    
    // Afficher le modal
    const modal = new bootstrap.Modal(document.getElementById('collectionModal'));
    modal.show();
}

async function loadUserCollections() {
    try {
        console.log('Chargement des collections utilisateur...');
        const response = await fetch(`${API_BASE}collections/`);
        console.log('R√©ponse collections:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Donn√©es collections re√ßues:', data);
            
            // G√©rer les deux formats possibles : direct array ou paginated
            const collections = data.results || data;
            console.log('Collections extraites:', collections.length, 'collections');
            
            const select = document.getElementById('collectionSelect');
            if (!select) {
                console.error('√âl√©ment collectionSelect non trouv√©!');
                return;
            }
            
            select.innerHTML = '<option value="">S√©lectionner une collection</option>';
            
            if (collections.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Aucune collection disponible";
                option.disabled = true;
                select.appendChild(option);
            } else {
                collections.forEach(collection => {
                    const option = document.createElement('option');
                    option.value = collection.id;
                    option.textContent = collection.name;
                    select.appendChild(option);
                });
            }
            
            console.log('Collections ajout√©es au s√©lecteur:', collections.length);
        } else {
            console.error('Erreur HTTP:', response.status, response.statusText);
        }
    } catch (error) {
        console.error('Erreur lors du chargement des collections:', error);
    }
}

async function addToCollection() {
    const exerciseId = window.currentExerciseId;
    const collectionId = document.getElementById('collectionSelect').value;
    
    if (!collectionId) {
        showError('Veuillez s√©lectionner une collection');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}exercises/${exerciseId}/add_to_collection/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                collection_id: collectionId
            })
        });
        
        if (response.ok) {
            showSuccess('Exercice ajout√© √† la collection');
            bootstrap.Modal.getInstance(document.getElementById('collectionModal')).hide();
        } else {
            const error = await response.json();
            showError(error.error || 'Erreur lors de l\'ajout √† la collection');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de l\'ajout √† la collection');
    }
}

// Fonctions utilitaires
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fonctions pour g√©rer les collections
function showCreateCollectionModal() {
    // Fermer le modal actuel s'il est ouvert
    const currentModal = bootstrap.Modal.getInstance(document.getElementById('collectionModal'));
    if (currentModal) {
        currentModal.hide();
    }
    
    // Afficher le modal de cr√©ation
    const modal = new bootstrap.Modal(document.getElementById('createCollectionModal'));
    modal.show();
}

function showManageCollectionsModal() {
    const modal = new bootstrap.Modal(document.getElementById('manageCollectionsModal'));
    modal.show();
    loadCollectionsList();
}

async function createCollection() {
    const form = document.getElementById('createCollectionForm');
    const formData = new FormData(form);
    
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        color: formData.get('color'),
        icon: formData.get('icon'),
        is_public: formData.get('is_public') === 'on'
    };
    
    try {
        const response = await fetch(`${API_BASE}collections/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showSuccess('Collection cr√©√©e avec succ√®s!');
            bootstrap.Modal.getInstance(document.getElementById('createCollectionModal')).hide();
            form.reset();
            // Recharger les collections dans le modal d'ajout
            loadUserCollections();
        } else {
            const errorData = await response.json();
            console.error('Erreur de cr√©ation:', errorData);
            
            // V√©rifier si c'est une erreur de contrainte d'unicit√©
            if (response.status === 500 && errorData.detail && errorData.detail.includes('UNIQUE constraint failed')) {
                // Proposer un nom unique
                const originalName = data.name;
                let counter = 1;
                let newName = `${originalName} (${counter})`;
                
                // Essayer jusqu'√† 10 fois avec des noms diff√©rents
                while (counter <= 10) {
                    data.name = newName;
                    
                    const retryResponse = await fetch(`${API_BASE}collections/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (retryResponse.ok) {
                        showSuccess(`Collection cr√©√©e avec succ√®s! (Nom: ${newName})`);
                        bootstrap.Modal.getInstance(document.getElementById('createCollectionModal')).hide();
                        form.reset();
                        loadUserCollections();
                        return;
                    }
                    
                    counter++;
                    newName = `${originalName} (${counter})`;
                }
                
                showError(`Une collection avec le nom "${originalName}" existe d√©j√†. Veuillez choisir un autre nom.`);
            } else {
                showError(errorData.detail || 'Erreur lors de la cr√©ation de la collection');
            }
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la cr√©ation de la collection');
    }
}

async function loadCollectionsList() {
    try {
        console.log('Chargement de la liste des collections...');
        const response = await fetch(`${API_BASE}collections/`);
        console.log('R√©ponse collections liste:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Donn√©es collections liste re√ßues:', data);
            
            // G√©rer les deux formats possibles : direct array ou paginated
            const collections = data.results || data;
            console.log('Collections extraites pour liste:', collections.length, 'collections');
            
            const container = document.getElementById('collectionsList');
            if (!container) {
                console.error('√âl√©ment collectionsList non trouv√©!');
                return;
            }
            
            if (collections.length === 0) {
                       container.innerHTML = `
                           <div class="text-center py-4">
                               <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                               <h5 class="text-muted">Aucune collection</h5>
                               <p class="text-muted">Cr√©ez votre premi√®re collection pour organiser vos exercices.</p>
                               <div class="d-grid gap-2">
                                   <button class="btn btn-primary" onclick="showCreateCollectionModal()">
                                       <i class="fas fa-plus"></i> Cr√©er une collection
                                   </button>
                                   <button class="btn btn-outline-secondary" onclick="createTestCollections()">
                                       <i class="fas fa-magic"></i> Cr√©er des collections de test
                                   </button>
                               </div>
                           </div>
                       `;
            } else {
                const collectionsHtml = collections.map(collection => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="me-3" style="color: ${collection.color}">
                                        <i class="${collection.icon} fa-2x"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">${collection.name}</h6>
                                        <p class="text-muted mb-1">${collection.description || 'Aucune description'}</p>
                                        <small class="text-muted">
                                            <i class="fas fa-file-alt me-1"></i>
                                            ${collection.exercise_count} exercice(s)
                                        </small>
                                    </div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewCollection(${collection.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCollection(${collection.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = collectionsHtml;
            }
        }
    } catch (error) {
        console.error('Erreur lors du chargement des collections:', error);
        document.getElementById('collectionsList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Erreur lors du chargement des collections
            </div>
        `;
    }
}

async function deleteCollection(collectionId) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette collection ?')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}collections/${collectionId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            showSuccess('Collection supprim√©e avec succ√®s!');
            loadCollectionsList();
            loadUserCollections(); // Recharger aussi la liste dans le modal d'ajout
        } else {
            showError('Erreur lors de la suppression de la collection');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la suppression de la collection');
    }
}

function viewCollection(collectionId) {
    // Rediriger vers une page de d√©tail de la collection
    window.location.href = `/exercises/collections/${collectionId}/`;
}

// Fonctions pour l'historique
function showHistoryModal() {
    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
    modal.show();
    loadHistory();
}

async function loadHistory() {
    try {
        console.log('Chargement de l\'historique...');
        const response = await fetch(`${API_BASE}history/`);
        console.log('R√©ponse historique:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Donn√©es historique re√ßues:', data);
            
            // G√©rer les deux formats possibles : direct array ou paginated
            const history = data.results || data;
            console.log('Historique extrait:', history.length, '√©l√©ments');
            
            const container = document.getElementById('historyList');
            if (!container) {
                console.error('√âl√©ment historyList non trouv√©!');
                return;
            }
            
            if (!history || history.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Aucun historique</h5>
                        <p class="text-muted">Commencez √† consulter des exercices pour voir votre historique.</p>
                        <button class="btn btn-primary" onclick="createTestHistory()">
                            <i class="fas fa-plus"></i> Cr√©er des donn√©es de test
                        </button>
                    </div>
                `;
            } else {
                const historyHtml = history.map(item => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-file-alt fa-2x text-primary"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">${item.exercise.title}</h6>
                                        <p class="text-muted mb-1">${item.exercise.content_preview}</p>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            Temps pass√©: ${Math.round(item.time_spent / 60)} min
                                        </small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">
                                        ${new Date(item.viewed_at).toLocaleDateString()}
                                    </small>
                                    <div class="mt-2">
                                        <button class="btn btn-outline-primary btn-sm" onclick="startExercise(${item.exercise.id})">
                                            <i class="fas fa-play"></i> Recommencer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = historyHtml;
            }
        }
    } catch (error) {
        console.error('Erreur lors du chargement de l\'historique:', error);
        document.getElementById('historyList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Erreur lors du chargement de l'historique
            </div>
        `;
    }
}

// Cr√©er des donn√©es de test pour l'historique
async function createTestHistory() {
    try {
        // R√©cup√©rer quelques exercices
        const exercisesResponse = await fetch(`${API_BASE}exercises/?page=1&page_size=3`);
        if (exercisesResponse.ok) {
            const exercisesData = await exercisesResponse.json();
            const exercises = exercisesData.results || [];
            
            // Cr√©er de l'historique pour chaque exercice
            for (const exercise of exercises) {
                await fetch(`${API_BASE}exercises/${exercise.id}/track_view/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        time_spent: Math.random() * 300 + 60 // 1-6 minutes
                    })
                });
            }
            
            showSuccess('Donn√©es de test cr√©√©es!');
            loadHistory(); // Recharger l'historique
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la cr√©ation des donn√©es de test');
    }
}

// Cr√©er des collections de test
async function createTestCollections() {
    const testCollections = [
        {
            name: 'Mes Exercices Favoris',
            description: 'Collection de mes exercices pr√©f√©r√©s',
            color: '#dc3545',
            icon: 'fas fa-heart',
            is_public: false
        },
        {
            name: 'Math√©matiques Avanc√©es',
            description: 'Exercices de math√©matiques de niveau avanc√©',
            color: '#007bff',
            icon: 'fas fa-calculator',
            is_public: true
        },
        {
            name: '√Ä R√©viser',
            description: 'Exercices que je dois r√©viser',
            color: '#ffc107',
            icon: 'fas fa-book',
            is_public: false
        }
    ];
    
    try {
        let createdCount = 0;
        for (const collectionData of testCollections) {
            try {
                const response = await fetch(`${API_BASE}collections/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(collectionData)
                });
                
                if (response.ok) {
                    createdCount++;
                } else {
                    console.log(`Collection "${collectionData.name}" existe d√©j√† ou erreur`);
                }
            } catch (error) {
                console.log(`Erreur pour "${collectionData.name}":`, error);
            }
        }
        
        if (createdCount > 0) {
            showSuccess(`${createdCount} collections de test cr√©√©es!`);
        } else {
            showSuccess('Collections de test d√©j√† existantes!');
        }
        
        loadCollectionsList(); // Recharger la liste
        loadUserCollections(); // Recharger aussi la liste dans le modal d'ajout
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la cr√©ation des collections de test');
    }
}

function showSuccess(message) {
    // Cr√©er une alerte Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Supprimer automatiquement apr√®s 3 secondes
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

function showError(message) {
    // Cr√©er une alerte Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Supprimer automatiquement apr√®s 5 secondes
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

</script>
{% endblock %}
