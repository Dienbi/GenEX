{% extends 'main/base.html' %}
{% load static %}

{% block title %}R√©soudre l'exercice - {{ exercise.title }}{% endblock %}

{% block extra_css %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    /* Th√®me rouge et blanc pour la r√©solution d'exercices */
    .exercise-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .exercise-header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow: 0 15px 35px rgba(220, 53, 69, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .exercise-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }
    
    .exercise-content {
        background: white;
        padding: 50px;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.1);
        margin-bottom: 30px;
        border: 2px solid #f8f9fa;
        transition: all 0.3s ease;
        font-size: 1.1rem;
        line-height: 1.8;
    }
    
    .exercise-content:hover {
        box-shadow: 0 12px 35px rgba(220, 53, 69, 0.15);
        transform: translateY(-2px);
    }
    
    .exercise-question {
        background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        padding: 30px;
        border-radius: 15px;
        border-left: 5px solid #dc3545;
        margin: 30px 0;
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.1);
    }
    
    .exercise-question h4 {
        color: #dc3545;
        font-size: 1.6rem;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        font-family: 'Arial', 'Helvetica', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .question-content {
        font-size: 1.3rem;
        line-height: 1.8;
        color: #2c3e50;
        font-weight: 600;
        font-family: 'Georgia', 'Times New Roman', serif;
        text-align: justify;
        letter-spacing: 0.5px;
    }
    
    .exercise-description {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 25px;
        border-radius: 15px;
        border-left: 5px solid #6c757d;
        margin-bottom: 30px;
    }
    
    .exercise-description h4 {
        color: #495057;
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 15px;
    }
    
    /* Mise en √©vidence des mots importants dans la question */
    .question-content strong,
    .question-content b {
        color: #dc3545;
        font-weight: 700;
        background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        padding: 2px 6px;
        border-radius: 4px;
        border-left: 3px solid #dc3545;
    }
    
    .question-content em,
    .question-content i {
        color: #6c757d;
        font-style: italic;
        font-weight: 600;
    }
    
    /* Style pour les listes dans la question */
    .question-content ul,
    .question-content ol {
        margin: 15px 0;
        padding-left: 25px;
    }
    
    .question-content li {
        margin: 8px 0;
        line-height: 1.6;
    }
    
    .answer-section {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 50px;
        border-radius: 20px;
        border: 3px solid #dc3545;
        box-shadow: 0 15px 40px rgba(220, 53, 69, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        margin-top: 40px;
        width: 100%;
    }
    
    .answer-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #dc3545 0%, #c82333 50%, #dc3545 100%);
        animation: shimmer 2s ease-in-out infinite;
    }
    
    @keyframes shimmer {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .answer-section:hover {
        box-shadow: 0 15px 40px rgba(220, 53, 69, 0.2);
        transform: translateY(-2px);
        border-color: #c82333;
    }
    
    .answer-section h4 {
        color: #dc3545;
        font-weight: 700;
        font-size: 1.6rem;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-align: center;
        justify-content: center;
    }
    
    .answer-section h4::before {
        content: '‚úçÔ∏è';
        font-size: 1.2em;
    }
    
    .form-control {
        border: 3px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        font-size: 1.2rem;
        line-height: 1.8;
        transition: all 0.3s ease;
        background: #ffffff;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        resize: vertical;
        min-height: 350px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        width: 100%;
    }
    
    .form-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25), inset 0 2px 10px rgba(0,0,0,0.05);
        background: #ffffff;
    }
    
    .form-control::placeholder {
        color: #6c757d;
        font-style: italic;
        opacity: 0.8;
    }
    
    .answer-actions {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 15px;
        margin-top: 20px;
        border: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .answer-actions .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
    }
    
    .answer-actions .form-check-input {
        width: 18px;
        height: 18px;
        border: 2px solid #dc3545;
        border-radius: 4px;
    }
    
    .answer-actions .form-check-input:checked {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    
    .answer-actions .form-check-label {
        color: #495057;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
    }
    
    .character-count {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .character-count.warning {
        color: #ffc107;
    }
    
    .character-count.danger {
        color: #dc3545;
    }
    
    .btn-outline-secondary {
        border: 2px solid #6c757d;
        color: #6c757d;
        border-radius: 25px;
        padding: 8px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-secondary:hover {
        background: #6c757d;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
    }
    
    .hints-content {
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    .hints-content p {
        margin-bottom: 8px;
    }
    
    .hints-content strong {
        color: #495057;
    }
    
    /* Animation pour le focus */
    .form-control:focus {
        animation: focusPulse 0.3s ease-in-out;
    }
    
    @keyframes focusPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    /* Styles pour les raccourcis clavier */
    .keyboard-shortcuts {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.8rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1000;
    }
    
    .keyboard-shortcuts.show {
        opacity: 1;
    }
    
    .keyboard-shortcuts kbd {
        background: #333;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.7rem;
        margin: 0 2px;
    }
    
    /* Am√©liorations suppl√©mentaires */
    .exercise-progress {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .progress-bar-custom {
        height: 8px;
        border-radius: 10px;
        background: #e9ecef;
        overflow: hidden;
        position: relative;
    }
    
    .progress-bar-custom .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
        border-radius: 10px;
        transition: width 0.5s ease;
        position: relative;
    }
    
    .progress-bar-custom .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: progressShine 2s ease-in-out infinite;
    }
    
    @keyframes progressShine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .exercise-timer {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 15px;
        border-radius: 10px;
        border: 2px solid #dc3545;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1);
    }
    
    .timer-display {
        font-size: 1.5rem;
        font-weight: 700;
        color: #dc3545;
        margin-bottom: 5px;
    }
    
    .timer-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .exercise-hints {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffc107;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.1);
    }
    
    .hints-title {
        color: #856404;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .hints-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .hints-list li {
        padding: 8px 0;
        border-bottom: 1px solid rgba(133, 100, 4, 0.2);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .hints-list li:last-child {
        border-bottom: none;
    }
    
    .hints-list li::before {
        content: 'üí°';
        font-size: 1.1em;
    }
    
    .exercise-metadata {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 1px solid #2196f3;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.1);
    }
    
    .metadata-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .metadata-item {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        border: 1px solid rgba(33, 150, 243, 0.2);
    }
    
    .metadata-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 5px;
    }
    
    .metadata-label {
        font-size: 0.8rem;
        color: #1565c0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .floating-actions {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .floating-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .floating-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .floating-btn.primary {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }
    
    .floating-btn.secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }
    
    .floating-btn.info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }
    
    .word-count {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 1px solid #28a745;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        text-align: center;
    }
    
    .word-count-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #155724;
        margin-bottom: 5px;
    }
    
    .word-count-label {
        font-size: 0.9rem;
        color: #155724;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .typing-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .typing-indicator.show {
        opacity: 1;
    }
    
    .typing-indicator::before {
        content: '‚úçÔ∏è';
        margin-right: 5px;
    }
    
    .answer-section {
        position: relative;
    }
    
    .answer-section .typing-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
    }
    
    .submit-btn {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        padding: 15px 35px;
        border-radius: 30px;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    .submit-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(220, 53, 69, 0.4);
    }
    
    .submit-btn:hover::before {
        left: 100%;
    }
    
    .submit-btn:active {
        transform: translateY(-1px);
    }
    
    .loading-spinner {
        display: none;
    }
    
    .correction-result {
        margin-top: 30px;
        padding: 35px;
        border-radius: 20px;
        display: none;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .correction-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #28a745;
        color: #155724;
    }
    
    .correction-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-color: #ffc107;
        color: #856404;
    }
    
    .correction-error {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border-color: #dc3545;
        color: #721c24;
    }
    
    .score-display {
        background: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.1);
        border: 2px solid #f8f9fa;
    }
    
    .score-value {
        font-size: 3rem;
        font-weight: 700;
        color: #dc3545;
        margin-bottom: 10px;
    }
    
    .score-label {
        font-size: 1.2rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .suggestions-list {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    /* Styles pour la zone de r√©ponse d√©sactiv√©e */
    .answer-section.disabled {
        opacity: 0.7;
        pointer-events: none;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .form-control.disabled {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #6c757d;
        cursor: not-allowed;
    }
    
    .submit-btn.disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    /* Style pour la bonne r√©ponse */
    .correct-answer-section {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        padding: 30px;
        border-radius: 15px;
        border: 2px solid #28a745;
        margin-top: 20px;
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.2);
    }
    
    .correct-answer-section h5 {
        color: #155724;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .correct-answer-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #28a745;
        font-size: 1.1rem;
        line-height: 1.6;
        color: #333;
    }
    
    /* Style pour le temps √©coul√© */
    .time-expired-warning {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #dc3545;
        margin-bottom: 20px;
        text-align: center;
        color: #721c24;
        font-weight: 600;
    }
    
    .suggestion-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="exercise-container">
    <!-- En-t√™te de l'exercice -->
    <div class="exercise-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-brain me-2"></i>
                    {{ exercise.title }}
                </h1>
                <div class="exercise-meta">
                    <span class="badge bg-light text-dark me-2">
                        <i class="fas fa-tag me-1"></i>{{ exercise.category.name }}
                    </span>
                    <span class="badge bg-light text-dark me-2">
                        <i class="fas fa-chart-line me-1"></i>{{ exercise.difficulty.name }}
                    </span>
                    <span class="badge bg-light text-dark me-2">
                        <i class="fas fa-puzzle-piece me-1"></i>{{ exercise.exercise_type.name }}
                    </span>
                    {% if exercise.is_ai_generated %}
                    <span class="badge bg-primary">
                        <i class="fas fa-robot me-1"></i>G√©n√©r√© par IA
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="exercise-stats">
                    <div class="stat-item">
                        <i class="fas fa-clock me-1"></i>
                        <span id="timeSpent">00:00</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-star me-1"></i>
                        {{ exercise.points }} points
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenu de l'exercice -->
    <div class="exercise-content">
        <div class="exercise-description mb-4">
            <h4><i class="fas fa-info-circle me-2"></i>Description</h4>
            <p>{{ exercise.description|safe }}</p>
        </div>
        
        <div class="exercise-question">
            <h4><i class="fas fa-question-circle me-2"></i>Question</h4>
            <div class="question-content">
                {{ exercise.content|safe }}
            </div>
        </div>
    </div>
    
    <!-- M√©tadonn√©es de l'exercice -->
    <div class="exercise-metadata">
        <h5 class="mb-3">
            <i class="fas fa-info-circle me-2"></i>
            Informations de l'exercice
        </h5>
        <div class="metadata-grid">
            <div class="metadata-item">
                <div class="metadata-value" id="difficultyLevel">{{ exercise.difficulty.name }}</div>
                <div class="metadata-label">Difficult√©</div>
            </div>
            <div class="metadata-item">
                <div class="metadata-value" id="exerciseType">{{ exercise.exercise_type.name }}</div>
                <div class="metadata-label">Type</div>
            </div>
            <div class="metadata-item">
                <div class="metadata-value" id="estimatedTime">{{ exercise.estimated_time }} min</div>
                <div class="metadata-label">Dur√©e estim√©e</div>
            </div>
            <div class="metadata-item">
                <div class="metadata-value" id="exercisePoints">{{ exercise.points }} pts</div>
                <div class="metadata-label">Points</div>
            </div>
        </div>
    </div>
    
    <!-- Progr√®s de l'exercice -->
    <div class="exercise-progress">
        <h6 class="mb-3">
            <i class="fas fa-chart-line me-2"></i>
            Progr√®s de l'exercice
        </h6>
        <div class="progress-bar-custom">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="mt-2 text-center">
            <small class="text-muted" id="progressText">Commencez √† r√©diger votre r√©ponse...</small>
        </div>
    </div>
    
    <!-- Indices de l'exercice -->
    {% if exercise.hints %}
    <div class="exercise-hints">
        <h6 class="hints-title">
            <i class="fas fa-lightbulb me-2"></i>
            Indices pour cet exercice
        </h6>
        <ul class="hints-list">
            {% for hint in exercise.hints %}
            <li>{{ hint }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <!-- Section de r√©ponse -->
    <div class="answer-section">
        <h4>Votre r√©ponse</h4>
        <form id="exerciseForm">
            {% csrf_token %}
            <div class="mb-3">
                <label for="userAnswer" class="form-label visually-hidden">Votre r√©ponse</label>
                <textarea 
                    class="form-control" 
                    id="userAnswer" 
                    name="user_answer" 
                    rows="10" 
                    placeholder="üí° Commencez √† r√©diger votre r√©ponse ici... Soyez pr√©cis et d√©taill√© pour obtenir la meilleure correction de l'IA."
                    required
                    maxlength="5000"
                ></textarea>
                <div class="character-count mt-2" id="characterCount">
                    <i class="fas fa-keyboard me-1"></i>
                    <span id="charCount">0</span> / 5000 caract√®res
                </div>
            </div>
            
            <div class="answer-actions">
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="saveProgress" checked>
                        <label class="form-check-label" for="saveProgress">
                            <i class="fas fa-save me-1"></i>
                            Sauvegarder automatiquement
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showHints">
                        <label class="form-check-label" for="showHints">
                            <i class="fas fa-lightbulb me-1"></i>
                            Afficher les indices
                        </label>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-3">
                    <button type="button" class="btn btn-outline-secondary" id="clearAnswer">
                        <i class="fas fa-eraser me-1"></i>
                        Effacer
                    </button>
                    
                    <button type="submit" class="btn submit-btn" id="submitBtn">
                        <i class="fas fa-paper-plane me-2"></i>
                        Soumettre la r√©ponse
                    </button>
                    
                    <button type="button" class="btn btn-warning" id="advancedCorrectionBtn">
                        <i class="fas fa-graduation-cap me-2"></i>
                        Correction Avanc√©e
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Spinner de chargement -->
        <div class="loading-spinner text-center mt-3" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Correction en cours...</span>
            </div>
            <p class="mt-2 text-muted">L'IA corrige votre r√©ponse...</p>
        </div>
        
        <!-- Indicateur de frappe -->
        <div class="typing-indicator" id="typingIndicator">
            En cours de frappe...
        </div>
        
        <!-- Compteur de mots -->
        <div class="word-count" id="wordCount" style="display: none;">
            <div class="word-count-value" id="wordCountValue">0</div>
            <div class="word-count-label">Mots</div>
        </div>
    </div>
    
    <!-- R√©sultat de la correction -->
    <div class="correction-result" id="correctionResult">
        <div class="row">
            <div class="col-md-8">
                <h4><i class="fas fa-clipboard-check me-2"></i>R√©sultat de la correction</h4>
                <div class="feedback-content" id="feedbackContent">
                    <!-- Le feedback sera ins√©r√© ici -->
                </div>
            </div>
            <div class="col-md-4">
                <div class="score-display" id="scoreDisplay">
                    <!-- Le score sera affich√© ici -->
                </div>
                <div class="text-center">
                    <a href="{% url 'exercises:exercise-dashboard' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Retour aux exercices
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Section pour afficher la bonne r√©ponse si l'utilisateur s'est tromp√© -->
        <div class="correct-answer-section" id="correctAnswerSection" style="display: none;">
            <h5><i class="fas fa-check-circle me-2"></i>R√©ponse correcte</h5>
            <div class="correct-answer-content" id="correctAnswerContent">
                <!-- La bonne r√©ponse sera affich√©e ici -->
            </div>
        </div>
    </div>
    
    <!-- Raccourcis clavier -->
    <div class="keyboard-shortcuts" id="keyboardShortcuts">
        <div class="mb-1"><kbd>Ctrl</kbd> + <kbd>Enter</kbd> : Soumettre</div>
        <div class="mb-1"><kbd>Tab</kbd> : Indentation</div>
        <div><kbd>F1</kbd> : Afficher/masquer les raccourcis</div>
    </div>
    
    <!-- Boutons flottants -->
    <div class="floating-actions">
        <button class="floating-btn primary" id="scrollToTop" title="Retour en haut">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button class="floating-btn secondary" id="toggleWordCount" title="Afficher/masquer le compteur de mots">
            <i class="fas fa-calculator"></i>
        </button>
        <button class="floating-btn info" id="showHelp" title="Aide et raccourcis">
            <i class="fas fa-question"></i>
        </button>
    </div>
</div>

<script>
// Variables globales
let startTime = Date.now();
let timeInterval;

// D√©marrer le chronom√®tre
function startTimer() {
    timeInterval = setInterval(() => {
        updateTimer();
        // V√©rifier le temps √©coul√© toutes les 30 secondes
        if (Math.floor((Date.now() - startTime) / 1000) % 30 === 0) {
            checkTimeExpired();
        }
    }, 1000);
}

// Mettre √† jour le chronom√®tre
function updateTimer() {
    const elapsed = Date.now() - startTime;
    const minutes = Math.floor(elapsed / 60000);
    const seconds = Math.floor((elapsed % 60000) / 1000);
    document.getElementById('timeSpent').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Arr√™ter le chronom√®tre
function stopTimer() {
    if (timeInterval) {
        clearInterval(timeInterval);
    }
}

// Soumettre l'exercice
document.getElementById('exerciseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // V√©rifier si le temps est √©coul√©
    if (checkTimeExpired()) {
        return;
    }
    
    const userAnswer = document.getElementById('userAnswer').value.trim();
    if (!userAnswer) {
        alert('Veuillez saisir votre r√©ponse');
        return;
    }
    
    // Afficher le spinner
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Correction en cours...';
    
    try {
        const response = await fetch(`/exercises/api/exercises/{{ exercise.id }}/submit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                user_answer: userAnswer
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayCorrectionResult(result);
        } else {
            showError('Erreur lors de la correction: ' + (result.error || 'Erreur inconnue'));
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur de connexion. Veuillez r√©essayer.');
    } finally {
        // Masquer le spinner
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-check me-2"></i>Soumettre la r√©ponse';
    }
});

// Afficher le r√©sultat de la correction
function displayCorrectionResult(result) {
    // D√©sactiver la zone de r√©ponse apr√®s soumission
    disableAnswerArea();
    
    const correctionDiv = document.getElementById('correctionResult');
    const feedbackDiv = document.getElementById('feedbackContent');
    const scoreDiv = document.getElementById('scoreDisplay');
    const suggestionsDiv = document.getElementById('suggestionsList');
    const suggestionsSection = document.getElementById('suggestionsSection');
    
    // Arr√™ter le chronom√®tre
    stopTimer();
    
    // D√©terminer la classe CSS selon le score
    let resultClass = 'correction-error';
    if (result.score >= 80) {
        resultClass = 'correction-success';
    } else if (result.score >= 50) {
        resultClass = 'correction-warning';
    }
    
    correctionDiv.className = `correction-result ${resultClass}`;
    
    // Afficher le score
    scoreDiv.innerHTML = `
        <div class="score-value">${Math.round(result.score)}/100</div>
        <div class="score-label">${result.is_correct ? 'Correct !' : '√Ä am√©liorer'}</div>
    `;
    
    // Afficher le feedback
    feedbackDiv.innerHTML = `
        <div class="feedback-text">
            <strong>Feedback de l'IA :</strong><br>
            ${result.feedback}
        </div>
        <div class="confidence-score mt-2">
            <small class="text-muted">
                <i class="fas fa-chart-line me-1"></i>
                Confiance: ${Math.round(result.confidence_score * 100)}%
            </small>
        </div>
    `;
    
    // Afficher la bonne r√©ponse si l'utilisateur s'est tromp√©
    if (!result.is_correct && result.score < 50) {
        showCorrectAnswer();
    }
    
    // Afficher le r√©sultat
    correctionDiv.style.display = 'block';
    correctionDiv.scrollIntoView({ behavior: 'smooth' });
}

// D√©sactiver la zone de r√©ponse
function disableAnswerArea() {
    const answerSection = document.querySelector('.answer-section');
    const textarea = document.getElementById('userAnswer');
    const submitBtn = document.getElementById('submitBtn');
    
    // Ajouter la classe disabled
    answerSection.classList.add('disabled');
    textarea.classList.add('disabled');
    submitBtn.classList.add('disabled');
    
    // D√©sactiver les √©l√©ments
    textarea.disabled = true;
    submitBtn.disabled = true;
    
    // Changer le texte du bouton
    submitBtn.innerHTML = '<i class="fas fa-lock me-2"></i>R√©ponse soumise';
}

// Afficher la bonne r√©ponse
function showCorrectAnswer() {
    const correctAnswerSection = document.getElementById('correctAnswerSection');
    const correctAnswerContent = document.getElementById('correctAnswerContent');
    
    // R√©cup√©rer la solution de l'exercice depuis les donn√©es Django
    const exerciseSolution = `{{ exercise.solution|safe }}`;
    
    if (exerciseSolution && exerciseSolution.trim() !== '') {
        correctAnswerContent.innerHTML = exerciseSolution;
        correctAnswerSection.style.display = 'block';
    }
}

// V√©rifier si le temps est √©coul√©
function checkTimeExpired() {
    const estimatedTime = {{ exercise.estimated_time }}; // en minutes
    const timeSpent = (Date.now() - startTime) / 1000 / 60; // en minutes
    
    if (timeSpent >= estimatedTime) {
        showTimeExpiredWarning();
        disableAnswerArea();
        return true;
    }
    return false;
}

// Afficher l'avertissement de temps √©coul√©
function showTimeExpiredWarning() {
    const warningDiv = document.createElement('div');
    warningDiv.className = 'time-expired-warning';
    warningDiv.innerHTML = `
        <i class="fas fa-clock me-2"></i>
        Temps √©coul√© ! Le temps estim√© pour cet exercice est d√©pass√©.
    `;
    
    const answerSection = document.querySelector('.answer-section');
    answerSection.parentNode.insertBefore(warningDiv, answerSection);
}

// Afficher une erreur
function showError(message) {
    const correctionDiv = document.getElementById('correctionResult');
    const feedbackDiv = document.getElementById('feedbackContent');
    
    correctionDiv.className = 'correction-result correction-error';
    feedbackDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
    
    correctionDiv.style.display = 'block';
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    startTimer();
    initializeAnswerArea();
    loadProgress();
    initializeFloatingActions();
    initializeProgressTracking();
    initializeTypingIndicator();
});

// Initialiser la zone de r√©ponse
function initializeAnswerArea() {
    const textarea = document.getElementById('userAnswer');
    const charCount = document.getElementById('charCount');
    const characterCount = document.getElementById('characterCount');
    const saveCheckbox = document.getElementById('saveProgress');
    const clearBtn = document.getElementById('clearAnswer');
    const showHintsCheckbox = document.getElementById('showHints');
    
    // Compteur de caract√®res
    textarea.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;
        
        // Changer la couleur selon le nombre de caract√®res
        characterCount.className = 'character-count mt-2';
        if (count > 4000) {
            characterCount.classList.add('danger');
        } else if (count > 3000) {
            characterCount.classList.add('warning');
        }
        
        // Sauvegarder automatiquement si activ√©
        if (saveCheckbox.checked) {
            debounce(saveProgress, 1000)();
        }
    });
    
    // Bouton effacer
    clearBtn.addEventListener('click', function() {
        if (confirm('√ätes-vous s√ªr de vouloir effacer votre r√©ponse ?')) {
            textarea.value = '';
            charCount.textContent = '0';
            characterCount.className = 'character-count mt-2';
            textarea.focus();
        }
    });
    
    // Afficher les indices
    showHintsCheckbox.addEventListener('change', function() {
        if (this.checked) {
            showHints();
        } else {
            hideHints();
        }
    });
    
    // Auto-resize du textarea
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.max(200, this.scrollHeight) + 'px';
    });
    
    // Raccourcis clavier
    textarea.addEventListener('keydown', function(e) {
        // Ctrl+Enter pour soumettre
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('exerciseForm').dispatchEvent(new Event('submit'));
        }
        
        // Tab pour indentation
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
        }
    });
    
    // Raccourcis globaux
    document.addEventListener('keydown', function(e) {
        // F1 pour afficher/masquer les raccourcis
        if (e.key === 'F1') {
            e.preventDefault();
            toggleKeyboardShortcuts();
        }
        
        // √âchap pour masquer les raccourcis
        if (e.key === 'Escape') {
            hideKeyboardShortcuts();
        }
    });
}

// Afficher les indices
function showHints() {
    const hintsSection = document.createElement('div');
    hintsSection.id = 'hintsSection';
    hintsSection.className = 'mt-3 p-3 bg-warning bg-opacity-10 border border-warning rounded';
    hintsSection.innerHTML = `
        <h6 class="text-warning mb-2">
            <i class="fas fa-lightbulb me-2"></i>Indices pour cet exercice
        </h6>
        <div class="hints-content">
            <p class="mb-2">üí° <strong>Conseil :</strong> Lisez attentivement l'√©nonc√© et identifiez les √©l√©ments cl√©s.</p>
            <p class="mb-2">üìù <strong>Structure :</strong> Organisez votre r√©ponse de mani√®re claire et logique.</p>
            <p class="mb-0">üéØ <strong>Pr√©cision :</strong> Soyez pr√©cis dans vos explications pour obtenir un meilleur score.</p>
        </div>
    `;
    
    const answerSection = document.querySelector('.answer-section');
    answerSection.appendChild(hintsSection);
}

// Masquer les indices
function hideHints() {
    const hintsSection = document.getElementById('hintsSection');
    if (hintsSection) {
        hintsSection.remove();
    }
}

// Afficher/masquer les raccourcis clavier
function toggleKeyboardShortcuts() {
    const shortcuts = document.getElementById('keyboardShortcuts');
    if (shortcuts.classList.contains('show')) {
        hideKeyboardShortcuts();
    } else {
        showKeyboardShortcuts();
    }
}

function showKeyboardShortcuts() {
    const shortcuts = document.getElementById('keyboardShortcuts');
    shortcuts.classList.add('show');
    
    // Masquer automatiquement apr√®s 3 secondes
    setTimeout(() => {
        hideKeyboardShortcuts();
    }, 3000);
}

function hideKeyboardShortcuts() {
    const shortcuts = document.getElementById('keyboardShortcuts');
    shortcuts.classList.remove('show');
}

// Initialiser les boutons flottants
function initializeFloatingActions() {
    const scrollToTopBtn = document.getElementById('scrollToTop');
    const toggleWordCountBtn = document.getElementById('toggleWordCount');
    const showHelpBtn = document.getElementById('showHelp');
    
    // Bouton retour en haut
    scrollToTopBtn.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // Bouton compteur de mots
    toggleWordCountBtn.addEventListener('click', function() {
        const wordCount = document.getElementById('wordCount');
        if (wordCount.style.display === 'none') {
            wordCount.style.display = 'block';
            updateWordCount();
        } else {
            wordCount.style.display = 'none';
        }
    });
    
    // Bouton aide
    showHelpBtn.addEventListener('click', function() {
        showKeyboardShortcuts();
    });
}

// Initialiser le suivi du progr√®s
function initializeProgressTracking() {
    const textarea = document.getElementById('userAnswer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    textarea.addEventListener('input', function() {
        const text = this.value.trim();
        const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
        const charCount = text.length;
        
        // Calculer le progr√®s bas√© sur la longueur de la r√©ponse
        let progress = 0;
        let progressMessage = 'Commencez √† r√©diger votre r√©ponse...';
        
        if (charCount > 0) {
            progress = Math.min((charCount / 1000) * 100, 100);
            if (progress < 25) {
                progressMessage = 'Continuez √† d√©velopper votre r√©ponse...';
            } else if (progress < 50) {
                progressMessage = 'Bonne progression ! Ajoutez plus de d√©tails...';
            } else if (progress < 75) {
                progressMessage = 'Excellente r√©ponse ! Finalisez vos id√©es...';
            } else {
                progressMessage = 'R√©ponse compl√®te ! Pr√™t pour la soumission.';
            }
        }
        
        progressFill.style.width = progress + '%';
        progressText.textContent = progressMessage;
        
        // Mettre √† jour le compteur de mots si affich√©
        updateWordCount();
    });
}

// Initialiser l'indicateur de frappe
function initializeTypingIndicator() {
    const textarea = document.getElementById('userAnswer');
    const typingIndicator = document.getElementById('typingIndicator');
    let typingTimeout;
    
    textarea.addEventListener('input', function() {
        // Afficher l'indicateur
        typingIndicator.classList.add('show');
        
        // Masquer apr√®s 1 seconde d'inactivit√©
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            typingIndicator.classList.remove('show');
        }, 1000);
    });
}

// Mettre √† jour le compteur de mots
function updateWordCount() {
    const textarea = document.getElementById('userAnswer');
    const wordCountValue = document.getElementById('wordCountValue');
    const text = textarea.value.trim();
    const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
    
    wordCountValue.textContent = wordCount;
}

// Fonction pour afficher/masquer les raccourcis
function showKeyboardShortcuts() {
    const shortcuts = document.getElementById('keyboardShortcuts');
    shortcuts.classList.add('show');
    
    // Masquer automatiquement apr√®s 5 secondes
    setTimeout(() => {
        hideKeyboardShortcuts();
    }, 5000);
}

// Sauvegarder le progr√®s
function saveProgress() {
    const userAnswer = document.getElementById('userAnswer').value;
    if (userAnswer.trim()) {
        localStorage.setItem('exercise_progress_{{ exercise.id }}', userAnswer);
    }
}

// Charger le progr√®s sauvegard√©
function loadProgress() {
    const saved = localStorage.getItem('exercise_progress_{{ exercise.id }}');
    if (saved) {
        document.getElementById('userAnswer').value = saved;
    }
}

// Fonction debounce
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Charger le progr√®s au d√©marrage
document.addEventListener('DOMContentLoaded', loadProgress);
</script>

<!-- Modal pour la correction avanc√©e -->
<div class="modal fade" id="advancedCorrectionModal" tabindex="-1" aria-labelledby="advancedCorrectionModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="advancedCorrectionModalLabel">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Correction Avanc√©e
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- S√©lecteur de niveau -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="userLevel" class="form-label">Votre niveau :</label>
                        <select class="form-select" id="userLevel">
                            <option value="beginner">D√©butant</option>
                            <option value="intermediate" selected>Interm√©diaire</option>
                            <option value="advanced">Avanc√©</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Type de correction :</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="detailedCorrection" checked>
                            <label class="form-check-label" for="detailedCorrection">
                                Correction d√©taill√©e ligne par ligne
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="videoExplanation" checked>
                            <label class="form-check-label" for="videoExplanation">
                                Explication vid√©o
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="comparisonAnswers" checked>
                            <label class="form-check-label" for="comparisonAnswers">
                                Comparaison avec d'autres r√©ponses
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Zone de r√©sultats -->
                <div id="advancedCorrectionResults" style="display: none;">
                    <!-- Score et feedback g√©n√©ral -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>R√©sultats de la Correction</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    <div class="score-circle mx-auto mb-3" id="scoreCircle">
                                        <span class="score-text" id="scoreText">0</span>
                                    </div>
                                    <h6>Score Global</h6>
                                </div>
                                <div class="col-md-9">
                                    <div class="feedback-section">
                                        <h6><i class="fas fa-comment-dots me-2"></i>Feedback Personnalis√©</h6>
                                        <p id="personalizedFeedback" class="feedback-text"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Points forts et domaines d'am√©lioration -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-thumbs-up me-2"></i>Points Forts</h6>
                                </div>
                                <div class="card-body">
                                    <ul id="strengthsList" class="list-unstyled"></ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-target me-2"></i>Domaines d'Am√©lioration</h6>
                                </div>
                                <div class="card-body">
                                    <ul id="improvementAreasList" class="list-unstyled"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Correction d√©taill√©e -->
                    <div class="card mb-4" id="detailedCorrectionCard">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-list-ul me-2"></i>Correction D√©taill√©e</h6>
                        </div>
                        <div class="card-body">
                            <div id="detailedCorrectionContent"></div>
                        </div>
                    </div>
                    
                    <!-- Comparaison avec d'autres r√©ponses -->
                    <div class="card mb-4" id="comparisonCard">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Comparaison avec d'Autres R√©ponses</h6>
                        </div>
                        <div class="card-body">
                            <div id="comparisonContent"></div>
                        </div>
                    </div>
                    
                    <!-- Explication vid√©o -->
                    <div class="card mb-4" id="videoCard">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="fas fa-play-circle me-2"></i>Explication Vid√©o</h6>
                        </div>
                        <div class="card-body">
                            <div id="videoContent">
                                <p class="text-muted">Une explication vid√©o sera bient√¥t disponible pour cet exercice.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Message de chargement -->
                <div id="advancedCorrectionLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-3 text-muted">G√©n√©ration de la correction avanc√©e en cours...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-warning" id="generateAdvancedCorrection">
                    <i class="fas fa-magic me-2"></i>
                    G√©n√©rer la Correction Avanc√©e
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Styles pour la correction avanc√©e -->
<style>
.score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #28a745, #20c997);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.feedback-text {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #495057;
}

.strength-item, .improvement-item {
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.strength-item {
    background-color: #d4edda;
    border-left-color: #28a745;
}

.improvement-item {
    background-color: #fff3cd;
    border-left-color: #ffc107;
}

.detailed-line {
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.detailed-line.correct {
    background-color: #d4edda;
    border-left-color: #28a745;
}

.detailed-line.incorrect {
    background-color: #f8d7da;
    border-left-color: #dc3545;
}

.detailed-line.partial {
    background-color: #fff3cd;
    border-left-color: #ffc107;
}

.comparison-answer {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}

.comparison-answer .level-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.level-badge.beginner {
    background-color: #17a2b8;
    color: white;
}

.level-badge.intermediate {
    background-color: #6f42c1;
    color: white;
}

.level-badge.advanced {
    background-color: #dc3545;
    color: white;
}
</style>

<script>
// Gestion de la correction avanc√©e
document.addEventListener('DOMContentLoaded', function() {
    const advancedCorrectionBtn = document.getElementById('advancedCorrectionBtn');
    const generateAdvancedCorrectionBtn = document.getElementById('generateAdvancedCorrection');
    const advancedCorrectionModal = new bootstrap.Modal(document.getElementById('advancedCorrectionModal'));
    
    // Ouvrir le modal de correction avanc√©e
    advancedCorrectionBtn.addEventListener('click', function() {
        advancedCorrectionModal.show();
    });
    
    // G√©n√©rer la correction avanc√©e
    if (generateAdvancedCorrectionBtn) {
        console.log('Bouton generateAdvancedCorrection trouve, ajout de l\'evenement');
        generateAdvancedCorrectionBtn.addEventListener('click', function() {
            console.log('Clic sur le bouton generateAdvancedCorrection');
            generateAdvancedCorrection();
        });
    } else {
        console.error('Bouton generateAdvancedCorrection non trouve!');
    }
});

// Fonction pour obtenir les cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function generateAdvancedCorrection() {
    console.log('=== D√âBUT CORRECTION AVANC√âE ===');
    
    const userAnswer = document.getElementById('userAnswer').value;
    const userLevel = document.getElementById('userLevel').value;
    
    console.log('R√©ponse utilisateur:', userAnswer);
    console.log('Niveau utilisateur:', userLevel);
    
    if (!userAnswer.trim()) {
        alert('Veuillez d\'abord saisir votre r√©ponse.');
        return;
    }
    
    // Afficher le loading
    document.getElementById('advancedCorrectionLoading').style.display = 'block';
    document.getElementById('advancedCorrectionResults').style.display = 'none';
    
    try {
        const exerciseId = {{ exercise.id }};
        const url = `/exercises/api/exercises/${exerciseId}/advanced_correction/`;
        console.log('URL de l\'API:', url);
        
        const csrfToken = getCookie('csrftoken');
        console.log('CSRF Token:', csrfToken);
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                user_answer: userAnswer,
                user_level: userLevel
            })
        });
        
        console.log('R√©ponse re√ßue:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erreur HTTP:', errorText);
            throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Donn√©es re√ßues:', data);
        
        if (data.success) {
            displayAdvancedCorrection(data.advanced_correction);
        } else {
            throw new Error(data.error || 'Erreur lors de la correction avanc√©e');
        }
    } catch (error) {
        console.error('Erreur compl√®te:', error);
        alert('Erreur lors de la g√©n√©ration de la correction avanc√©e: ' + error.message);
    } finally {
        document.getElementById('advancedCorrectionLoading').style.display = 'none';
        console.log('=== FIN CORRECTION AVANC√âE ===');
    }
}

function displayAdvancedCorrection(correction) {
    // Afficher les r√©sultats
    document.getElementById('advancedCorrectionResults').style.display = 'block';
    
    // Score global
    const score = correction.detailed_correction.overall_score || 0;
    document.getElementById('scoreText').textContent = score;
    document.getElementById('scoreCircle').style.background = score >= 70 ? 
        'linear-gradient(135deg, #28a745, #20c997)' : 
        'linear-gradient(135deg, #ffc107, #fd7e14)';
    
    // Feedback personnalis√©
    document.getElementById('personalizedFeedback').textContent = correction.personalized_feedback;
    
    // Points forts
    const strengthsList = document.getElementById('strengthsList');
    strengthsList.innerHTML = '';
    correction.strengths.forEach(strength => {
        const li = document.createElement('li');
        li.className = 'strength-item';
        li.innerHTML = `<i class="fas fa-check-circle me-2 text-success"></i>${strength}`;
        strengthsList.appendChild(li);
    });
    
    // Domaines d'am√©lioration
    const improvementList = document.getElementById('improvementAreasList');
    improvementList.innerHTML = '';
    correction.improvement_areas.forEach(area => {
        const li = document.createElement('li');
        li.className = 'improvement-item';
        li.innerHTML = `<i class="fas fa-arrow-up me-2 text-warning"></i>${area}`;
        improvementList.appendChild(li);
    });
    
    // Correction d√©taill√©e
    if (document.getElementById('detailedCorrection').checked) {
        displayDetailedCorrection(correction.detailed_correction);
    }
    
    // Comparaison avec d'autres r√©ponses
    if (document.getElementById('comparisonAnswers').checked) {
        displayComparisonAnswers(correction.comparison_answers);
    }
    
    // Explication vid√©o
    if (document.getElementById('videoExplanation').checked) {
        displayVideoExplanation(correction.video_explanation_url);
    }
}

function displayDetailedCorrection(detailedCorrection) {
    const content = document.getElementById('detailedCorrectionContent');
    content.innerHTML = '';
    
    if (detailedCorrection.line_by_line) {
        detailedCorrection.line_by_line.forEach(line => {
            const div = document.createElement('div');
            div.className = `detailed-line ${line.status}`;
            div.innerHTML = `
                <strong>Ligne:</strong> ${line.line}<br>
                <strong>Statut:</strong> ${line.status}<br>
                <strong>Commentaire:</strong> ${line.comment}
            `;
            content.appendChild(div);
        });
    }
    
    if (detailedCorrection.correct_elements) {
        const correctDiv = document.createElement('div');
        correctDiv.className = 'mt-3';
        correctDiv.innerHTML = `
            <h6 class="text-success"><i class="fas fa-check me-2"></i>√âl√©ments Corrects</h6>
            <ul class="list-unstyled">
                ${detailedCorrection.correct_elements.map(el => `<li><i class="fas fa-check text-success me-2"></i>${el}</li>`).join('')}
            </ul>
        `;
        content.appendChild(correctDiv);
    }
    
    if (detailedCorrection.incorrect_elements) {
        const incorrectDiv = document.createElement('div');
        incorrectDiv.className = 'mt-3';
        incorrectDiv.innerHTML = `
            <h6 class="text-danger"><i class="fas fa-times me-2"></i>√âl√©ments Incorrects</h6>
            <ul class="list-unstyled">
                ${detailedCorrection.incorrect_elements.map(el => `<li><i class="fas fa-times text-danger me-2"></i>${el}</li>`).join('')}
            </ul>
        `;
        content.appendChild(incorrectDiv);
    }
}

function displayComparisonAnswers(comparisonAnswers) {
    const content = document.getElementById('comparisonContent');
    content.innerHTML = '';
    
    comparisonAnswers.forEach(answer => {
        const div = document.createElement('div');
        div.className = 'comparison-answer';
        div.innerHTML = `
            <span class="level-badge ${answer.level}">${answer.level.toUpperCase()}</span>
            <p><strong>R√©ponse:</strong> ${answer.answer}</p>
            <p><strong>Explication:</strong> ${answer.explanation}</p>
        `;
        content.appendChild(div);
    });
}

function displayVideoExplanation(videoUrl) {
    const content = document.getElementById('videoContent');
    if (videoUrl) {
        content.innerHTML = `
            <div class="text-center">
                <p class="text-muted mb-3">Explication vid√©o disponible :</p>
                <a href="${videoUrl}" target="_blank" class="btn btn-danger">
                    <i class="fas fa-play me-2"></i>Regarder la Vid√©o
                </a>
            </div>
        `;
    } else {
        content.innerHTML = '<p class="text-muted">Aucune vid√©o d\'explication disponible pour cet exercice.</p>';
    }
}
</script>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
