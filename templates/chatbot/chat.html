{% extends 'main/base.html' %}
{% load static %}

{% block title %}Chatbot √âducatif{% endblock %}

{% block body_attrs %}data-user-theme="{{ user_theme }}"{% endblock %}

{% block extra_css %}
<style>
    /* Utiliser la m√™me police que le projet */
    .chat-container, .chatbot-widget {
        font-family: 'Montserrat', sans-serif;
    }
    .chat-container {
        height: 80vh;
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px 10px 0 0;
    }
    
    .theme-toggle {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 10;
    }
    
    .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(1.1);
    }
    
    .theme-toggle i {
        font-size: 16px;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: white;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.assistant {
        justify-content: flex-start;
    }
    
    .message-content {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message.user .message-content {
        background: #dc3545;
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message.assistant .message-content {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 5px;
    }
    
    .chat-input {
        padding: 1rem;
        background: white;
        border-top: 1px solid #dee2e6;
        border-radius: 0 0 10px 10px;
    }
    
    .input-group {
        display: flex;
        gap: 0.5rem;
    }
    
    .input-group input {
        flex: 1;
        border: 1px solid #ced4da;
        border-radius: 25px;
        padding: 0.75rem 1rem;
        outline: none;
    }
    
    .input-group input:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .btn-send {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-send:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    .btn-send:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Styles pour l'assistant vocal */
    .btn-voice {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }
    
    .btn-pdf {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }
    
    .btn-voice:hover {
        background: #218838;
        transform: scale(1.05);
    }
    
    .btn-pdf:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    .btn-voice:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-voice.listening {
        background: #dc3545;
        animation: pulse 1.5s infinite;
    }
    
    .btn-voice.listening:hover {
        background: #c82333;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .voice-status {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-radius: 10px;
        margin-top: 0.5rem;
        border: 2px solid #dc3545;
    }
    
    .voice-indicator {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .voice-wave {
        width: 4px;
        height: 20px;
        background: #dc3545;
        border-radius: 2px;
        animation: voiceWave 1s ease-in-out infinite;
    }
    
    .voice-wave:nth-child(1) { animation-delay: 0s; }
    .voice-wave:nth-child(2) { animation-delay: 0.2s; }
    .voice-wave:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes voiceWave {
        0%, 100% { height: 10px; }
        50% { height: 30px; }
    }
    
    .voice-text {
        color: #dc3545;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .voice-error {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #f8d7da;
        border-radius: 5px;
        border: 1px solid #f5c6cb;
    }
    
    .voice-success {
        color: #28a745;
        font-size: 0.8rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #d4edda;
        border-radius: 5px;
        border: 1px solid #c3e6cb;
    }
    
    /* Styles pour l'upload de fichiers */
    .btn-file {
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }
    
    .btn-file:hover {
        background: #138496;
        transform: scale(1.05);
    }
    
    .btn-file:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .file-upload-area {
        margin-top: 1rem;
        border: 2px dashed #dc3545;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
    }
    
    /* Styles pour les notifications */
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 350px;
    }
    
    .notification {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        margin-bottom: 10px;
        transform: translateX(400px);
        transition: all 0.3s ease;
        border-left: 4px solid #1e7e34;
        position: relative;
        overflow: hidden;
    }
    
    .notification.show {
        transform: translateX(0);
    }
    
    .notification::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
        animation: progress 3s linear forwards;
    }
    
    @keyframes progress {
        from { width: 100%; }
        to { width: 0%; }
    }
    
    .notification-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    
    .notification-title {
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
    }
    
    .notification-title i {
        margin-right: 8px;
        font-size: 16px;
    }
    
    .notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    
    .notification-close:hover {
        opacity: 1;
    }
    
    .notification-message {
        font-size: 13px;
        opacity: 0.9;
        line-height: 1.4;
    }
    
    .notification-icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 8px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        text-align: center;
        line-height: 20px;
        font-size: 12px;
    }
    
    /* Mode sombre pour les notifications */
    [data-theme="dark"] .notification {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        border-left: 4px solid #dc3545;
    }
    
    [data-theme="dark"] .notification::before {
        background: linear-gradient(90deg, #dc3545, #fd7e14, #ffc107);
    }
    
    /* Animation de pulsation pour l'ic√¥ne */
    .notification-pulse {
        animation: pulse 1.5s infinite;
    }
    
    /* Indicateur de typing */
    .typing-indicator {
        display: none;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 20px;
        margin: 10px 0;
        font-style: italic;
        color: #6c757d;
        border-left: 4px solid #dc3545;
    }
    
    .typing-indicator.show {
        display: block;
    }
    
    .typing-dots {
        display: inline-block;
        animation: typing 1.4s infinite;
    }
    
    @keyframes typing {
        0%, 60%, 100% { opacity: 0.3; }
        30% { opacity: 1; }
    }
    
    [data-theme="dark"] .typing-indicator {
        background: #2d2d2d;
        color: #e0e0e0;
    }
        background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
        transition: all 0.3s ease;
    }
    
    .file-upload-area:hover {
        border-color: #c82333;
        background: linear-gradient(135deg, #fef2f2 0%, #fce4e6 100%);
    }
    
    .file-upload-area.dragover {
        border-color: #28a745;
        background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
        transform: scale(1.02);
    }
    
    .file-upload-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    
    .file-upload-icon {
        font-size: 3rem;
        color: #dc3545;
        animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    
    .file-upload-text h5 {
        color: #dc3545;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .file-upload-text p {
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .file-upload-text small {
        color: #6c757d;
        font-style: italic;
    }
    
    .file-upload-progress {
        width: 100%;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 1rem;
    }
    
    .file-upload-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #dc3545, #c82333);
        border-radius: 2px;
        transition: width 0.3s ease;
    }
    
    .file-upload-status {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .file-upload-status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .file-upload-status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
        .file-upload-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Styles pour l'indicateur de fichiers en attente */
        .pending-files-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #bbdefb;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #1565c0;
            animation: slideIn 0.3s ease;
        }
        
        .pending-files-indicator i {
            color: #1976d2;
        }
        
        .btn-clear-files {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }
        
        .btn-clear-files:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
        
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Styles pour la section des PDFs upload√©s */
    .uploaded-pdfs-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .uploaded-pdfs-section h4 {
        color: #495057;
        margin-bottom: 0.75rem;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .uploaded-pdf-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .uploaded-pdf-item:hover {
        background: #f8f9fa;
        border-color: #007bff;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }
    
    .pdf-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }
    
    .pdf-icon {
        color: #dc3545;
        font-size: 1.2rem;
    }
    
    .pdf-details {
        flex: 1;
    }
    
    .pdf-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.25rem;
    }
    
    .pdf-size {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .pdf-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-ask-pdf {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-ask-pdf:hover {
        background: #0056b3;
        transform: scale(1.05);
    }
    
    .btn-remove-pdf {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.4rem 0.6rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-remove-pdf:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    .typing-indicator {
        display: none;
        padding: 0.75rem 1rem;
        background: #e9ecef;
        border-radius: 18px;
        border-bottom-left-radius: 5px;
        color: #6c757d;
        font-style: italic;
    }
    
    .session-sidebar {
        width: 320px;
        background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
        border-right: 1px solid #e9ecef;
        padding: 0;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        position: relative;
    }
    
    .session-sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #dc3545, #c82333, #dc3545);
        background-size: 200% 100%;
        animation: gradientShift 3s ease-in-out infinite;
    }
    
    @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }
    
    .session-header {
        padding: 1.5rem 1.25rem 1rem;
        background: white;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(10px);
    }
    
    .session-header h5 {
        color: #2c3e50;
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .session-header h5::before {
        content: 'üí¨';
        font-size: 1.2rem;
    }
    
    /* Styles pour la barre de recherche */
    .search-container {
        padding: 1rem 1.25rem;
        background: white;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 80px;
        z-index: 9;
        backdrop-filter: blur(10px);
    }
    
    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px solid #e9ecef;
        border-radius: 25px;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .search-input-wrapper:focus-within {
        border-color: #dc3545;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
        transform: translateY(-1px);
    }
    
    .search-icon {
        color: #6c757d;
        margin-right: 0.75rem;
        font-size: 0.9rem;
        transition: color 0.3s ease;
    }
    
    .search-input-wrapper:focus-within .search-icon {
        color: #dc3545;
    }
    
    .search-input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        font-size: 0.9rem;
        color: #2c3e50;
        color: #2c3e50;
        font-family: 'Montserrat', sans-serif;
    }
    
    .search-input::placeholder {
        color: #adb5bd;
        font-style: italic;
    }
    
    .search-clear-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.7rem;
        margin-left: 0.5rem;
    }
    
    .search-clear-btn:hover {
        background: #c82333;
        transform: scale(1.1);
    }
    
    .search-stats {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: #6c757d;
        text-align: center;
        font-style: italic;
    }
    
    /* Animation pour les r√©sultats de recherche */
    .session-item.search-highlight {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-left: 4px solid #ffc107;
        animation: searchHighlight 0.5s ease-out;
    }
    
    @keyframes searchHighlight {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    .session-item.search-hidden {
        display: none;
    }
    
    /* Mode sombre pour la recherche */
    [data-theme="dark"] .search-container {
        background: #2d2d2d;
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .search-input-wrapper {
        background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    [data-theme="dark"] .search-input-wrapper:focus-within {
        border-color: #dc3545;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }
    
    [data-theme="dark"] .search-input {
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .search-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }
    
    [data-theme="dark"] .search-stats {
        color: rgba(255, 255, 255, 0.7);
    }
    
    [data-theme="dark"] .session-item.search-highlight {
        background: linear-gradient(135deg, #4a3c00 0%, #6c5c00 100%);
        border-left-color: #ffc107;
    }
    
    /* Styles pour le message "aucun r√©sultat" */
    .no-results-message {
        text-align: center;
        padding: 2rem 1rem;
        color: #6c757d;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 15px;
        margin: 1rem;
        border: 2px dashed #dee2e6;
        animation: fadeInUp 0.5s ease-out;
    }
    
    .no-results-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.7;
    }
    
    .no-results-text {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .no-results-suggestion {
        font-size: 0.9rem;
        color: #6c757d;
        font-style: italic;
    }
    
    @keyframes fadeInUp {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Mode sombre pour le message "aucun r√©sultat" */
    [data-theme="dark"] .no-results-message {
        background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
        border-color: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.8);
    }
    
    [data-theme="dark"] .no-results-text {
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .no-results-suggestion {
        color: rgba(255, 255, 255, 0.6);
    }
    
    /* Styles pour le widget de traduction Google Translate */
    .translate-widget {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
        z-index: 1000;
        max-width: 300px;
        transition: all 0.3s ease;
        animation: translateWidgetSlideIn 0.5s ease-out;
    }
    
    .translate-widget:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
    }
    
    .translate-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        color: #2c3e50;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .translate-header i {
        color: #dc3545;
        font-size: 1rem;
    }
    
    .google-translate-container {
        position: relative;
    }
    
    /* Personnalisation du widget Google Translate */
    .google-translate-container .goog-te-gadget {
        font-family: 'Montserrat', sans-serif !important;
        font-size: 0.85rem !important;
    }
    
    .google-translate-container .goog-te-gadget .goog-te-combo {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 0.85rem;
        color: #2c3e50;
        transition: all 0.3s ease;
        width: 100%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .google-translate-container .goog-te-gadget .goog-te-combo:focus {
        border-color: #dc3545;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
        outline: none;
    }
    
    .google-translate-container .goog-te-gadget .goog-te-combo:hover {
        border-color: #dc3545;
        transform: translateY(-1px);
    }
    
    /* Masquer les √©l√©ments Google Translate non d√©sir√©s */
    .google-translate-container .goog-te-banner-frame {
        display: none !important;
    }
    
    .google-translate-container .goog-te-gadget .goog-te-gadget-simple {
        background: transparent !important;
        border: none !important;
    }
    
    /* Animation d'apparition */
    @keyframes translateWidgetSlideIn {
        0% {
            opacity: 0;
            transform: translateX(-100px);
        }
        100% {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Mode sombre pour le widget de traduction */
    [data-theme="dark"] .translate-widget {
        background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .translate-header {
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .google-translate-container .goog-te-gadget .goog-te-combo {
        background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
        border-color: rgba(255, 255, 255, 0.2);
        color: #e0e0e0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .google-translate-container .goog-te-gadget .goog-te-combo:focus {
        border-color: #dc3545;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }
    
    /* Responsive design pour le widget de traduction */
    @media (max-width: 768px) {
        .translate-widget {
            bottom: 15px;
            left: 15px;
            right: 15px;
            max-width: none;
            padding: 12px;
        }
    }
    
    .new-session-btn {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        justify-content: center;
    }
    
    .new-session-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        background: linear-gradient(135deg, #c82333 0%, #b02a37 100%);
    }
    
    .new-session-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }
    
    .sessions-container {
        padding: 1rem 1.25rem;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }
    
    .sessions-container::-webkit-scrollbar {
        width: 4px;
    }
    
    .sessions-container::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .sessions-container::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 2px;
    }
    
    .sessions-container::-webkit-scrollbar-thumb:hover {
        background: #dc3545;
    }
    
    .session-item {
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: white;
        border-radius: 16px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .session-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #dc3545, #c82333);
        transform: scaleX(0);
        transition: transform 0.3s ease;
        transform-origin: left;
    }
    
    .session-item:hover {
        border-color: #dc3545;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.15);
        transform: translateY(-2px);
    }
    
    .session-item:hover::before {
        transform: scaleX(1);
    }
    
    .session-item.active {
        border-color: #dc3545;
        background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.2);
        transform: translateY(-1px);
    }
    
    .session-item.active::before {
        transform: scaleX(1);
    }
    
    .session-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .session-timestamp {
        color: #6c757d;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .session-timestamp::before {
        content: 'üïí';
        font-size: 0.7rem;
    }
    
    .subject-badge {
        display: inline-block;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 0.3rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.75rem;
        box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: #6c757d;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .empty-state-text {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    /* Animations et effets suppl√©mentaires */
    .session-item {
        animation: slideInUp 0.3s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .session-item:nth-child(1) { animation-delay: 0.1s; }
    .session-item:nth-child(2) { animation-delay: 0.2s; }
    .session-item:nth-child(3) { animation-delay: 0.3s; }
    .session-item:nth-child(4) { animation-delay: 0.4s; }
    .session-item:nth-child(5) { animation-delay: 0.5s; }
    
    /* Effet de pulsation pour le bouton nouveau */
    .new-session-btn {
        position: relative;
        overflow: hidden;
    }
    
    .new-session-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s;
    }
    
    .new-session-btn:hover::before {
        left: 100%;
    }
    
    /* Effet de focus pour l'accessibilit√© */
    .session-item:focus {
        outline: 2px solid #dc3545;
        outline-offset: 2px;
    }
    
    .new-session-btn:focus {
        outline: 2px solid #dc3545;
        outline-offset: 2px;
    }
    
    /* Responsive design pour mobile */
    @media (max-width: 768px) {
        .session-sidebar {
            width: 280px;
        }
        
        .session-header {
            padding: 1rem 1rem 0.75rem;
        }
        
        .sessions-container {
            padding: 0.75rem 1rem;
        }
        
        .session-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .session-title {
            font-size: 0.9rem;
        }
        
        .session-timestamp {
            font-size: 0.75rem;
        }
    }
    
    /* Dark mode support (optionnel) */
    @media (prefers-color-scheme: dark) {
        .session-sidebar {
            background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%);
            border-right-color: #404040;
        }
        
        .session-header {
            background: #1a1a1a;
            border-bottom-color: #404040;
        }
        
        .session-header h5 {
            color: #ffffff;
        }
        
        .session-item {
            background: #2d2d2d;
            border-color: #404040;
        }
        
        .session-title {
            color: #ffffff;
        }
        
        .session-timestamp {
            color: #a0a0a0;
        }
        
        .empty-state {
            color: #a0a0a0;
        }
    }
    
    .main-chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-layout {
        display: flex;
        height: 80vh;
    }
    
    /* Styles pour le code et markdown */
    .message-content h1, .message-content h2, .message-content h3 {
        color: #dc3545;
        margin: 1rem 0 0.5rem 0;
    }
    
    .message-content h1 { font-size: 1.5rem; }
    .message-content h2 { font-size: 1.3rem; }
    .message-content h3 { font-size: 1.1rem; }
    
    .message-content p {
        margin: 0.5rem 0;
        line-height: 1.6;
    }
    
    .message-content ul, .message-content ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }
    
    .message-content li {
        margin: 0.25rem 0;
    }
    
    .message-content blockquote {
        border-left: 4px solid #dc3545;
        padding-left: 1rem;
        margin: 1rem 0;
        background: #f8f9fa;
        padding: 0.5rem 1rem;
        border-radius: 0 5px 5px 0;
    }
    
    .message-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }
    
    .message-content th, .message-content td {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        text-align: left;
    }
    
    .message-content th {
        background: #f8f9fa;
        font-weight: bold;
    }
    
    /* Styles pour les blocs de code */
    .code-container {
        margin: 1rem 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .code-header {
        background: #2d3748;
        color: white;
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .language-label {
        font-family: 'Courier New', monospace;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .copy-btn {
        background: #4a5568;
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background 0.3s ease;
    }
    
    .copy-btn:hover {
        background: #5a6578;
    }
    
    .code-content {
        background: #f7fafc;
        overflow-x: auto;
    }
    
    .code-content pre {
        margin: 0;
        padding: 1rem;
        background: transparent;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .code-content code {
        background: transparent;
        padding: 0;
        border-radius: 0;
        font-family: 'Courier New', monospace;
    }
    
    /* Syntax highlighting styles */
    .highlight {
        background: #f7fafc;
    }
    
    .highlight .k { color: #d73a49; } /* Keywords */
    .highlight .s { color: #032f62; } /* Strings */
    .highlight .c { color: #6a737d; } /* Comments */
    .highlight .n { color: #6f42c1; } /* Names */
    .highlight .o { color: #d73a49; } /* Operators */
    .highlight .p { color: #24292e; } /* Punctuation */
    .highlight .nb { color: #005cc5; } /* Name builtin */
    .highlight .nf { color: #6f42c1; } /* Name function */
    .highlight .mi { color: #005cc5; } /* Number integer */
    .highlight .mf { color: #005cc5; } /* Number float */
    
    /* Inline code */
    .message-content code:not(.highlight code) {
        background: #f1f3f4;
        color: #d73a49;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    /* Am√©lioration de l'affichage des messages */
    .message-content {
        line-height: 1.6;
    }
    
    .message.assistant .message-content {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    
    /* Styles pour les pi√®ces jointes */
    .file-attachment {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 16px;
        margin: 8px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }
    
    .file-icon {
        font-size: 24px;
        margin-right: 12px;
        color: #ff6b6b;
    }
    
    .file-icon .fa-file-pdf {
        color: #ff6b6b;
    }
    
    .file-icon .fa-file-excel {
        color: #4caf50;
    }
    
    .file-info {
        flex: 1;
        min-width: 0;
    }
    
    .file-name {
        font-weight: 500;
        font-size: 14px;
        line-height: 1.3;
        margin-bottom: 4px;
        word-break: break-word;
    }
    
    .file-size {
        font-size: 12px;
        opacity: 0.8;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .file-status {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        font-style: italic;
    }
    
    /* Mode sombre pour le chatbot */
    [data-theme="dark"] .chat-container {
        background: #1a1a1a;
        color: #e0e0e0;
    }

    [data-theme="dark"] .chat-header {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        color: #e0e0e0;
    }

    [data-theme="dark"] .chat-messages {
        background: #1a1a1a;
        color: #e0e0e0;
    }

    [data-theme="dark"] .message-content {
        background: #2d3748;
        color: #e0e0e0;
        border: 1px solid #4a5568;
    }

    [data-theme="dark"] .message.user .message-content {
        background: #3182ce;
        color: white;
    }

    [data-theme="dark"] .message.assistant .message-content {
        background: #2d3748;
        color: #e0e0e0;
    }

    [data-theme="dark"] .chat-input-container {
        background: #2d3748;
        border-top: 1px solid #4a5568;
    }

    [data-theme="dark"] .chat-input {
        background: #1a1a1a;
        color: #e0e0e0;
        border: 1px solid #4a5568;
    }

    [data-theme="dark"] .chat-input:focus {
        border-color: #3182ce;
        box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2);
    }

    [data-theme="dark"] .chat-input::placeholder {
        color: #a0aec0;
    }

    [data-theme="dark"] .btn-primary {
        background: #3182ce;
        border-color: #3182ce;
    }

    [data-theme="dark"] .btn-primary:hover {
        background: #2c5aa0;
        border-color: #2c5aa0;
    }

    [data-theme="dark"] .btn-secondary {
        background: #4a5568;
        border-color: #4a5568;
        color: #e0e0e0;
    }

    [data-theme="dark"] .btn-secondary:hover {
        background: #2d3748;
        border-color: #2d3748;
    }

    [data-theme="dark"] .file-upload-area {
        background: #2d3748;
        border: 2px dashed #4a5568;
        color: #e0e0e0;
    }

    [data-theme="dark"] .file-upload-area:hover {
        border-color: #3182ce;
        background: #2a4365;
    }

    [data-theme="dark"] .uploaded-files {
        background: #2d3748;
        border: 1px solid #4a5568;
    }

    [data-theme="dark"] .file-item {
        background: #1a1a1a;
        border: 1px solid #4a5568;
        color: #e0e0e0;
    }

    [data-theme="dark"] .file-item:hover {
        background: #2d3748;
    }

    [data-theme="dark"] .session-item {
        background: #2d3748;
        border: 1px solid #4a5568;
        color: #e0e0e0;
    }

    [data-theme="dark"] .session-item:hover {
        background: #4a5568;
    }

    [data-theme="dark"] .session-item.active {
        background: #3182ce;
        color: white;
    }

    [data-theme="dark"] .theme-toggle {
        background: #2d3748;
        border: 1px solid #4a5568;
        color: #e0e0e0;
    }

    [data-theme="dark"] .theme-toggle:hover {
        background: #4a5568;
    }

    [data-theme="dark"] .theme-toggle.active {
        background: #3182ce;
        color: white;
    }

    /* Mode auto - suit les pr√©f√©rences syst√®me */
    @media (prefers-color-scheme: dark) {
        [data-theme="auto"] .chat-container {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .chat-header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .chat-messages {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .message-content {
            background: #2d3748;
            color: #e0e0e0;
            border: 1px solid #4a5568;
        }
        
        [data-theme="auto"] .message.user .message-content {
            background: #3182ce;
            color: white;
        }
        
        [data-theme="auto"] .message.assistant .message-content {
            background: #2d3748;
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .chat-input-container {
            background: #2d3748;
            border-top: 1px solid #4a5568;
        }
        
        [data-theme="auto"] .chat-input {
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #4a5568;
        }
        
        [data-theme="auto"] .chat-input:focus {
            border-color: #3182ce;
            box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2);
        }
        
        [data-theme="auto"] .chat-input::placeholder {
            color: #a0aec0;
        }
        
        [data-theme="auto"] .btn-primary {
            background: #3182ce;
            border-color: #3182ce;
        }
        
        [data-theme="auto"] .btn-primary:hover {
            background: #2c5aa0;
            border-color: #2c5aa0;
        }
        
        [data-theme="auto"] .btn-secondary {
            background: #4a5568;
            border-color: #4a5568;
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .btn-secondary:hover {
            background: #2d3748;
            border-color: #2d3748;
        }
        
        [data-theme="auto"] .file-upload-area {
            background: #2d3748;
            border: 2px dashed #4a5568;
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .file-upload-area:hover {
            border-color: #3182ce;
            background: #2a4365;
        }
        
        [data-theme="auto"] .uploaded-files {
            background: #2d3748;
            border: 1px solid #4a5568;
        }
        
        [data-theme="auto"] .file-item {
            background: #1a1a1a;
            border: 1px solid #4a5568;
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .file-item:hover {
            background: #2d3748;
        }
        
        [data-theme="auto"] .session-item {
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .session-item:hover {
            background: #4a5568;
        }
        
        [data-theme="auto"] .session-item.active {
            background: #3182ce;
            color: white;
        }
        
        [data-theme="auto"] .theme-toggle {
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #e0e0e0;
        }
        
        [data-theme="auto"] .theme-toggle:hover {
            background: #4a5568;
        }
        
        [data-theme="auto"] .theme-toggle.active {
            background: #3182ce;
            color: white;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="chat-layout">
                <!-- Sidebar des sessions -->
                <div class="session-sidebar">
                    <div class="session-header">
                        <h5>Conversations</h5>
                        <button class="new-session-btn" onclick="createNewSession()">
                            <i class="fas fa-plus"></i> Nouvelle conversation
                        </button>
                    </div>
                    
                    <!-- Barre de recherche dynamique -->
                    <div class="search-container">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" 
                                   class="search-input" 
                                   id="conversationSearch" 
                                   placeholder="Rechercher dans les conversations..."
                                   onkeyup="debouncedSearch(this.value)"
                                   onkeydown="handleSearchKeydown(event)"
                                   autocomplete="off">
                            <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="search-stats" id="searchStats" style="display: none;">
                            <span id="searchResultsCount">0</span> r√©sultat(s) trouv√©(s)
                        </div>
                    </div>
                    
                    <div class="sessions-container" id="sessions-list">
                        {% for session in sessions %}
                        <div class="session-item" data-session-id="{{ session.id }}" onclick="loadSession({{ session.id }})">
                            <div class="session-title">{{ session.title }}</div>
                            <div class="session-timestamp">{{ session.created_at|date:"d/m/Y H:i" }}</div>
                            {% if session.messages.last.subject %}
                                <span class="subject-badge">{{ session.messages.last.subject.name }}</span>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <div class="empty-state-text">
                                Aucune conversation pour le moment.<br>
                                Commencez une nouvelle discussion !
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Widget de traduction Google Translate -->
                    <div class="translate-widget">
                        <div class="translate-header">
                            <i class="fas fa-language"></i>
                            <span>Traduction</span>
                        </div>
                        <div id="google_translate_element" class="google-translate-container"></div>
                    </div>
                </div>
                
                <!-- Zone de chat principale -->
                <div class="main-chat-area">
    <!-- Conteneur de notifications -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <div class="chat-container">
        <div class="chat-header" style="position: relative;">
            <div>
                <h4 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    Assistant √âducatif
                </h4>
                <small>Posez vos questions sur les math√©matiques, physique, informatique, et plus encore !</small>
            </div>
            <button class="theme-toggle" title="Changer le th√®me">
                <i class="fas fa-adjust"></i>
            </button>
        </div>
                        
                        <div class="chat-messages" id="chat-messages">
                            <!-- Indicateur de typing -->
                            <div class="typing-indicator" id="typingIndicator">
                                <i class="fas fa-robot me-2"></i>
                                L'assistant √©crit
                                <span class="typing-dots">...</span>
                            </div>
                            
                            <div class="message assistant">
                                <div class="message-content">
                                    <strong>Assistant :</strong> Bonjour ! Je suis votre assistant √©ducatif. Je peux vous aider dans de nombreux domaines : math√©matiques, physique, chimie, informatique, biologie, histoire, fran√ßais, et bien d'autres ! Posez-moi vos questions et je ferai de mon mieux pour vous expliquer clairement.
                                </div>
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typing-indicator">
                            L'assistant √©crit...
                        </div>
                        
                        <div class="chat-input">
                            <div class="input-group">
                <input type="text" id="message-input" placeholder="Posez votre question sur le PDF ou √©crivez votre message..." 
                       onkeypress="handleKeyPress(event)">
                                <button class="btn-file" id="file-button" onclick="toggleFileUpload()" title="Envoyer un fichier">
                                    <i class="fas fa-paperclip"></i>
                                    <span id="file-count" style="display: none;">0</span>
                                </button>
                    <button class="btn-voice" id="voice-button" onclick="toggleVoiceInput()" title="Parler">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="btn-pdf" id="pdf-button" onclick="generatePDF()" title="G√©n√©rer un PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button class="btn-send" id="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                            </div>
                            
                            <!-- Indicateur de fichiers en attente -->
                            <div id="pending-files-indicator" style="display: none;" class="pending-files-indicator">
                                <i class="fas fa-file"></i>
                                <span id="pending-files-text">0 fichier(s) en attente</span>
                                <button onclick="clearPendingFiles()" class="btn-clear-files" title="Supprimer les fichiers">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                <!-- Zone d'affichage des PDFs upload√©s -->
                <div id="uploaded-pdfs-section" style="display: none;" class="uploaded-pdfs-section">
                    <h4><i class="fas fa-file-pdf"></i> PDFs disponibles pour analyse :</h4>
                    <div id="uploaded-pdfs-list"></div>
                </div>
                
                <!-- Zone d'upload de fichiers -->
                <div class="file-upload-area" id="file-upload-area" style="display: none;">
                                <div class="file-upload-content">
                                    <div class="file-upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        <h5>Glissez-d√©posez vos fichiers ici</h5>
                                        <p>ou cliquez pour s√©lectionner</p>
                                        <small>Formats support√©s: PDF, Excel (.xlsx, .xls)</small>
                                    </div>
                                    <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls" style="display: none;">
                                </div>
                            </div>
                            
                            <div class="voice-status" id="voice-status" style="display: none;">
                                <div class="voice-indicator">
                                    <div class="voice-wave"></div>
                                    <div class="voice-wave"></div>
                                    <div class="voice-wave"></div>
                                </div>
                                <span class="voice-text">√âcoute en cours... Parlez maintenant</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = null;
let isLoading = false;
let isListening = false;
let recognition = null;
let voiceRetryCount = 0;
let maxVoiceRetries = 2;
let voiceTimeout = null;
let audioContext = null;
let analyser = null;
let microphone = null;
let audioLevelInterval = null;
let isFileUploadVisible = false;

// Variables pour l'int√©gration message + PDF
let pendingMessage = '';
let pendingFiles = [];
let uploadedFileContents = []; // Nouveau tableau pour stocker le contenu des fichiers

// Gestion des √©v√©nements
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation de la page chatbot...');
    
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.focus();
        console.log('‚úÖ Champ de message initialis√©');
    } else {
        console.error('‚ùå Champ de message non trouv√©');
    }
    
    // Afficher les PDFs upload√©s au chargement
    displayUploadedPDFs();
    
    // Tester le support de la reconnaissance vocale
    testVoiceSupport();
    
    // Initialiser la reconnaissance vocale
    initializeVoiceRecognition();
});

// Tester le support de la reconnaissance vocale
function testVoiceSupport() {
    console.log('üß™ Test du support de la reconnaissance vocale...');
    
    const hasWebkitSpeech = 'webkitSpeechRecognition' in window;
    const hasSpeech = 'SpeechRecognition' in window;
    
    console.log('üîç Support webkitSpeechRecognition:', hasWebkitSpeech);
    console.log('üîç Support SpeechRecognition:', hasSpeech);
    
    if (hasWebkitSpeech || hasSpeech) {
        console.log('‚úÖ Reconnaissance vocale support√©e');
        
        // Tester les permissions microphone
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            console.log('üé§ API getUserMedia disponible');
        } else {
            console.warn('‚ö†Ô∏è API getUserMedia non disponible');
        }
    } else {
        console.warn('‚ùå Reconnaissance vocale non support√©e');
        showVoiceMessage('‚ùå Votre navigateur ne supporte pas la reconnaissance vocale', 'error');
    }
}

// Initialisation de la reconnaissance vocale
function initializeVoiceRecognition() {
    console.log('Initialisation de la reconnaissance vocale...');
    
    // V√©rifier le support de la reconnaissance vocale
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('Reconnaissance vocale non support√©e par ce navigateur');
        const voiceButton = document.getElementById('voice-button');
        voiceButton.disabled = true;
        voiceButton.title = 'Reconnaissance vocale non support√©e';
        voiceButton.style.opacity = '0.5';
        return;
    }
    
    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        // Configuration de la reconnaissance optimis√©e
        recognition.continuous = false;
        recognition.interimResults = true; // Activer les r√©sultats interm√©diaires
        recognition.lang = 'fr-FR';
        recognition.maxAlternatives = 5; // Plus d'alternatives pour meilleure d√©tection
        recognition.serviceURI = ''; // Utiliser le service par d√©faut
        
        // Configuration pour une meilleure sensibilit√©
        // Note: grammars n'est pas toujours support√©, on l'√©vite
        
        // √âv√©nements de la reconnaissance
        recognition.onstart = function() {
            console.log('üé§ Reconnaissance vocale d√©marr√©e');
            isListening = true;
            updateVoiceUI(true);
            
            // D√©marrer la d√©tection de niveau sonore
            startAudioLevelDetection();
        };
        
        recognition.onresult = function(event) {
            console.log('üéØ R√©sultat re√ßu:', event);
            
            let finalTranscript = '';
            let interimTranscript = '';
            
            // Traiter tous les r√©sultats
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                    console.log('üìù Texte final reconnu:', transcript);
                } else {
                    interimTranscript += transcript;
                    console.log('üîÑ Texte interm√©diaire:', transcript);
                }
            }
            
            // Mettre √† jour l'input avec le texte final ou interm√©diaire
            const messageInput = document.getElementById('message-input');
            if (finalTranscript) {
                messageInput.value = finalTranscript;
                console.log('‚úÖ Texte final reconnu:', finalTranscript);
                
                // Afficher un message de succ√®s
                showVoiceMessage('‚úÖ Texte reconnu avec succ√®s ! Envoi automatique...', 'success');
                
                // Envoyer directement le message au chatbot
                setTimeout(() => {
                    console.log('üöÄ Envoi automatique du message vocal...');
                    sendMessage();
                }, 500); // Petit d√©lai pour que l'utilisateur voie le message
                
                // Arr√™ter l'√©coute seulement si on a un r√©sultat final
                stopVoiceInput();
            } else if (interimTranscript) {
                // Afficher le texte interm√©diaire en temps r√©el
                messageInput.value = interimTranscript;
                console.log('üîÑ Texte interm√©diaire affich√©:', interimTranscript);
                
                // Afficher un message d'√©coute
                showVoiceMessage('üé§ √âcoute en cours...', 'info');
            }
        };
        
        recognition.onerror = function(event) {
            console.error('‚ùå Erreur de reconnaissance vocale:', event.error);
            let errorMessage = 'Erreur de reconnaissance vocale';
            let shouldRetry = false;
            
            switch(event.error) {
                case 'no-speech':
                    errorMessage = 'üîá Aucune parole d√©tect√©e.';
                    shouldRetry = (voiceRetryCount < maxVoiceRetries);
                    if (shouldRetry) {
                        errorMessage += ` Nouvelle tentative (${voiceRetryCount + 1}/${maxVoiceRetries})...`;
                    }
                    break;
                case 'audio-capture':
                    errorMessage = 'üé§ Microphone non disponible.';
                    break;
                case 'not-allowed':
                    errorMessage = 'üö´ Permission microphone refus√©e.';
                    break;
                case 'network':
                    errorMessage = 'üåê Erreur r√©seau.';
                    shouldRetry = (voiceRetryCount < maxVoiceRetries);
                    break;
                case 'aborted':
                    errorMessage = '‚èπÔ∏è Reconnaissance interrompue.';
                    break;
                default:
                    errorMessage = `‚ùå Erreur: ${event.error}`;
            }
            
            showVoiceMessage(errorMessage, 'error');
            
            // Retry automatique pour certaines erreurs
            if (shouldRetry) {
                voiceRetryCount++;
                console.log(`üîÑ Tentative ${voiceRetryCount}/${maxVoiceRetries}`);
                setTimeout(() => {
                    if (voiceRetryCount <= maxVoiceRetries) {
                        console.log('üîÑ Retry automatique...');
                        startVoiceInput();
                    } else {
                        stopVoiceInput();
                        voiceRetryCount = 0;
                    }
                }, 1000);
            } else {
                stopVoiceInput();
                voiceRetryCount = 0;
            }
        };
        
        recognition.onend = function() {
            console.log('üèÅ Reconnaissance vocale termin√©e');
            isListening = false;
            updateVoiceUI(false);
        };
        
        console.log('‚úÖ Reconnaissance vocale initialis√©e avec succ√®s');
        
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        const voiceButton = document.getElementById('voice-button');
        voiceButton.disabled = true;
        voiceButton.title = 'Erreur d\'initialisation';
        showVoiceMessage('‚ùå Erreur d\'initialisation de la reconnaissance vocale', 'error');
    }
}

// Basculer l'input vocal
function toggleVoiceInput() {
    if (isListening) {
        stopVoiceInput();
    } else {
        startVoiceInput();
    }
}

// D√©marrer l'√©coute vocale
function startVoiceInput() {
    console.log('üé§ Tentative de d√©marrage de l\'√©coute vocale...');
    
    if (!recognition) {
        console.error('‚ùå Reconnaissance vocale non initialis√©e');
        showVoiceMessage('‚ùå Reconnaissance vocale non initialis√©e', 'error');
        return;
    }
    
    if (isListening) {
        console.log('‚ö†Ô∏è √âcoute d√©j√† en cours');
        return;
    }
    
    // R√©initialiser le compteur de retry
    if (voiceRetryCount === 0) {
        voiceRetryCount = 0;
    }
    
    try {
        console.log('üöÄ D√©marrage de la reconnaissance...');
        recognition.start();
        
        // Timeout de s√©curit√© (10 secondes)
        voiceTimeout = setTimeout(() => {
            if (isListening) {
                console.log('‚è∞ Timeout de l\'√©coute vocale');
                showVoiceMessage('‚è∞ Timeout - Aucune parole d√©tect√©e', 'error');
                stopVoiceInput();
            }
        }, 10000);
        
    } catch (error) {
        console.error('‚ùå Erreur lors du d√©marrage:', error);
        showVoiceMessage('‚ùå Impossible de d√©marrer l\'√©coute: ' + error.message, 'error');
    }
}

// Arr√™ter l'√©coute vocale
function stopVoiceInput() {
    console.log('‚èπÔ∏è Arr√™t de l\'√©coute vocale...');
    
    // Nettoyer le timeout
    if (voiceTimeout) {
        clearTimeout(voiceTimeout);
        voiceTimeout = null;
        console.log('üßπ Timeout nettoy√©');
    }
    
    // Arr√™ter la d√©tection de niveau sonore
    stopAudioLevelDetection();
    
    if (recognition && isListening) {
        try {
            recognition.stop();
            console.log('‚úÖ Arr√™t demand√©');
        } catch (error) {
            console.error('‚ùå Erreur lors de l\'arr√™t:', error);
        }
    }
    
    // Forcer l'arr√™t de l'interface
    isListening = false;
    updateVoiceUI(false);
    
    // R√©initialiser le compteur de retry si on arr√™te manuellement
    if (voiceRetryCount > 0) {
        console.log('üîÑ R√©initialisation du compteur de retry');
        voiceRetryCount = 0;
    }
}

// Mettre √† jour l'interface vocale
function updateVoiceUI(listening) {
    console.log('üîÑ Mise √† jour de l\'interface vocale:', listening);
    
    const voiceButton = document.getElementById('voice-button');
    const voiceStatus = document.getElementById('voice-status');
    
    if (!voiceButton || !voiceStatus) {
        console.error('‚ùå √âl√©ments de l\'interface vocale non trouv√©s');
        return;
    }
    
    const voiceIcon = voiceButton.querySelector('i');
    
    if (listening) {
        console.log('üé§ Activation de l\'interface d\'√©coute');
        voiceButton.classList.add('listening');
        voiceIcon.className = 'fas fa-microphone-slash';
        voiceButton.title = 'Arr√™ter l\'√©coute';
        voiceStatus.style.display = 'flex';
        
        // Mettre √† jour le texte de statut
        const voiceText = voiceStatus.querySelector('.voice-text');
        if (voiceText) {
            voiceText.textContent = '√âcoute en cours... Parlez maintenant';
        }
    } else {
        console.log('üîá D√©sactivation de l\'interface d\'√©coute');
        voiceButton.classList.remove('listening');
        voiceIcon.className = 'fas fa-microphone';
        voiceButton.title = 'Parler';
        voiceStatus.style.display = 'none';
    }
}

// D√©marrer la d√©tection de niveau sonore
function startAudioLevelDetection() {
    console.log('üéµ D√©marrage de la d√©tection de niveau sonore...');
    
    try {
        // Cr√©er un contexte audio
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        
        // Obtenir l'acc√®s au microphone
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                // D√©marrer la surveillance du niveau sonore
                monitorAudioLevel();
                
                console.log('‚úÖ D√©tection de niveau sonore activ√©e');
            })
            .catch(error => {
                console.warn('‚ö†Ô∏è Impossible d\'acc√©der au microphone pour la d√©tection de niveau:', error);
            });
    } catch (error) {
        console.warn('‚ö†Ô∏è D√©tection de niveau sonore non support√©e:', error);
    }
}

// Surveiller le niveau sonore
function monitorAudioLevel() {
    if (!analyser) return;
    
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    
    audioLevelInterval = setInterval(() => {
        analyser.getByteFrequencyData(dataArray);
        
        // Calculer le niveau moyen
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            sum += dataArray[i];
        }
        const average = sum / dataArray.length;
        
        // Mettre √† jour l'interface si on d√©tecte du son
        if (average > 10) { // Seuil de d√©tection
            console.log('üîä Niveau sonore d√©tect√©:', average);
            updateVoiceLevelIndicator(average);
        }
    }, 100);
}

// Mettre √† jour l'indicateur de niveau sonore
function updateVoiceLevelIndicator(level) {
    const voiceWaves = document.querySelectorAll('.voice-wave');
    const intensity = Math.min(level / 50, 1); // Normaliser entre 0 et 1
    
    voiceWaves.forEach((wave, index) => {
        const height = 10 + (intensity * 20) + (Math.sin(Date.now() / 100 + index) * 5);
        wave.style.height = height + 'px';
    });
}

// Arr√™ter la d√©tection de niveau sonore
function stopAudioLevelDetection() {
    console.log('üîá Arr√™t de la d√©tection de niveau sonore...');
    
    if (audioLevelInterval) {
        clearInterval(audioLevelInterval);
        audioLevelInterval = null;
    }
    
    if (microphone) {
        microphone.disconnect();
        microphone = null;
    }
    
    if (audioContext) {
        audioContext.close();
        audioContext = null;
    }
    
    analyser = null;
}

// Afficher un message vocal
function showVoiceMessage(message, type) {
    console.log(`üì¢ Message vocal [${type}]:`, message);
    
    const voiceStatus = document.getElementById('voice-status');
    if (!voiceStatus) {
        console.error('‚ùå √âl√©ment voice-status non trouv√©');
        return;
    }
    
    // Supprimer les anciens messages
    const existingMessages = voiceStatus.querySelectorAll('.voice-success, .voice-error, .voice-info');
    existingMessages.forEach(msg => msg.remove());
    
    // Cr√©er un √©l√©ment de message temporaire
    const messageDiv = document.createElement('div');
    messageDiv.className = `voice-${type}`;
    messageDiv.textContent = message;
    messageDiv.style.marginTop = '0.5rem';
    messageDiv.style.padding = '0.5rem';
    messageDiv.style.borderRadius = '5px';
    messageDiv.style.fontSize = '0.8rem';
    messageDiv.style.fontWeight = '600';
    
    if (type === 'success') {
        messageDiv.style.color = '#28a745';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.border = '1px solid #c3e6cb';
    } else if (type === 'error') {
        messageDiv.style.color = '#dc3545';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
    } else if (type === 'info') {
        messageDiv.style.color = '#17a2b8';
        messageDiv.style.background = '#d1ecf1';
        messageDiv.style.border = '1px solid #bee5eb';
    }
    
    // Ajouter le message apr√®s le status
    voiceStatus.appendChild(messageDiv);
    
    // Supprimer le message apr√®s 4 secondes
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 4000);
}

// Fonctions pour l'upload de fichiers
function toggleFileUpload() {
    const fileUploadArea = document.getElementById('file-upload-area');
    const fileButton = document.getElementById('file-button');
    
    if (isFileUploadVisible) {
        fileUploadArea.style.display = 'none';
        fileButton.style.background = '#17a2b8';
        isFileUploadVisible = false;
    } else {
        fileUploadArea.style.display = 'block';
        fileButton.style.background = '#dc3545';
        isFileUploadVisible = true;
        
        // Initialiser les √©v√©nements de drag & drop
        initializeFileUpload();
    }
}

function initializeFileUpload() {
    const fileUploadArea = document.getElementById('file-upload-area');
    const fileInput = document.getElementById('file-input');
    
    // V√©rifier que les √©l√©ments existent
    if (!fileUploadArea || !fileInput) {
        console.error('‚ùå √âl√©ments d\'upload non trouv√©s');
        return;
    }
    
    // √âv√©nements de drag & drop
    fileUploadArea.addEventListener('dragover', handleDragOver);
    fileUploadArea.addEventListener('dragleave', handleDragLeave);
    fileUploadArea.addEventListener('drop', handleDrop);
    
    // Clic pour s√©lectionner des fichiers
    fileUploadArea.addEventListener('click', () => {
        if (fileInput) {
            fileInput.click();
        }
    });
    fileInput.addEventListener('change', handleFileSelect);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        uploadFiles(files);
    }
}

function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        uploadFiles(files);
    }
}

function uploadFiles(files) {
    console.log('üìÅ S√©lection de fichiers:', files.length);
    
    // Stocker les fichiers en attente au lieu de les uploader imm√©diatement
    Array.from(files).forEach(file => {
        pendingFiles.push(file);
        console.log('üìé Fichier ajout√© en attente:', file.name);
    });
    
    // Mettre √† jour l'indicateur de fichiers en attente
    updatePendingFilesIndicator();
    
    // Afficher un message de confirmation
    const fileUploadArea = document.getElementById('file-upload-area');
    fileUploadArea.innerHTML = `
        <div class="file-upload-status success">
            ‚úÖ ${files.length} fichier(s) pr√™t(s) √† √™tre envoy√©(s)
            <br><small>√âcrivez votre message et cliquez "Envoyer"</small>
        </div>
    `;
    
    // Fermer la zone d'upload apr√®s 3 secondes
    setTimeout(() => {
        toggleFileUpload();
    }, 3000);
}

function updatePendingFilesIndicator() {
    const indicator = document.getElementById('pending-files-indicator');
    const text = document.getElementById('pending-files-text');
    const fileCount = document.getElementById('file-count');
    
    if (pendingFiles.length > 0) {
        indicator.style.display = 'flex';
        text.textContent = `${pendingFiles.length} fichier(s) en attente`;
        fileCount.textContent = pendingFiles.length;
        fileCount.style.display = 'inline';
    } else {
        indicator.style.display = 'none';
        fileCount.style.display = 'none';
    }
}

function clearPendingFiles() {
    console.log('üóëÔ∏è Suppression des fichiers en attente');
    pendingFiles = [];
    uploadedFileContents = []; // Vider aussi le contenu des fichiers
    updatePendingFilesIndicator();
}

function uploadSingleFile(file, index, totalFiles, callback) {
    console.log(`üì§ Upload du fichier ${index + 1}/${totalFiles}:`, file.name);
    
    const formData = new FormData();
    formData.append('file', file);
    if (currentSessionId) {
        formData.append('session_id', currentSessionId);
    }
    
    const xhr = new XMLHttpRequest();
    
    // Suivi du progr√®s
    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            const progress = Math.round((e.loaded / e.total) * 100);
            updateUploadProgress(progress, `Upload de ${file.name}...`);
        }
    });
    
    // R√©ponse
    xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                console.log('‚úÖ Fichier upload√© avec succ√®s:', file.name);
                showUploadStatus('success', `‚úÖ ${file.name} upload√© avec succ√®s !`);
                
                // Passer la r√©ponse au callback
                callback(response);
            } else {
                console.error('‚ùå Erreur upload:', response.error);
                showUploadStatus('error', `‚ùå Erreur: ${response.error}`);
                callback(null);
            }
        } else {
            console.error('‚ùå Erreur HTTP:', xhr.status);
            showUploadStatus('error', `‚ùå Erreur de connexion (${xhr.status})`);
            callback(null);
        }
    });
    
    xhr.addEventListener('error', () => {
        console.error('‚ùå Erreur r√©seau');
        showUploadStatus('error', '‚ùå Erreur de connexion');
    });
    
    // Envoyer la requ√™te
    xhr.open('POST', '/chatbot/api/upload/');
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
    xhr.send(formData);
}

function updateUploadProgress(progress, message) {
    const progressBar = document.getElementById('progress-bar');
    const status = document.getElementById('upload-status');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (status) {
        status.textContent = message;
    }
}

function showUploadStatus(type, message) {
    const status = document.getElementById('upload-status');
    if (status) {
        status.className = `file-upload-status ${type}`;
        status.textContent = message;
    }
}

// Fonction pour envoyer automatiquement le fichier dans le chat
function sendFileToChat(filename, content) {
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.value = `Analyse ce fichier: ${filename}`;
        sendMessage();
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    console.log('üöÄ D√©but de sendMessage');
    if (isLoading) {
        console.log('‚ö†Ô∏è Envoi en cours, ignor√©');
        return;
    }
    
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    console.log('üìù Message √† envoyer:', message);
    console.log('üìé Fichiers en attente:', pendingFiles.length);
    
    if (!message && pendingFiles.length === 0) {
        console.log('‚ö†Ô∏è Aucun message ni fichier, ignor√©');
        return;
    }
    
    // Stocker le message en attente (m√™me s'il est vide, on peut envoyer seulement des fichiers)
    pendingMessage = message || '';
    
    // Si il y a des fichiers en attente, les envoyer d'abord
    if (pendingFiles.length > 0) {
        console.log('üì§ Envoi des fichiers en attente...');
        sendPendingFilesAndMessage();
    } else {
        // Envoyer seulement le message
        sendMessageOnly(message);
    }
}

function sendMessageOnly(message) {
    console.log('üí¨ Envoi du message seul');
    
    // Afficher l'indicateur de typing
    showTypingIndicator();
    
    // Notification de d√©but de traitement
    showChatNotification('Traitement de votre message...', 'info');
    
    // Ajouter le message de l'utilisateur √† l'interface
    addMessage('user', message);
    
    // D√©sactiver l'input pendant le chargement
    setLoading(true);
    
    // Envoyer la requ√™te au serveur
    fetch('/chatbot/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: message,
            session_id: currentSessionId
        })
    })
    .then(response => {
        console.log('üì° R√©ponse re√ßue:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Donn√©es re√ßues:', data);
        if (data.success) {
            console.log('‚úÖ Succ√®s - Ajout de la r√©ponse');
            
            // Masquer l'indicateur de typing
            hideTypingIndicator();
            
            // Notification de succ√®s
            showChatNotification('R√©ponse g√©n√©r√©e avec succ√®s !', 'success');
            
            // Mettre √† jour l'ID de session si c'est une nouvelle session
            if (data.session_id && !currentSessionId) {
                currentSessionId = data.session_id;
                updateSessionList();
            }
            
            // Ajouter la r√©ponse de l'assistant
            addMessage('assistant', data.response);
            
            // Afficher les PDFs upload√©s apr√®s l'envoi
            displayUploadedPDFs();
        } else {
            console.log('‚ùå Erreur dans la r√©ponse:', data.error);
            
            // Masquer l'indicateur de typing
            hideTypingIndicator();
            
            // Notification d'erreur
            showChatNotification('Erreur lors de la g√©n√©ration', 'error');
            
            addMessage('assistant', 'D√©sol√©, une erreur est survenue. Veuillez r√©essayer.');
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur de requ√™te:', error);
        
        // Masquer l'indicateur de typing
        hideTypingIndicator();
        
        // Notification d'erreur de connexion
        showChatNotification('Erreur de connexion', 'error');
        
        addMessage('assistant', 'D√©sol√©, une erreur de connexion est survenue.');
    })
    .finally(() => {
        console.log('üèÅ Fin de l\'envoi - D√©sactivation du mode chargement');
        setLoading(false);
        // Nettoyer le message en attente
        pendingMessage = '';
        document.getElementById('message-input').value = '';
    });
}

function sendPendingFilesAndMessage() {
    console.log('üì§ Envoi combin√©: fichiers + message');
    
    // Afficher l'indicateur de typing
    showTypingIndicator();
    
    // Notification de d√©but de traitement
    showChatNotification('Traitement des fichiers...', 'info');
    
    // Ajouter le message de l'utilisateur √† l'interface (m√™me s'il est vide)
    const displayMessage = pendingMessage || 'üìé Fichier(s) envoy√©(s)';
    addMessage('user', displayMessage);
    
    // D√©sactiver l'input pendant le chargement
    setLoading(true);
    
    // Uploader tous les fichiers en attente
    let uploadedCount = 0;
    const totalFiles = pendingFiles.length;
    
    pendingFiles.forEach((file, index) => {
        uploadSingleFileForMessage(file, (response) => {
            uploadedCount++;
            console.log(`üìé Fichier ${index + 1}/${totalFiles} upload√©`);
            
            if (uploadedCount === totalFiles) {
                // Tous les fichiers upload√©s, afficher le contenu puis envoyer le message
                displayUploadedFileContents();
                sendMessageWithFiles();
            }
        });
    });
}

// Nouvelle fonction pour afficher les fichiers upload√©s comme des pi√®ces jointes
function displayUploadedFileContents() {
    uploadedFileContents.forEach(fileData => {
        // Cr√©er un message avec pi√®ce jointe visuelle
        const fileAttachmentHtml = createFileAttachmentHtml(fileData);
        addMessage('user', fileAttachmentHtml);
    });
    // Vider le tableau apr√®s affichage
    uploadedFileContents = [];
}

// Fonction pour cr√©er le HTML d'une pi√®ce jointe
function createFileAttachmentHtml(fileData) {
    const fileSize = formatFileSize(fileData.size || 0);
    const fileIcon = getFileIcon(fileData.filename);
    
    return `
        <div class="file-attachment">
            <div class="file-icon">${fileIcon}</div>
            <div class="file-info">
                <div class="file-name">${escapeHtml(fileData.filename)}</div>
                <div class="file-size">${fileSize}</div>
            </div>
            <div class="file-status">Sent</div>
        </div>
    `;
}

// Fonction pour obtenir l'ic√¥ne du fichier
function getFileIcon(filename) {
    const extension = filename.split('.').pop().toLowerCase();
    if (extension === 'pdf') {
        return '<i class="fas fa-file-pdf"></i>';
    } else if (['xlsx', 'xls'].includes(extension)) {
        return '<i class="fas fa-file-excel"></i>';
    } else {
        return '<i class="fas fa-file"></i>';
    }
}

// Fonction pour formater la taille du fichier
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function uploadSingleFileForMessage(file, callback) {
    const formData = new FormData();
    formData.append('file', file);
    if (currentSessionId) {
        formData.append('session_id', currentSessionId);
    }
    
    const xhr = new XMLHttpRequest();
    
    xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                console.log('‚úÖ Fichier upload√©:', file.name);
                // Stocker les informations du fichier pour l'affichage
                if (response.filename) {
                    uploadedFileContents.push({
                        filename: response.filename,
                        size: file.size,
                        content: response.file_content
                    });
                }
                callback(response);
            } else {
                console.error('‚ùå Erreur upload:', response.error);
                callback(null);
            }
        } else {
            console.error('‚ùå Erreur HTTP:', xhr.status);
            callback(null);
        }
    });
    
    xhr.addEventListener('error', () => {
        console.error('‚ùå Erreur r√©seau');
        callback(null);
    });
    
    xhr.open('POST', '/chatbot/api/upload/');
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
    xhr.send(formData);
}

function sendMessageWithFiles() {
    console.log('üí¨ Envoi du message avec contexte des fichiers');
    
    // Notification de traitement des fichiers
    showChatNotification('Analyse des fichiers en cours...', 'info');
    
    // Envoyer la requ√™te au serveur
    fetch('/chatbot/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: pendingMessage || 'Analysez les fichiers upload√©s',
            session_id: currentSessionId
        })
    })
    .then(response => {
        console.log('üì° R√©ponse re√ßue:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Donn√©es re√ßues:', data);
        if (data.success) {
            console.log('‚úÖ Succ√®s - Ajout de la r√©ponse');
            
            // Masquer l'indicateur de typing
            hideTypingIndicator();
            
            // Notification de succ√®s
            showChatNotification('Analyse termin√©e avec succ√®s !', 'success');
            
            // Mettre √† jour l'ID de session si c'est une nouvelle session
            if (data.session_id && !currentSessionId) {
                currentSessionId = data.session_id;
                updateSessionList();
            }
            
            // Ajouter la r√©ponse de l'assistant
            addMessage('assistant', data.response);
            
            // Afficher les PDFs upload√©s apr√®s l'envoi
            displayUploadedPDFs();
        } else {
            console.log('‚ùå Erreur dans la r√©ponse:', data.error);
            
            // Masquer l'indicateur de typing
            hideTypingIndicator();
            
            // Notification d'erreur
            showChatNotification('Erreur lors de l\'analyse', 'error');
            
            addMessage('assistant', 'D√©sol√©, une erreur est survenue. Veuillez r√©essayer.');
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur de requ√™te:', error);
        
        // Masquer l'indicateur de typing
        hideTypingIndicator();
        
        // Notification d'erreur de connexion
        showChatNotification('Erreur de connexion', 'error');
        
        addMessage('assistant', 'D√©sol√©, une erreur de connexion est survenue.');
    })
    .finally(() => {
        console.log('üèÅ Fin de l\'envoi - D√©sactivation du mode chargement');
        setLoading(false);
        // Nettoyer les donn√©es en attente
        pendingMessage = '';
        pendingFiles = [];
        uploadedFileContents = []; // Vider aussi le contenu des fichiers
        document.getElementById('message-input').value = '';
        // Mettre √† jour l'indicateur
        updatePendingFilesIndicator();
        // Fermer la zone d'upload si elle est ouverte
        if (isFileUploadVisible) {
            toggleFileUpload();
        }
    });
}

function addMessage(type, content) {
    console.log(`üí¨ Ajout d'un message ${type}:`, content);
    const messagesContainer = document.getElementById('chat-messages');
    
    if (!messagesContainer) {
        console.error('‚ùå Container chat-messages non trouv√©');
        return;
    }
    
    console.log('‚úÖ Container trouv√©, cr√©ation du message');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (type === 'assistant') {
        // Traitement markdown pour les r√©ponses de l'assistant
        const processedContent = processMarkdown(content);
        contentDiv.innerHTML = `<strong>Assistant :</strong> ${processedContent}`;
    } else {
        // V√©rifier si le contenu contient du HTML (pi√®ce jointe)
        if (content.includes('<div class="file-attachment">')) {
            // C'est une pi√®ce jointe, afficher directement le HTML
            contentDiv.innerHTML = `<strong>Vous :</strong> ${content}`;
        } else {
            // C'est du texte normal, l'√©chapper
            contentDiv.innerHTML = `<strong>Vous :</strong> ${escapeHtml(content)}`;
        }
    }
    
    messageDiv.appendChild(contentDiv);
    messagesContainer.appendChild(messageDiv);
    console.log('‚úÖ Message ajout√© au DOM');
    
    // Scroll vers le bas
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function processMarkdown(text) {
    if (!text) return '';
    
    // Traitement des blocs de code
    text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        const language = lang || 'text';
        const escapedCode = escapeHtml(code.trim());
        return `
        <div class="code-container">
            <div class="code-header">
                <span class="language-label">${language.toUpperCase()}</span>
                <button class="copy-btn" onclick="copyCode(this)">üìã Copier</button>
            </div>
            <div class="code-content">
                <pre><code class="language-${language}">${escapedCode}</code></pre>
            </div>
        </div>
        `;
    });
    
    // Traitement du code inline
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Traitement des titres
    text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
    text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
    
    // Traitement des listes
    text = text.replace(/^\- (.*$)/gm, '<li>$1</li>');
    text = text.replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>');
    
    // Traitement des paragraphes
    text = text.replace(/\n\n/g, '</p><p>');
    text = '<p>' + text + '</p>';
    
    // Traitement des listes
    text = text.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
    
    // Traitement des liens
    text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    // Traitement du texte en gras
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
    
    // Traitement du texte en italique
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    text = text.replace(/_(.*?)_/g, '<em>$1</em>');
    
    return text;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyCode(button) {
    const codeContainer = button.closest('.code-container');
    const codeElement = codeContainer.querySelector('code');
    const text = codeElement.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copi√©!';
        button.style.background = '#28a745';
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '#4a5568';
        }, 2000);
    }).catch(err => {
        console.error('Erreur lors de la copie:', err);
        button.textContent = '‚ùå Erreur';
        button.style.background = '#dc3545';
        
        setTimeout(() => {
            button.textContent = 'üìã Copier';
            button.style.background = '#4a5568';
        }, 2000);
    });
}

function setLoading(loading) {
    isLoading = loading;
    const sendButton = document.getElementById('send-button');
    const messageInput = document.getElementById('message-input');
    const typingIndicator = document.getElementById('typing-indicator');
    
    if (loading) {
        sendButton.disabled = true;
        messageInput.disabled = true;
        typingIndicator.style.display = 'block';
    } else {
        sendButton.disabled = false;
        messageInput.disabled = false;
        typingIndicator.style.display = 'none';
        messageInput.focus();
    }
}

function loadSession(sessionId) {
    // Mettre √† jour l'interface des sessions
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-session-id="${sessionId}"]`).classList.add('active');
    
    currentSessionId = sessionId;
    
    // Charger les messages de la session
    fetch(`/chatbot/api/session/${sessionId}/`)
    .then(response => response.json())
    .then(data => {
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = '';
        
        data.messages.forEach(msg => {
            addMessage(msg.type, msg.content);
        });
        
        // Afficher les PDFs upload√©s pour cette session
        displayUploadedPDFs();
    })
    .catch(error => {
        console.error('Erreur lors du chargement de la session:', error);
    });
}

function createNewSession() {
    currentSessionId = null;
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML = '';
    
    addMessage('assistant', 'Bonjour ! Je suis votre assistant √©ducatif. Comment puis-je vous aider aujourd\'hui ?');
}

function updateSessionList() {
    // Recharger la liste des sessions
    fetch('/chatbot/')
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newSessionsList = doc.getElementById('sessions-list');
        if (newSessionsList) {
            document.getElementById('sessions-list').innerHTML = newSessionsList.innerHTML;
        }
    });
}

// Fonction de recherche dynamique dans les conversations
function filterConversations(searchTerm) {
    const sessions = document.querySelectorAll('.session-item');
    const searchStats = document.getElementById('searchStats');
    const searchResultsCount = document.getElementById('searchResultsCount');
    const searchClearBtn = document.getElementById('searchClearBtn');
    
    let visibleCount = 0;
    
    if (searchTerm.trim() === '') {
        // Afficher toutes les conversations
        sessions.forEach(session => {
            session.classList.remove('search-hidden', 'search-highlight');
            session.style.display = 'block';
        });
        searchStats.style.display = 'none';
        searchClearBtn.style.display = 'none';
        return;
    }
    
    // Afficher le bouton de suppression
    searchClearBtn.style.display = 'flex';
    
    const searchLower = searchTerm.toLowerCase();
    
    sessions.forEach(session => {
        const title = session.querySelector('.session-title').textContent.toLowerCase();
        const timestamp = session.querySelector('.session-timestamp').textContent.toLowerCase();
        const subjectBadge = session.querySelector('.subject-badge');
        const subject = subjectBadge ? subjectBadge.textContent.toLowerCase() : '';
        
        // Recherche dans le titre, timestamp et sujet
        const matches = title.includes(searchLower) || 
                      timestamp.includes(searchLower) || 
                      subject.includes(searchLower);
        
        if (matches) {
            session.classList.remove('search-hidden');
            session.classList.add('search-highlight');
            session.style.display = 'block';
            visibleCount++;
            
            // Animation de surbrillance
            setTimeout(() => {
                session.classList.remove('search-highlight');
            }, 2000);
        } else {
            session.classList.add('search-hidden');
            session.classList.remove('search-highlight');
            session.style.display = 'none';
        }
    });
    
    // Afficher les statistiques de recherche
    searchResultsCount.textContent = visibleCount;
    searchStats.style.display = visibleCount > 0 ? 'block' : 'none';
    
    // Sauvegarder l'historique de recherche
    saveSearchHistory(searchTerm);
    
    // Message si aucun r√©sultat
    if (visibleCount === 0) {
        showNoResultsMessage(searchTerm);
    } else {
        hideNoResultsMessage();
    }
}

// Fonction pour effacer la recherche
function clearSearch() {
    const searchInput = document.getElementById('conversationSearch');
    const searchStats = document.getElementById('searchStats');
    const searchClearBtn = document.getElementById('searchClearBtn');
    
    searchInput.value = '';
    searchStats.style.display = 'none';
    searchClearBtn.style.display = 'none';
    
    // R√©initialiser l'affichage
    filterConversations('');
    hideNoResultsMessage();
    
    // Focus sur le champ de recherche
    searchInput.focus();
}

// Fonction pour afficher un message quand aucun r√©sultat
function showNoResultsMessage(searchTerm) {
    let noResultsDiv = document.getElementById('no-results-message');
    
    if (!noResultsDiv) {
        noResultsDiv = document.createElement('div');
        noResultsDiv.id = 'no-results-message';
        noResultsDiv.className = 'no-results-message';
        noResultsDiv.innerHTML = `
            <div class="no-results-icon">üîç</div>
            <div class="no-results-text">
                Aucune conversation trouv√©e pour "<strong>${searchTerm}</strong>"
            </div>
            <div class="no-results-suggestion">
                Essayez avec d'autres mots-cl√©s ou cr√©ez une nouvelle conversation
            </div>
        `;
        
        document.getElementById('sessions-list').appendChild(noResultsDiv);
    }
}

// Fonction pour masquer le message d'aucun r√©sultat
function hideNoResultsMessage() {
    const noResultsDiv = document.getElementById('no-results-message');
    if (noResultsDiv) {
        noResultsDiv.remove();
    }
}

// Fonction pour rechercher dans le contenu des messages (recherche avanc√©e)
function searchInMessages(searchTerm) {
    if (searchTerm.trim() === '') return;
    
    // Cette fonction pourrait √™tre √©tendue pour rechercher dans le contenu des messages
    // en faisant des requ√™tes AJAX vers le backend
    console.log('Recherche avanc√©e dans les messages:', searchTerm);
}

// Fonction pour g√©rer les raccourcis clavier dans la recherche
function handleSearchKeydown(event) {
    // √âchap pour effacer la recherche
    if (event.key === 'Escape') {
        clearSearch();
        return;
    }
    
    // Ctrl+F pour focus sur la recherche
    if (event.ctrlKey && event.key === 'f') {
        event.preventDefault();
        document.getElementById('conversationSearch').focus();
        return;
    }
    
    // Entr√©e pour rechercher dans les messages (recherche avanc√©e)
    if (event.key === 'Enter') {
        const searchTerm = event.target.value.trim();
        if (searchTerm) {
            searchInMessages(searchTerm);
        }
    }
}

// Fonction pour initialiser les raccourcis globaux
function initializeSearchShortcuts() {
    // Raccourci global Ctrl+F pour ouvrir la recherche
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'f') {
            event.preventDefault();
            const searchInput = document.getElementById('conversationSearch');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }
    });
    
    // Auto-focus sur la recherche au chargement de la page
    const searchInput = document.getElementById('conversationSearch');
    if (searchInput) {
        // Focus automatique apr√®s un court d√©lai
        setTimeout(() => {
            searchInput.focus();
        }, 500);
    }
}

// Fonction pour am√©liorer l'exp√©rience de recherche avec debouncing
let searchTimeout;
function debouncedSearch(searchTerm) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        filterConversations(searchTerm);
    }, 300); // Attendre 300ms apr√®s la derni√®re frappe
}

// Fonction pour sauvegarder les recherches r√©centes
function saveSearchHistory(searchTerm) {
    if (searchTerm.trim() === '') return;
    
    let searchHistory = JSON.parse(localStorage.getItem('chatbot_search_history') || '[]');
    
    // Ajouter la recherche si elle n'existe pas d√©j√†
    if (!searchHistory.includes(searchTerm)) {
        searchHistory.unshift(searchTerm);
        // Garder seulement les 10 derni√®res recherches
        searchHistory = searchHistory.slice(0, 10);
        localStorage.setItem('chatbot_search_history', JSON.stringify(searchHistory));
    }
}

// Fonction pour charger l'historique de recherche
function loadSearchHistory() {
    const searchHistory = JSON.parse(localStorage.getItem('chatbot_search_history') || '[]');
    return searchHistory;
}

// Fonction pour initialiser Google Translate
function initializeGoogleTranslate() {
    // V√©rifier si Google Translate est d√©j√† charg√©
    if (document.getElementById("google-translate-script")) {
        return;
    }
    
    // Cr√©er et charger le script Google Translate
    const script = document.createElement("script");
    script.id = "google-translate-script";
    script.src = "//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
    script.async = true;
    script.onerror = function() {
        console.warn("Impossible de charger Google Translate");
        // Masquer le widget en cas d'erreur
        const translateWidget = document.querySelector('.translate-widget');
        if (translateWidget) {
            translateWidget.style.display = 'none';
        }
    };
    document.body.appendChild(script);
    
    // Fonction de callback pour initialiser le widget
    window.googleTranslateElementInit = function() {
        // V√©rifier si le widget est d√©j√† initialis√©
        if (document.getElementById("gt-widget-loaded")) {
            return;
        }
        
        try {
            // Initialiser le widget Google Translate
            new window.google.translate.TranslateElement(
                {
                    pageLanguage: "fr",
                    includedLanguages: "fr,en,ar,de,es,it,pt,ru,zh-CN,ja,ko,nl,tr,pl",
                    layout: window.google.translate.TranslateElement.InlineLayout.SIMPLE,
                    autoDisplay: false,
                    multilanguagePage: true
                },
                "google_translate_element"
            );
            
            // Marquer comme charg√©
            const marker = document.createElement("div");
            marker.id = "gt-widget-loaded";
            marker.style.display = "none";
            document.body.appendChild(marker);
            
            // Personnaliser l'apparence apr√®s chargement
            setTimeout(customizeGoogleTranslate, 500);
            
        } catch (error) {
            console.error("Erreur lors de l'initialisation de Google Translate:", error);
        }
    };
}

// Fonction pour personnaliser l'apparence de Google Translate
function customizeGoogleTranslate() {
    // Masquer la banni√®re Google Translate
    const banner = document.querySelector('.goog-te-banner-frame');
    if (banner) {
        banner.style.display = 'none';
    }
    
    // Personnaliser le s√©lecteur de langue
    const combo = document.querySelector('.goog-te-combo');
    if (combo) {
        combo.style.width = '100%';
        combo.style.fontSize = '0.85rem';
        combo.style.padding = '6px 10px';
        combo.style.borderRadius = '8px';
        combo.style.border = '2px solid #e9ecef';
        combo.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%)';
        combo.style.color = '#2c3e50';
        combo.style.transition = 'all 0.3s ease';
        combo.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
    }
    
    // Ajouter des √©v√©nements pour les interactions
    const translateWidget = document.querySelector('.translate-widget');
    if (translateWidget) {
        // Animation au survol
        translateWidget.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 12px 35px rgba(0, 0, 0, 0.2)';
        });
        
        translateWidget.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';
        });
    }
}

// Fonction pour d√©tecter les changements de langue
function detectLanguageChange() {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                // V√©rifier si le contenu a √©t√© traduit
                const body = document.body;
                if (body.classList.contains('translated-ltr') || body.classList.contains('translated-rtl')) {
                    console.log('Page traduite d√©tect√©e');
                    // Optionnel : ajouter des actions sp√©cifiques apr√®s traduction
                }
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['class']
    });
}

// Initialiser la d√©tection des changements de langue
detectLanguageChange();

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
    }

    // Fonction pour afficher les PDFs upload√©s
    function displayUploadedPDFs() {
        if (!currentSessionId) {
            console.log('‚ö†Ô∏è Aucune session active');
            return;
        }
        
        fetch(`/chatbot/api/files/${currentSessionId}/`)
        .then(response => response.json())
        .then(data => {
            const section = document.getElementById('uploaded-pdfs-section');
            const list = document.getElementById('uploaded-pdfs-list');
            
            if (data.files && data.files.length > 0) {
                section.style.display = 'block';
                list.innerHTML = '';
                
                data.files.forEach(file => {
                    if (file.file_type === 'pdf') {
                        const pdfItem = document.createElement('div');
                        pdfItem.className = 'uploaded-pdf-item';
                        pdfItem.innerHTML = `
                            <div class="pdf-info">
                                <i class="fas fa-file-pdf pdf-icon"></i>
                                <div class="pdf-details">
                                    <div class="pdf-name">${file.filename}</div>
                                    <div class="pdf-size">${file.file_size}</div>
                                </div>
                            </div>
                            <div class="pdf-actions">
                                <button class="btn-ask-pdf" onclick="askAboutPDF('${file.filename}')">
                                    <i class="fas fa-question-circle"></i> Poser une question
                                </button>
                                <button class="btn-remove-pdf" onclick="removePDF(${file.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        list.appendChild(pdfItem);
                    }
                });
            } else {
                section.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des PDFs:', error);
        });
    }
    
    // Fonction pour poser une question sur un PDF sp√©cifique
    function askAboutPDF(filename) {
        const question = prompt(`Que voulez-vous savoir sur le fichier "${filename}" ?`);
        if (question && question.trim()) {
            const messageInput = document.getElementById('message-input');
            messageInput.value = `Question sur ${filename}: ${question.trim()}`;
            messageInput.focus();
        }
    }
    
    // Fonction pour supprimer un PDF
    function removePDF(fileId) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer ce PDF ?')) {
            // Ici vous pouvez ajouter une fonction pour supprimer le PDF
            console.log('Suppression du PDF:', fileId);
            displayUploadedPDFs(); // Recharger la liste
        }
    }

// Fonction pour g√©n√©rer un PDF
function generatePDF() {
    console.log('üìÑ G√©n√©ration de PDF demand√©e');
    
    // R√©cup√©rer le contenu de l'input du chatbot
    const messageInput = document.getElementById('message-input');
    const question = messageInput.value.trim();
    
    if (!question) {
        alert('Veuillez d\'abord √©crire votre question dans le champ de saisie.');
        messageInput.focus();
        return;
    }
    
    // Afficher un message de chargement
    addMessage('assistant', 'üîÑ G√©n√©ration de la r√©ponse et du PDF en cours...');
    
    // D'abord, envoyer la question au chatbot pour obtenir une r√©ponse compl√®te
    fetch('/chatbot/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: question,
            session_id: currentSessionId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.response) {
            // Utiliser la r√©ponse du chatbot pour g√©n√©rer le PDF
            const responseContent = data.response;
            
            // D√©tecter automatiquement le type de PDF bas√© sur la question
            const educationalKeywords = ['cours', 'le√ßon', 'chapitre', 'r√©sum√©', 'explication', 'th√©orie', 'concept', 'd√©finition', 'article'];
            const isEducational = educationalKeywords.some(keyword => question.toLowerCase().includes(keyword));
            const pdfType = isEducational ? 'educational' : 'normal';
            
            // Cr√©er un titre et nom de fichier bas√©s sur la question
            const title = question.length > 50 ? question.substring(0, 47) + '...' : question;
            const filename = question.length > 30 ? question.substring(0, 27) + '...' + '.pdf' : question + '.pdf';
            const cleanFilename = filename.replace(/[<>:"/\\|?*]/g, '_');
            
            let topic = 'Sujet √©ducatif';
            let level = 'interm√©diaire';
            
            if (pdfType === 'educational') {
                // Essayer d'extraire le sujet de la question
                if (question.toLowerCase().includes('math')) topic = 'Math√©matiques';
                else if (question.toLowerCase().includes('physique')) topic = 'Physique';
                else if (question.toLowerCase().includes('chimie')) topic = 'Chimie';
                else if (question.toLowerCase().includes('informatique')) topic = 'Informatique';
                else if (question.toLowerCase().includes('histoire')) topic = 'Histoire';
                else if (question.toLowerCase().includes('fran√ßais')) topic = 'Fran√ßais';
                else if (question.toLowerCase().includes('ia') || question.toLowerCase().includes('intelligence artificielle')) topic = 'Intelligence Artificielle';
                
                // D√©tecter le niveau
                if (question.toLowerCase().includes('d√©butant') || question.toLowerCase().includes('facile')) level = 'd√©butant';
                else if (question.toLowerCase().includes('avanc√©') || question.toLowerCase().includes('difficile')) level = 'avanc√©';
            }
            
            // Pr√©parer les donn√©es pour le PDF avec la r√©ponse du chatbot
            const pdfData = {
                content: responseContent.trim(),
                title: title.trim(),
                filename: cleanFilename.trim(),
                type: pdfType
            };
            
            if (pdfType === 'educational') {
                pdfData.topic = topic.trim();
                pdfData.level = level.trim();
            }
            
            console.log('üìä Donn√©es PDF:', pdfData);
            
            // G√©n√©rer le PDF avec la r√©ponse du chatbot
            return fetch('/chatbot/api/generate-pdf/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(pdfData)
            }).then(response => {
                console.log('üì° R√©ponse PDF re√ßue:', response.status);
                
                if (response.ok) {
                    return response.blob().then(blob => {
                        console.log('‚úÖ PDF g√©n√©r√© avec succ√®s');
                        
                        // Cr√©er un lien de t√©l√©chargement
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = pdfData.filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Afficher un message de succ√®s
                        addMessage('assistant', `‚úÖ PDF g√©n√©r√© et t√©l√©charg√© avec la r√©ponse compl√®te !`);
                        
                        // Vider l'input apr√®s g√©n√©ration
                        messageInput.value = '';
                    });
                } else {
                    throw new Error('Erreur lors de la g√©n√©ration du PDF');
                }
            });
        } else {
            throw new Error('Aucune r√©ponse re√ßue du chatbot');
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur lors de la g√©n√©ration du PDF:', error);
        addMessage('assistant', '‚ùå Erreur lors de la g√©n√©ration du PDF. Veuillez r√©essayer.');
    });
}
</script>

<!-- Script pour le mode sombre/clair -->
<script>
// Gestion du mode sombre/clair pour le chatbot
class ThemeManager {
    constructor() {
        this.currentTheme = this.getStoredTheme() || 'auto';
        this.init();
    }

    init() {
        this.applyTheme(this.currentTheme);
        this.bindEvents();
    }

    getStoredTheme() {
        // R√©cup√©rer depuis localStorage
        const stored = localStorage.getItem('chatbot-theme');
        if (stored) return stored;
        
        // R√©cup√©rer depuis les pr√©f√©rences utilisateur (si connect√©)
        const userTheme = document.body.getAttribute('data-user-theme');
        if (userTheme) return userTheme;
        
        return 'auto';
    }

    applyTheme(theme) {
        const chatContainer = document.querySelector('.chat-container');
        
        if (chatContainer) {
            chatContainer.setAttribute('data-theme', theme);
        }
        
        // Mettre √† jour l'ic√¥ne du bouton
        this.updateThemeIcon(theme);
        
        // Sauvegarder la pr√©f√©rence
        localStorage.setItem('chatbot-theme', theme);
    }

    updateThemeIcon(theme) {
        const icon = document.querySelector('.theme-toggle i');
        if (!icon) return;

        // Supprimer toutes les classes d'ic√¥nes
        icon.className = '';
        
        switch(theme) {
            case 'light':
                icon.className = 'fas fa-sun';
                break;
            case 'dark':
                icon.className = 'fas fa-moon';
                break;
            case 'auto':
                icon.className = 'fas fa-adjust';
                break;
        }
    }

    bindEvents() {
        const themeToggle = document.querySelector('.theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                this.cycleTheme();
            });
        }
    }

    cycleTheme() {
        const themes = ['light', 'dark', 'auto'];
        const currentIndex = themes.indexOf(this.currentTheme);
        const nextIndex = (currentIndex + 1) % themes.length;
        const nextTheme = themes[nextIndex];
        
        this.setTheme(nextTheme);
    }

    async setTheme(theme) {
        this.currentTheme = theme;
        this.applyTheme(theme);
        
        // Envoyer la pr√©f√©rence au serveur si l'utilisateur est connect√©
        try {
            const response = await fetch('/chatbot/api/theme-toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({ theme: theme })
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Th√®me mis √† jour:', data.message);
            }
        } catch (error) {
            console.error('Erreur lors de la mise √† jour du th√®me:', error);
        }
    }

    getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }
}

// Initialiser le gestionnaire de th√®me quand le DOM est pr√™t
document.addEventListener('DOMContentLoaded', function() {
    window.themeManager = new ThemeManager();
    
    // Attacher l'√©v√©nement au bouton de th√®me
    const themeToggle = document.querySelector('.theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            window.themeManager.toggleTheme();
        });
    }
    
    // √âcouter les changements de pr√©f√©rences syst√®me
    if (window.matchMedia) {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addListener(function(e) {
            if (window.themeManager.currentTheme === 'auto') {
                window.themeManager.applyTheme('auto');
            }
        });
    }
    
    // Initialiser les raccourcis de recherche
    initializeSearchShortcuts();
    
    // Initialiser Google Translate
    initializeGoogleTranslate();
});

// Fonction utilitaire pour changer le th√®me depuis d'autres scripts
window.setChatbotTheme = function(theme) {
    if (window.themeManager) {
        window.themeManager.setTheme(theme);
    }
};

// Fonction pour obtenir le th√®me actuel
window.getChatbotTheme = function() {
    return window.themeManager ? window.themeManager.currentTheme : 'auto';
};

// ===== SYST√àME DE NOTIFICATIONS =====
class NotificationManager {
    constructor() {
        this.container = document.getElementById('notificationContainer');
        this.notifications = [];
        this.maxNotifications = 3;
    }
    
    // Cr√©er une nouvelle notification
    showNotification(title, message, type = 'success', duration = 3000) {
        const notification = this.createNotification(title, message, type);
        this.container.appendChild(notification);
        this.notifications.push(notification);
        
        // Animation d'entr√©e
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        // Auto-suppression
        setTimeout(() => {
            this.removeNotification(notification);
        }, duration);
        
        // Limiter le nombre de notifications
        if (this.notifications.length > this.maxNotifications) {
            this.removeNotification(this.notifications[0]);
        }
        
        // Son de notification
        this.playNotificationSound(type);
    }
    
    // Cr√©er l'√©l√©ment de notification
    createNotification(title, message, type) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        
        const icon = this.getNotificationIcon(type);
        
        notification.innerHTML = `
            <div class="notification-header">
                <div class="notification-title">
                    <span class="notification-icon">${icon}</span>
                    ${title}
                </div>
                <button class="notification-close" onclick="window.notificationManager.removeNotification(this.parentElement.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notification-message">${message}</div>
        `;
        
        return notification;
    }
    
    // Obtenir l'ic√¥ne selon le type
    getNotificationIcon(type) {
        const icons = {
            'success': '<i class="fas fa-check"></i>',
            'info': '<i class="fas fa-info-circle"></i>',
            'warning': '<i class="fas fa-exclamation-triangle"></i>',
            'error': '<i class="fas fa-times-circle"></i>',
            'chat': '<i class="fas fa-robot"></i>'
        };
        return icons[type] || icons['info'];
    }
    
    // Supprimer une notification
    removeNotification(notification) {
        if (notification && notification.parentNode) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
                const index = this.notifications.indexOf(notification);
                if (index > -1) {
                    this.notifications.splice(index, 1);
                }
            }, 300);
        }
    }
    
    // Jouer un son de notification
    playNotificationSound(type) {
        try {
            // Cr√©er un contexte audio
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Fr√©quences selon le type
            const frequencies = {
                'success': [523, 659, 784], // Do, Mi, Sol
                'info': [440, 554], // La, Do#
                'warning': [330, 370], // Mi, Fa#
                'error': [220, 185], // La grave, Fa grave
                'chat': [523, 659] // Do, Mi
            };
            
            const freq = frequencies[type] || frequencies['info'];
            
            // Cr√©er une m√©lodie simple
            freq.forEach((f, index) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.setValueAtTime(f, audioContext.currentTime + index * 0.1);
                osc.type = 'sine';
                
                gain.gain.setValueAtTime(0.1, audioContext.currentTime + index * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.1 + 0.2);
                
                osc.start(audioContext.currentTime + index * 0.1);
                osc.stop(audioContext.currentTime + index * 0.1 + 0.2);
            });
        } catch (error) {
            console.log('Impossible de jouer le son de notification:', error);
        }
    }
}

// Initialiser le gestionnaire de notifications
window.notificationManager = new NotificationManager();

// Fonctions utilitaires pour les notifications
function showNotification(title, message, type = 'success') {
    window.notificationManager.showNotification(title, message, type);
}

// Notifications sp√©cifiques au chatbot
function showChatNotification(message, type = 'chat') {
    showNotification('Assistant IA', message, type);
}

// Indicateur de typing
function showTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.classList.add('show');
    }
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.classList.remove('show');
    }
}

// Modifier la fonction sendMessage pour int√©grer les notifications
const originalSendMessage = window.sendMessage;
window.sendMessage = function() {
    // Afficher l'indicateur de typing
    showTypingIndicator();
    
    // Notification de d√©but de traitement
    showChatNotification('Traitement de votre message...', 'info');
    
    // Appeler la fonction originale
    const result = originalSendMessage.apply(this, arguments);
    
    return result;
};

// Modifier la fonction qui g√®re la r√©ponse pour les notifications
function handleChatResponse(response) {
    // Masquer l'indicateur de typing
    hideTypingIndicator();
    
    // Notification de r√©ponse re√ßue
    showChatNotification('R√©ponse g√©n√©r√©e avec succ√®s !', 'success');
    
    // Si c'est une erreur
    if (response.error) {
        showChatNotification('Erreur lors de la g√©n√©ration', 'error');
    }
}

// Intercepter les r√©ponses du chatbot pour les notifications
const originalFetch = window.fetch;
window.fetch = function(...args) {
    return originalFetch.apply(this, args).then(response => {
        if (args[0] && args[0].includes('/chatbot/api/chat/')) {
            response.clone().json().then(data => {
                if (data.response) {
                    // R√©ponse re√ßue avec succ√®s
                    setTimeout(() => {
                        showChatNotification('R√©ponse pr√™te !', 'success');
                    }, 500);
                } else if (data.error) {
                    // Erreur dans la r√©ponse
                    setTimeout(() => {
                        showChatNotification('Erreur: ' + data.error, 'error');
                    }, 500);
                }
            }).catch(() => {
                // Erreur de parsing
                setTimeout(() => {
                    showChatNotification('Erreur de communication', 'error');
                }, 500);
            });
        }
        return response;
    });
};
</script>
{% endblock %}
