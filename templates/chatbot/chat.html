{% extends 'main/base.html' %}
{% load static %}

{% block title %}Chatbot Éducatif{% endblock %}

{% block extra_css %}
<style>
    /* Utiliser la même police que le projet */
    .chat-container, .chatbot-widget {
        font-family: 'Montserrat', sans-serif;
    }
    .chat-container {
        height: 80vh;
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px 10px 0 0;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: white;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.assistant {
        justify-content: flex-start;
    }
    
    .message-content {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message.user .message-content {
        background: #dc3545;
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message.assistant .message-content {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 5px;
    }
    
    .chat-input {
        padding: 1rem;
        background: white;
        border-top: 1px solid #dee2e6;
        border-radius: 0 0 10px 10px;
    }
    
    .input-group {
        display: flex;
        gap: 0.5rem;
    }
    
    .input-group input {
        flex: 1;
        border: 1px solid #ced4da;
        border-radius: 25px;
        padding: 0.75rem 1rem;
        outline: none;
    }
    
    .input-group input:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .btn-send {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-send:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    .btn-send:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Styles pour l'assistant vocal */
    .btn-voice {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }
    
    .btn-pdf {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }
    
    .btn-voice:hover {
        background: #218838;
        transform: scale(1.05);
    }
    
    .btn-pdf:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    .btn-voice:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-voice.listening {
        background: #dc3545;
        animation: pulse 1.5s infinite;
    }
    
    .btn-voice.listening:hover {
        background: #c82333;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .voice-status {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-radius: 10px;
        margin-top: 0.5rem;
        border: 2px solid #dc3545;
    }
    
    .voice-indicator {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .voice-wave {
        width: 4px;
        height: 20px;
        background: #dc3545;
        border-radius: 2px;
        animation: voiceWave 1s ease-in-out infinite;
    }
    
    .voice-wave:nth-child(1) { animation-delay: 0s; }
    .voice-wave:nth-child(2) { animation-delay: 0.2s; }
    .voice-wave:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes voiceWave {
        0%, 100% { height: 10px; }
        50% { height: 30px; }
    }
    
    .voice-text {
        color: #dc3545;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .voice-error {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #f8d7da;
        border-radius: 5px;
        border: 1px solid #f5c6cb;
    }
    
    .voice-success {
        color: #28a745;
        font-size: 0.8rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #d4edda;
        border-radius: 5px;
        border: 1px solid #c3e6cb;
    }
    
    /* Styles pour l'upload de fichiers */
    .btn-file {
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }
    
    .btn-file:hover {
        background: #138496;
        transform: scale(1.05);
    }
    
    .btn-file:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .file-upload-area {
        margin-top: 1rem;
        border: 2px dashed #dc3545;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
        transition: all 0.3s ease;
    }
    
    .file-upload-area:hover {
        border-color: #c82333;
        background: linear-gradient(135deg, #fef2f2 0%, #fce4e6 100%);
    }
    
    .file-upload-area.dragover {
        border-color: #28a745;
        background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
        transform: scale(1.02);
    }
    
    .file-upload-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    
    .file-upload-icon {
        font-size: 3rem;
        color: #dc3545;
        animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    
    .file-upload-text h5 {
        color: #dc3545;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .file-upload-text p {
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .file-upload-text small {
        color: #6c757d;
        font-style: italic;
    }
    
    .file-upload-progress {
        width: 100%;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 1rem;
    }
    
    .file-upload-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #dc3545, #c82333);
        border-radius: 2px;
        transition: width 0.3s ease;
    }
    
    .file-upload-status {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .file-upload-status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .file-upload-status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
        .file-upload-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Styles pour l'indicateur de fichiers en attente */
        .pending-files-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #bbdefb;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #1565c0;
            animation: slideIn 0.3s ease;
        }
        
        .pending-files-indicator i {
            color: #1976d2;
        }
        
        .btn-clear-files {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }
        
        .btn-clear-files:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
        
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Styles pour la section des PDFs uploadés */
    .uploaded-pdfs-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .uploaded-pdfs-section h4 {
        color: #495057;
        margin-bottom: 0.75rem;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .uploaded-pdf-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .uploaded-pdf-item:hover {
        background: #f8f9fa;
        border-color: #007bff;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }
    
    .pdf-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }
    
    .pdf-icon {
        color: #dc3545;
        font-size: 1.2rem;
    }
    
    .pdf-details {
        flex: 1;
    }
    
    .pdf-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.25rem;
    }
    
    .pdf-size {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .pdf-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-ask-pdf {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-ask-pdf:hover {
        background: #0056b3;
        transform: scale(1.05);
    }
    
    .btn-remove-pdf {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.4rem 0.6rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-remove-pdf:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    .typing-indicator {
        display: none;
        padding: 0.75rem 1rem;
        background: #e9ecef;
        border-radius: 18px;
        border-bottom-left-radius: 5px;
        color: #6c757d;
        font-style: italic;
    }
    
    .session-sidebar {
        width: 320px;
        background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
        border-right: 1px solid #e9ecef;
        padding: 0;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        position: relative;
    }
    
    .session-sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #dc3545, #c82333, #dc3545);
        background-size: 200% 100%;
        animation: gradientShift 3s ease-in-out infinite;
    }
    
    @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }
    
    .session-header {
        padding: 1.5rem 1.25rem 1rem;
        background: white;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(10px);
    }
    
    .session-header h5 {
        color: #2c3e50;
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .session-header h5::before {
        content: '💬';
        font-size: 1.2rem;
    }
    
    .new-session-btn {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        justify-content: center;
    }
    
    .new-session-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        background: linear-gradient(135deg, #c82333 0%, #b02a37 100%);
    }
    
    .new-session-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }
    
    .sessions-container {
        padding: 1rem 1.25rem;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }
    
    .sessions-container::-webkit-scrollbar {
        width: 4px;
    }
    
    .sessions-container::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .sessions-container::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 2px;
    }
    
    .sessions-container::-webkit-scrollbar-thumb:hover {
        background: #dc3545;
    }
    
    .session-item {
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: white;
        border-radius: 16px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .session-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #dc3545, #c82333);
        transform: scaleX(0);
        transition: transform 0.3s ease;
        transform-origin: left;
    }
    
    .session-item:hover {
        border-color: #dc3545;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.15);
        transform: translateY(-2px);
    }
    
    .session-item:hover::before {
        transform: scaleX(1);
    }
    
    .session-item.active {
        border-color: #dc3545;
        background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.2);
        transform: translateY(-1px);
    }
    
    .session-item.active::before {
        transform: scaleX(1);
    }
    
    .session-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .session-timestamp {
        color: #6c757d;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .session-timestamp::before {
        content: '🕒';
        font-size: 0.7rem;
    }
    
    .subject-badge {
        display: inline-block;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 0.3rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.75rem;
        box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: #6c757d;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .empty-state-text {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    /* Animations et effets supplémentaires */
    .session-item {
        animation: slideInUp 0.3s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .session-item:nth-child(1) { animation-delay: 0.1s; }
    .session-item:nth-child(2) { animation-delay: 0.2s; }
    .session-item:nth-child(3) { animation-delay: 0.3s; }
    .session-item:nth-child(4) { animation-delay: 0.4s; }
    .session-item:nth-child(5) { animation-delay: 0.5s; }
    
    /* Effet de pulsation pour le bouton nouveau */
    .new-session-btn {
        position: relative;
        overflow: hidden;
    }
    
    .new-session-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s;
    }
    
    .new-session-btn:hover::before {
        left: 100%;
    }
    
    /* Effet de focus pour l'accessibilité */
    .session-item:focus {
        outline: 2px solid #dc3545;
        outline-offset: 2px;
    }
    
    .new-session-btn:focus {
        outline: 2px solid #dc3545;
        outline-offset: 2px;
    }
    
    /* Responsive design pour mobile */
    @media (max-width: 768px) {
        .session-sidebar {
            width: 280px;
        }
        
        .session-header {
            padding: 1rem 1rem 0.75rem;
        }
        
        .sessions-container {
            padding: 0.75rem 1rem;
        }
        
        .session-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .session-title {
            font-size: 0.9rem;
        }
        
        .session-timestamp {
            font-size: 0.75rem;
        }
    }
    
    /* Dark mode support (optionnel) */
    @media (prefers-color-scheme: dark) {
        .session-sidebar {
            background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%);
            border-right-color: #404040;
        }
        
        .session-header {
            background: #1a1a1a;
            border-bottom-color: #404040;
        }
        
        .session-header h5 {
            color: #ffffff;
        }
        
        .session-item {
            background: #2d2d2d;
            border-color: #404040;
        }
        
        .session-title {
            color: #ffffff;
        }
        
        .session-timestamp {
            color: #a0a0a0;
        }
        
        .empty-state {
            color: #a0a0a0;
        }
    }
    
    .main-chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-layout {
        display: flex;
        height: 80vh;
    }
    
    /* Styles pour le code et markdown */
    .message-content h1, .message-content h2, .message-content h3 {
        color: #dc3545;
        margin: 1rem 0 0.5rem 0;
    }
    
    .message-content h1 { font-size: 1.5rem; }
    .message-content h2 { font-size: 1.3rem; }
    .message-content h3 { font-size: 1.1rem; }
    
    .message-content p {
        margin: 0.5rem 0;
        line-height: 1.6;
    }
    
    .message-content ul, .message-content ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }
    
    .message-content li {
        margin: 0.25rem 0;
    }
    
    .message-content blockquote {
        border-left: 4px solid #dc3545;
        padding-left: 1rem;
        margin: 1rem 0;
        background: #f8f9fa;
        padding: 0.5rem 1rem;
        border-radius: 0 5px 5px 0;
    }
    
    .message-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }
    
    .message-content th, .message-content td {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        text-align: left;
    }
    
    .message-content th {
        background: #f8f9fa;
        font-weight: bold;
    }
    
    /* Styles pour les blocs de code */
    .code-container {
        margin: 1rem 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .code-header {
        background: #2d3748;
        color: white;
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .language-label {
        font-family: 'Courier New', monospace;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .copy-btn {
        background: #4a5568;
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background 0.3s ease;
    }
    
    .copy-btn:hover {
        background: #5a6578;
    }
    
    .code-content {
        background: #f7fafc;
        overflow-x: auto;
    }
    
    .code-content pre {
        margin: 0;
        padding: 1rem;
        background: transparent;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .code-content code {
        background: transparent;
        padding: 0;
        border-radius: 0;
        font-family: 'Courier New', monospace;
    }
    
    /* Syntax highlighting styles */
    .highlight {
        background: #f7fafc;
    }
    
    .highlight .k { color: #d73a49; } /* Keywords */
    .highlight .s { color: #032f62; } /* Strings */
    .highlight .c { color: #6a737d; } /* Comments */
    .highlight .n { color: #6f42c1; } /* Names */
    .highlight .o { color: #d73a49; } /* Operators */
    .highlight .p { color: #24292e; } /* Punctuation */
    .highlight .nb { color: #005cc5; } /* Name builtin */
    .highlight .nf { color: #6f42c1; } /* Name function */
    .highlight .mi { color: #005cc5; } /* Number integer */
    .highlight .mf { color: #005cc5; } /* Number float */
    
    /* Inline code */
    .message-content code:not(.highlight code) {
        background: #f1f3f4;
        color: #d73a49;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    /* Amélioration de l'affichage des messages */
    .message-content {
        line-height: 1.6;
    }
    
    .message.assistant .message-content {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    
    /* Styles pour les pièces jointes */
    .file-attachment {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 16px;
        margin: 8px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }
    
    .file-icon {
        font-size: 24px;
        margin-right: 12px;
        color: #ff6b6b;
    }
    
    .file-icon .fa-file-pdf {
        color: #ff6b6b;
    }
    
    .file-icon .fa-file-excel {
        color: #4caf50;
    }
    
    .file-info {
        flex: 1;
        min-width: 0;
    }
    
    .file-name {
        font-weight: 500;
        font-size: 14px;
        line-height: 1.3;
        margin-bottom: 4px;
        word-break: break-word;
    }
    
    .file-size {
        font-size: 12px;
        opacity: 0.8;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .file-status {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="chat-layout">
                <!-- Sidebar des sessions -->
                <div class="session-sidebar">
                    <div class="session-header">
                        <h5>Conversations</h5>
                        <button class="new-session-btn" onclick="createNewSession()">
                            <i class="fas fa-plus"></i> Nouvelle conversation
                        </button>
                    </div>
                    
                    <div class="sessions-container" id="sessions-list">
                        {% for session in sessions %}
                        <div class="session-item" data-session-id="{{ session.id }}" onclick="loadSession({{ session.id }})">
                            <div class="session-title">{{ session.title }}</div>
                            <div class="session-timestamp">{{ session.created_at|date:"d/m/Y H:i" }}</div>
                            {% if session.messages.last.subject %}
                                <span class="subject-badge">{{ session.messages.last.subject.name }}</span>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <div class="empty-state-icon">💬</div>
                            <div class="empty-state-text">
                                Aucune conversation pour le moment.<br>
                                Commencez une nouvelle discussion !
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Zone de chat principale -->
                <div class="main-chat-area">
                    <div class="chat-container">
                        <div class="chat-header">
                            <h4 class="mb-0">
                                <i class="fas fa-robot me-2"></i>
                                Assistant Éducatif
                            </h4>
                            <small>Posez vos questions sur les mathématiques, physique, informatique, et plus encore !</small>
                        </div>
                        
                        <div class="chat-messages" id="chat-messages">
                            <div class="message assistant">
                                <div class="message-content">
                                    <strong>Assistant :</strong> Bonjour ! Je suis votre assistant éducatif. Je peux vous aider dans de nombreux domaines : mathématiques, physique, chimie, informatique, biologie, histoire, français, et bien d'autres ! Posez-moi vos questions et je ferai de mon mieux pour vous expliquer clairement.
                                </div>
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typing-indicator">
                            L'assistant écrit...
                        </div>
                        
                        <div class="chat-input">
                            <div class="input-group">
                <input type="text" id="message-input" placeholder="Posez votre question sur le PDF ou écrivez votre message..." 
                       onkeypress="handleKeyPress(event)">
                                <button class="btn-file" id="file-button" onclick="toggleFileUpload()" title="Envoyer un fichier">
                                    <i class="fas fa-paperclip"></i>
                                    <span id="file-count" style="display: none;">0</span>
                                </button>
                    <button class="btn-voice" id="voice-button" onclick="toggleVoiceInput()" title="Parler">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="btn-pdf" id="pdf-button" onclick="generatePDF()" title="Générer un PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button class="btn-send" id="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                            </div>
                            
                            <!-- Indicateur de fichiers en attente -->
                            <div id="pending-files-indicator" style="display: none;" class="pending-files-indicator">
                                <i class="fas fa-file"></i>
                                <span id="pending-files-text">0 fichier(s) en attente</span>
                                <button onclick="clearPendingFiles()" class="btn-clear-files" title="Supprimer les fichiers">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                <!-- Zone d'affichage des PDFs uploadés -->
                <div id="uploaded-pdfs-section" style="display: none;" class="uploaded-pdfs-section">
                    <h4><i class="fas fa-file-pdf"></i> PDFs disponibles pour analyse :</h4>
                    <div id="uploaded-pdfs-list"></div>
                </div>
                
                <!-- Zone d'upload de fichiers -->
                <div class="file-upload-area" id="file-upload-area" style="display: none;">
                                <div class="file-upload-content">
                                    <div class="file-upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        <h5>Glissez-déposez vos fichiers ici</h5>
                                        <p>ou cliquez pour sélectionner</p>
                                        <small>Formats supportés: PDF, Excel (.xlsx, .xls)</small>
                                    </div>
                                    <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls" style="display: none;">
                                </div>
                            </div>
                            
                            <div class="voice-status" id="voice-status" style="display: none;">
                                <div class="voice-indicator">
                                    <div class="voice-wave"></div>
                                    <div class="voice-wave"></div>
                                    <div class="voice-wave"></div>
                                </div>
                                <span class="voice-text">Écoute en cours... Parlez maintenant</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = null;
let isLoading = false;
let isListening = false;
let recognition = null;
let voiceRetryCount = 0;
let maxVoiceRetries = 2;
let voiceTimeout = null;
let audioContext = null;
let analyser = null;
let microphone = null;
let audioLevelInterval = null;
let isFileUploadVisible = false;

// Variables pour l'intégration message + PDF
let pendingMessage = '';
let pendingFiles = [];
let uploadedFileContents = []; // Nouveau tableau pour stocker le contenu des fichiers

// Gestion des événements
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initialisation de la page chatbot...');
    
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.focus();
        console.log('✅ Champ de message initialisé');
    } else {
        console.error('❌ Champ de message non trouvé');
    }
    
    // Afficher les PDFs uploadés au chargement
    displayUploadedPDFs();
    
    // Tester le support de la reconnaissance vocale
    testVoiceSupport();
    
    // Initialiser la reconnaissance vocale
    initializeVoiceRecognition();
});

// Tester le support de la reconnaissance vocale
function testVoiceSupport() {
    console.log('🧪 Test du support de la reconnaissance vocale...');
    
    const hasWebkitSpeech = 'webkitSpeechRecognition' in window;
    const hasSpeech = 'SpeechRecognition' in window;
    
    console.log('🔍 Support webkitSpeechRecognition:', hasWebkitSpeech);
    console.log('🔍 Support SpeechRecognition:', hasSpeech);
    
    if (hasWebkitSpeech || hasSpeech) {
        console.log('✅ Reconnaissance vocale supportée');
        
        // Tester les permissions microphone
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            console.log('🎤 API getUserMedia disponible');
        } else {
            console.warn('⚠️ API getUserMedia non disponible');
        }
    } else {
        console.warn('❌ Reconnaissance vocale non supportée');
        showVoiceMessage('❌ Votre navigateur ne supporte pas la reconnaissance vocale', 'error');
    }
}

// Initialisation de la reconnaissance vocale
function initializeVoiceRecognition() {
    console.log('Initialisation de la reconnaissance vocale...');
    
    // Vérifier le support de la reconnaissance vocale
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('Reconnaissance vocale non supportée par ce navigateur');
        const voiceButton = document.getElementById('voice-button');
        voiceButton.disabled = true;
        voiceButton.title = 'Reconnaissance vocale non supportée';
        voiceButton.style.opacity = '0.5';
        return;
    }
    
    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        // Configuration de la reconnaissance optimisée
        recognition.continuous = false;
        recognition.interimResults = true; // Activer les résultats intermédiaires
        recognition.lang = 'fr-FR';
        recognition.maxAlternatives = 5; // Plus d'alternatives pour meilleure détection
        recognition.serviceURI = ''; // Utiliser le service par défaut
        
        // Configuration pour une meilleure sensibilité
        // Note: grammars n'est pas toujours supporté, on l'évite
        
        // Événements de la reconnaissance
        recognition.onstart = function() {
            console.log('🎤 Reconnaissance vocale démarrée');
            isListening = true;
            updateVoiceUI(true);
            
            // Démarrer la détection de niveau sonore
            startAudioLevelDetection();
        };
        
        recognition.onresult = function(event) {
            console.log('🎯 Résultat reçu:', event);
            
            let finalTranscript = '';
            let interimTranscript = '';
            
            // Traiter tous les résultats
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                    console.log('📝 Texte final reconnu:', transcript);
                } else {
                    interimTranscript += transcript;
                    console.log('🔄 Texte intermédiaire:', transcript);
                }
            }
            
            // Mettre à jour l'input avec le texte final ou intermédiaire
            const messageInput = document.getElementById('message-input');
            if (finalTranscript) {
                messageInput.value = finalTranscript;
                console.log('✅ Texte final reconnu:', finalTranscript);
                
                // Afficher un message de succès
                showVoiceMessage('✅ Texte reconnu avec succès ! Envoi automatique...', 'success');
                
                // Envoyer directement le message au chatbot
                setTimeout(() => {
                    console.log('🚀 Envoi automatique du message vocal...');
                    sendMessage();
                }, 500); // Petit délai pour que l'utilisateur voie le message
                
                // Arrêter l'écoute seulement si on a un résultat final
                stopVoiceInput();
            } else if (interimTranscript) {
                // Afficher le texte intermédiaire en temps réel
                messageInput.value = interimTranscript;
                console.log('🔄 Texte intermédiaire affiché:', interimTranscript);
                
                // Afficher un message d'écoute
                showVoiceMessage('🎤 Écoute en cours...', 'info');
            }
        };
        
        recognition.onerror = function(event) {
            console.error('❌ Erreur de reconnaissance vocale:', event.error);
            let errorMessage = 'Erreur de reconnaissance vocale';
            let shouldRetry = false;
            
            switch(event.error) {
                case 'no-speech':
                    errorMessage = '🔇 Aucune parole détectée.';
                    shouldRetry = (voiceRetryCount < maxVoiceRetries);
                    if (shouldRetry) {
                        errorMessage += ` Nouvelle tentative (${voiceRetryCount + 1}/${maxVoiceRetries})...`;
                    }
                    break;
                case 'audio-capture':
                    errorMessage = '🎤 Microphone non disponible.';
                    break;
                case 'not-allowed':
                    errorMessage = '🚫 Permission microphone refusée.';
                    break;
                case 'network':
                    errorMessage = '🌐 Erreur réseau.';
                    shouldRetry = (voiceRetryCount < maxVoiceRetries);
                    break;
                case 'aborted':
                    errorMessage = '⏹️ Reconnaissance interrompue.';
                    break;
                default:
                    errorMessage = `❌ Erreur: ${event.error}`;
            }
            
            showVoiceMessage(errorMessage, 'error');
            
            // Retry automatique pour certaines erreurs
            if (shouldRetry) {
                voiceRetryCount++;
                console.log(`🔄 Tentative ${voiceRetryCount}/${maxVoiceRetries}`);
                setTimeout(() => {
                    if (voiceRetryCount <= maxVoiceRetries) {
                        console.log('🔄 Retry automatique...');
                        startVoiceInput();
                    } else {
                        stopVoiceInput();
                        voiceRetryCount = 0;
                    }
                }, 1000);
            } else {
                stopVoiceInput();
                voiceRetryCount = 0;
            }
        };
        
        recognition.onend = function() {
            console.log('🏁 Reconnaissance vocale terminée');
            isListening = false;
            updateVoiceUI(false);
        };
        
        console.log('✅ Reconnaissance vocale initialisée avec succès');
        
    } catch (error) {
        console.error('❌ Erreur lors de l\'initialisation:', error);
        const voiceButton = document.getElementById('voice-button');
        voiceButton.disabled = true;
        voiceButton.title = 'Erreur d\'initialisation';
        showVoiceMessage('❌ Erreur d\'initialisation de la reconnaissance vocale', 'error');
    }
}

// Basculer l'input vocal
function toggleVoiceInput() {
    if (isListening) {
        stopVoiceInput();
    } else {
        startVoiceInput();
    }
}

// Démarrer l'écoute vocale
function startVoiceInput() {
    console.log('🎤 Tentative de démarrage de l\'écoute vocale...');
    
    if (!recognition) {
        console.error('❌ Reconnaissance vocale non initialisée');
        showVoiceMessage('❌ Reconnaissance vocale non initialisée', 'error');
        return;
    }
    
    if (isListening) {
        console.log('⚠️ Écoute déjà en cours');
        return;
    }
    
    // Réinitialiser le compteur de retry
    if (voiceRetryCount === 0) {
        voiceRetryCount = 0;
    }
    
    try {
        console.log('🚀 Démarrage de la reconnaissance...');
        recognition.start();
        
        // Timeout de sécurité (10 secondes)
        voiceTimeout = setTimeout(() => {
            if (isListening) {
                console.log('⏰ Timeout de l\'écoute vocale');
                showVoiceMessage('⏰ Timeout - Aucune parole détectée', 'error');
                stopVoiceInput();
            }
        }, 10000);
        
    } catch (error) {
        console.error('❌ Erreur lors du démarrage:', error);
        showVoiceMessage('❌ Impossible de démarrer l\'écoute: ' + error.message, 'error');
    }
}

// Arrêter l'écoute vocale
function stopVoiceInput() {
    console.log('⏹️ Arrêt de l\'écoute vocale...');
    
    // Nettoyer le timeout
    if (voiceTimeout) {
        clearTimeout(voiceTimeout);
        voiceTimeout = null;
        console.log('🧹 Timeout nettoyé');
    }
    
    // Arrêter la détection de niveau sonore
    stopAudioLevelDetection();
    
    if (recognition && isListening) {
        try {
            recognition.stop();
            console.log('✅ Arrêt demandé');
        } catch (error) {
            console.error('❌ Erreur lors de l\'arrêt:', error);
        }
    }
    
    // Forcer l'arrêt de l'interface
    isListening = false;
    updateVoiceUI(false);
    
    // Réinitialiser le compteur de retry si on arrête manuellement
    if (voiceRetryCount > 0) {
        console.log('🔄 Réinitialisation du compteur de retry');
        voiceRetryCount = 0;
    }
}

// Mettre à jour l'interface vocale
function updateVoiceUI(listening) {
    console.log('🔄 Mise à jour de l\'interface vocale:', listening);
    
    const voiceButton = document.getElementById('voice-button');
    const voiceStatus = document.getElementById('voice-status');
    
    if (!voiceButton || !voiceStatus) {
        console.error('❌ Éléments de l\'interface vocale non trouvés');
        return;
    }
    
    const voiceIcon = voiceButton.querySelector('i');
    
    if (listening) {
        console.log('🎤 Activation de l\'interface d\'écoute');
        voiceButton.classList.add('listening');
        voiceIcon.className = 'fas fa-microphone-slash';
        voiceButton.title = 'Arrêter l\'écoute';
        voiceStatus.style.display = 'flex';
        
        // Mettre à jour le texte de statut
        const voiceText = voiceStatus.querySelector('.voice-text');
        if (voiceText) {
            voiceText.textContent = 'Écoute en cours... Parlez maintenant';
        }
    } else {
        console.log('🔇 Désactivation de l\'interface d\'écoute');
        voiceButton.classList.remove('listening');
        voiceIcon.className = 'fas fa-microphone';
        voiceButton.title = 'Parler';
        voiceStatus.style.display = 'none';
    }
}

// Démarrer la détection de niveau sonore
function startAudioLevelDetection() {
    console.log('🎵 Démarrage de la détection de niveau sonore...');
    
    try {
        // Créer un contexte audio
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        
        // Obtenir l'accès au microphone
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                // Démarrer la surveillance du niveau sonore
                monitorAudioLevel();
                
                console.log('✅ Détection de niveau sonore activée');
            })
            .catch(error => {
                console.warn('⚠️ Impossible d\'accéder au microphone pour la détection de niveau:', error);
            });
    } catch (error) {
        console.warn('⚠️ Détection de niveau sonore non supportée:', error);
    }
}

// Surveiller le niveau sonore
function monitorAudioLevel() {
    if (!analyser) return;
    
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    
    audioLevelInterval = setInterval(() => {
        analyser.getByteFrequencyData(dataArray);
        
        // Calculer le niveau moyen
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            sum += dataArray[i];
        }
        const average = sum / dataArray.length;
        
        // Mettre à jour l'interface si on détecte du son
        if (average > 10) { // Seuil de détection
            console.log('🔊 Niveau sonore détecté:', average);
            updateVoiceLevelIndicator(average);
        }
    }, 100);
}

// Mettre à jour l'indicateur de niveau sonore
function updateVoiceLevelIndicator(level) {
    const voiceWaves = document.querySelectorAll('.voice-wave');
    const intensity = Math.min(level / 50, 1); // Normaliser entre 0 et 1
    
    voiceWaves.forEach((wave, index) => {
        const height = 10 + (intensity * 20) + (Math.sin(Date.now() / 100 + index) * 5);
        wave.style.height = height + 'px';
    });
}

// Arrêter la détection de niveau sonore
function stopAudioLevelDetection() {
    console.log('🔇 Arrêt de la détection de niveau sonore...');
    
    if (audioLevelInterval) {
        clearInterval(audioLevelInterval);
        audioLevelInterval = null;
    }
    
    if (microphone) {
        microphone.disconnect();
        microphone = null;
    }
    
    if (audioContext) {
        audioContext.close();
        audioContext = null;
    }
    
    analyser = null;
}

// Afficher un message vocal
function showVoiceMessage(message, type) {
    console.log(`📢 Message vocal [${type}]:`, message);
    
    const voiceStatus = document.getElementById('voice-status');
    if (!voiceStatus) {
        console.error('❌ Élément voice-status non trouvé');
        return;
    }
    
    // Supprimer les anciens messages
    const existingMessages = voiceStatus.querySelectorAll('.voice-success, .voice-error, .voice-info');
    existingMessages.forEach(msg => msg.remove());
    
    // Créer un élément de message temporaire
    const messageDiv = document.createElement('div');
    messageDiv.className = `voice-${type}`;
    messageDiv.textContent = message;
    messageDiv.style.marginTop = '0.5rem';
    messageDiv.style.padding = '0.5rem';
    messageDiv.style.borderRadius = '5px';
    messageDiv.style.fontSize = '0.8rem';
    messageDiv.style.fontWeight = '600';
    
    if (type === 'success') {
        messageDiv.style.color = '#28a745';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.border = '1px solid #c3e6cb';
    } else if (type === 'error') {
        messageDiv.style.color = '#dc3545';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.border = '1px solid #f5c6cb';
    } else if (type === 'info') {
        messageDiv.style.color = '#17a2b8';
        messageDiv.style.background = '#d1ecf1';
        messageDiv.style.border = '1px solid #bee5eb';
    }
    
    // Ajouter le message après le status
    voiceStatus.appendChild(messageDiv);
    
    // Supprimer le message après 4 secondes
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 4000);
}

// Fonctions pour l'upload de fichiers
function toggleFileUpload() {
    const fileUploadArea = document.getElementById('file-upload-area');
    const fileButton = document.getElementById('file-button');
    
    if (isFileUploadVisible) {
        fileUploadArea.style.display = 'none';
        fileButton.style.background = '#17a2b8';
        isFileUploadVisible = false;
    } else {
        fileUploadArea.style.display = 'block';
        fileButton.style.background = '#dc3545';
        isFileUploadVisible = true;
        
        // Initialiser les événements de drag & drop
        initializeFileUpload();
    }
}

function initializeFileUpload() {
    const fileUploadArea = document.getElementById('file-upload-area');
    const fileInput = document.getElementById('file-input');
    
    // Vérifier que les éléments existent
    if (!fileUploadArea || !fileInput) {
        console.error('❌ Éléments d\'upload non trouvés');
        return;
    }
    
    // Événements de drag & drop
    fileUploadArea.addEventListener('dragover', handleDragOver);
    fileUploadArea.addEventListener('dragleave', handleDragLeave);
    fileUploadArea.addEventListener('drop', handleDrop);
    
    // Clic pour sélectionner des fichiers
    fileUploadArea.addEventListener('click', () => {
        if (fileInput) {
            fileInput.click();
        }
    });
    fileInput.addEventListener('change', handleFileSelect);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        uploadFiles(files);
    }
}

function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        uploadFiles(files);
    }
}

function uploadFiles(files) {
    console.log('📁 Sélection de fichiers:', files.length);
    
    // Stocker les fichiers en attente au lieu de les uploader immédiatement
    Array.from(files).forEach(file => {
        pendingFiles.push(file);
        console.log('📎 Fichier ajouté en attente:', file.name);
    });
    
    // Mettre à jour l'indicateur de fichiers en attente
    updatePendingFilesIndicator();
    
    // Afficher un message de confirmation
    const fileUploadArea = document.getElementById('file-upload-area');
    fileUploadArea.innerHTML = `
        <div class="file-upload-status success">
            ✅ ${files.length} fichier(s) prêt(s) à être envoyé(s)
            <br><small>Écrivez votre message et cliquez "Envoyer"</small>
        </div>
    `;
    
    // Fermer la zone d'upload après 3 secondes
    setTimeout(() => {
        toggleFileUpload();
    }, 3000);
}

function updatePendingFilesIndicator() {
    const indicator = document.getElementById('pending-files-indicator');
    const text = document.getElementById('pending-files-text');
    const fileCount = document.getElementById('file-count');
    
    if (pendingFiles.length > 0) {
        indicator.style.display = 'flex';
        text.textContent = `${pendingFiles.length} fichier(s) en attente`;
        fileCount.textContent = pendingFiles.length;
        fileCount.style.display = 'inline';
    } else {
        indicator.style.display = 'none';
        fileCount.style.display = 'none';
    }
}

function clearPendingFiles() {
    console.log('🗑️ Suppression des fichiers en attente');
    pendingFiles = [];
    uploadedFileContents = []; // Vider aussi le contenu des fichiers
    updatePendingFilesIndicator();
}

function uploadSingleFile(file, index, totalFiles, callback) {
    console.log(`📤 Upload du fichier ${index + 1}/${totalFiles}:`, file.name);
    
    const formData = new FormData();
    formData.append('file', file);
    if (currentSessionId) {
        formData.append('session_id', currentSessionId);
    }
    
    const xhr = new XMLHttpRequest();
    
    // Suivi du progrès
    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            const progress = Math.round((e.loaded / e.total) * 100);
            updateUploadProgress(progress, `Upload de ${file.name}...`);
        }
    });
    
    // Réponse
    xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                console.log('✅ Fichier uploadé avec succès:', file.name);
                showUploadStatus('success', `✅ ${file.name} uploadé avec succès !`);
                
                // Passer la réponse au callback
                callback(response);
            } else {
                console.error('❌ Erreur upload:', response.error);
                showUploadStatus('error', `❌ Erreur: ${response.error}`);
                callback(null);
            }
        } else {
            console.error('❌ Erreur HTTP:', xhr.status);
            showUploadStatus('error', `❌ Erreur de connexion (${xhr.status})`);
            callback(null);
        }
    });
    
    xhr.addEventListener('error', () => {
        console.error('❌ Erreur réseau');
        showUploadStatus('error', '❌ Erreur de connexion');
    });
    
    // Envoyer la requête
    xhr.open('POST', '/chatbot/api/upload/');
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
    xhr.send(formData);
}

function updateUploadProgress(progress, message) {
    const progressBar = document.getElementById('progress-bar');
    const status = document.getElementById('upload-status');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (status) {
        status.textContent = message;
    }
}

function showUploadStatus(type, message) {
    const status = document.getElementById('upload-status');
    if (status) {
        status.className = `file-upload-status ${type}`;
        status.textContent = message;
    }
}

// Fonction pour envoyer automatiquement le fichier dans le chat
function sendFileToChat(filename, content) {
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.value = `Analyse ce fichier: ${filename}`;
        sendMessage();
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    console.log('🚀 Début de sendMessage');
    if (isLoading) {
        console.log('⚠️ Envoi en cours, ignoré');
        return;
    }
    
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    console.log('📝 Message à envoyer:', message);
    console.log('📎 Fichiers en attente:', pendingFiles.length);
    
    if (!message && pendingFiles.length === 0) {
        console.log('⚠️ Aucun message ni fichier, ignoré');
        return;
    }
    
    // Stocker le message en attente (même s'il est vide, on peut envoyer seulement des fichiers)
    pendingMessage = message || '';
    
    // Si il y a des fichiers en attente, les envoyer d'abord
    if (pendingFiles.length > 0) {
        console.log('📤 Envoi des fichiers en attente...');
        sendPendingFilesAndMessage();
    } else {
        // Envoyer seulement le message
        sendMessageOnly(message);
    }
}

function sendMessageOnly(message) {
    console.log('💬 Envoi du message seul');
    
    // Ajouter le message de l'utilisateur à l'interface
    addMessage('user', message);
    
    // Désactiver l'input pendant le chargement
    setLoading(true);
    
    // Envoyer la requête au serveur
    fetch('/chatbot/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: message,
            session_id: currentSessionId
        })
    })
    .then(response => {
        console.log('📡 Réponse reçue:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('📊 Données reçues:', data);
        if (data.success) {
            console.log('✅ Succès - Ajout de la réponse');
            // Mettre à jour l'ID de session si c'est une nouvelle session
            if (data.session_id && !currentSessionId) {
                currentSessionId = data.session_id;
                updateSessionList();
            }
            
            // Ajouter la réponse de l'assistant
            addMessage('assistant', data.response);
            
            // Afficher les PDFs uploadés après l'envoi
            displayUploadedPDFs();
        } else {
            console.log('❌ Erreur dans la réponse:', data.error);
            addMessage('assistant', 'Désolé, une erreur est survenue. Veuillez réessayer.');
        }
    })
    .catch(error => {
        console.error('❌ Erreur de requête:', error);
        addMessage('assistant', 'Désolé, une erreur de connexion est survenue.');
    })
    .finally(() => {
        console.log('🏁 Fin de l\'envoi - Désactivation du mode chargement');
        setLoading(false);
        // Nettoyer le message en attente
        pendingMessage = '';
        document.getElementById('message-input').value = '';
    });
}

function sendPendingFilesAndMessage() {
    console.log('📤 Envoi combiné: fichiers + message');
    
    // Ajouter le message de l'utilisateur à l'interface (même s'il est vide)
    const displayMessage = pendingMessage || '📎 Fichier(s) envoyé(s)';
    addMessage('user', displayMessage);
    
    // Désactiver l'input pendant le chargement
    setLoading(true);
    
    // Uploader tous les fichiers en attente
    let uploadedCount = 0;
    const totalFiles = pendingFiles.length;
    
    pendingFiles.forEach((file, index) => {
        uploadSingleFileForMessage(file, (response) => {
            uploadedCount++;
            console.log(`📎 Fichier ${index + 1}/${totalFiles} uploadé`);
            
            if (uploadedCount === totalFiles) {
                // Tous les fichiers uploadés, afficher le contenu puis envoyer le message
                displayUploadedFileContents();
                sendMessageWithFiles();
            }
        });
    });
}

// Nouvelle fonction pour afficher les fichiers uploadés comme des pièces jointes
function displayUploadedFileContents() {
    uploadedFileContents.forEach(fileData => {
        // Créer un message avec pièce jointe visuelle
        const fileAttachmentHtml = createFileAttachmentHtml(fileData);
        addMessage('user', fileAttachmentHtml);
    });
    // Vider le tableau après affichage
    uploadedFileContents = [];
}

// Fonction pour créer le HTML d'une pièce jointe
function createFileAttachmentHtml(fileData) {
    const fileSize = formatFileSize(fileData.size || 0);
    const fileIcon = getFileIcon(fileData.filename);
    
    return `
        <div class="file-attachment">
            <div class="file-icon">${fileIcon}</div>
            <div class="file-info">
                <div class="file-name">${escapeHtml(fileData.filename)}</div>
                <div class="file-size">${fileSize}</div>
            </div>
            <div class="file-status">Sent</div>
        </div>
    `;
}

// Fonction pour obtenir l'icône du fichier
function getFileIcon(filename) {
    const extension = filename.split('.').pop().toLowerCase();
    if (extension === 'pdf') {
        return '<i class="fas fa-file-pdf"></i>';
    } else if (['xlsx', 'xls'].includes(extension)) {
        return '<i class="fas fa-file-excel"></i>';
    } else {
        return '<i class="fas fa-file"></i>';
    }
}

// Fonction pour formater la taille du fichier
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function uploadSingleFileForMessage(file, callback) {
    const formData = new FormData();
    formData.append('file', file);
    if (currentSessionId) {
        formData.append('session_id', currentSessionId);
    }
    
    const xhr = new XMLHttpRequest();
    
    xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                console.log('✅ Fichier uploadé:', file.name);
                // Stocker les informations du fichier pour l'affichage
                if (response.filename) {
                    uploadedFileContents.push({
                        filename: response.filename,
                        size: file.size,
                        content: response.file_content
                    });
                }
                callback(response);
            } else {
                console.error('❌ Erreur upload:', response.error);
                callback(null);
            }
        } else {
            console.error('❌ Erreur HTTP:', xhr.status);
            callback(null);
        }
    });
    
    xhr.addEventListener('error', () => {
        console.error('❌ Erreur réseau');
        callback(null);
    });
    
    xhr.open('POST', '/chatbot/api/upload/');
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
    xhr.send(formData);
}

function sendMessageWithFiles() {
    console.log('💬 Envoi du message avec contexte des fichiers');
    
    // Envoyer la requête au serveur
    fetch('/chatbot/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: pendingMessage || 'Analysez les fichiers uploadés',
            session_id: currentSessionId
        })
    })
    .then(response => {
        console.log('📡 Réponse reçue:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('📊 Données reçues:', data);
        if (data.success) {
            console.log('✅ Succès - Ajout de la réponse');
            // Mettre à jour l'ID de session si c'est une nouvelle session
            if (data.session_id && !currentSessionId) {
                currentSessionId = data.session_id;
                updateSessionList();
            }
            
            // Ajouter la réponse de l'assistant
            addMessage('assistant', data.response);
            
            // Afficher les PDFs uploadés après l'envoi
            displayUploadedPDFs();
        } else {
            console.log('❌ Erreur dans la réponse:', data.error);
            addMessage('assistant', 'Désolé, une erreur est survenue. Veuillez réessayer.');
        }
    })
    .catch(error => {
        console.error('❌ Erreur de requête:', error);
        addMessage('assistant', 'Désolé, une erreur de connexion est survenue.');
    })
    .finally(() => {
        console.log('🏁 Fin de l\'envoi - Désactivation du mode chargement');
        setLoading(false);
        // Nettoyer les données en attente
        pendingMessage = '';
        pendingFiles = [];
        uploadedFileContents = []; // Vider aussi le contenu des fichiers
        document.getElementById('message-input').value = '';
        // Mettre à jour l'indicateur
        updatePendingFilesIndicator();
        // Fermer la zone d'upload si elle est ouverte
        if (isFileUploadVisible) {
            toggleFileUpload();
        }
    });
}

function addMessage(type, content) {
    console.log(`💬 Ajout d'un message ${type}:`, content);
    const messagesContainer = document.getElementById('chat-messages');
    
    if (!messagesContainer) {
        console.error('❌ Container chat-messages non trouvé');
        return;
    }
    
    console.log('✅ Container trouvé, création du message');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (type === 'assistant') {
        // Traitement markdown pour les réponses de l'assistant
        const processedContent = processMarkdown(content);
        contentDiv.innerHTML = `<strong>Assistant :</strong> ${processedContent}`;
    } else {
        // Vérifier si le contenu contient du HTML (pièce jointe)
        if (content.includes('<div class="file-attachment">')) {
            // C'est une pièce jointe, afficher directement le HTML
            contentDiv.innerHTML = `<strong>Vous :</strong> ${content}`;
        } else {
            // C'est du texte normal, l'échapper
            contentDiv.innerHTML = `<strong>Vous :</strong> ${escapeHtml(content)}`;
        }
    }
    
    messageDiv.appendChild(contentDiv);
    messagesContainer.appendChild(messageDiv);
    console.log('✅ Message ajouté au DOM');
    
    // Scroll vers le bas
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function processMarkdown(text) {
    if (!text) return '';
    
    // Traitement des blocs de code
    text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        const language = lang || 'text';
        const escapedCode = escapeHtml(code.trim());
        return `
        <div class="code-container">
            <div class="code-header">
                <span class="language-label">${language.toUpperCase()}</span>
                <button class="copy-btn" onclick="copyCode(this)">📋 Copier</button>
            </div>
            <div class="code-content">
                <pre><code class="language-${language}">${escapedCode}</code></pre>
            </div>
        </div>
        `;
    });
    
    // Traitement du code inline
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Traitement des titres
    text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
    text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
    
    // Traitement des listes
    text = text.replace(/^\- (.*$)/gm, '<li>$1</li>');
    text = text.replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>');
    
    // Traitement des paragraphes
    text = text.replace(/\n\n/g, '</p><p>');
    text = '<p>' + text + '</p>';
    
    // Traitement des listes
    text = text.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
    
    // Traitement des liens
    text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    // Traitement du texte en gras
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
    
    // Traitement du texte en italique
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    text = text.replace(/_(.*?)_/g, '<em>$1</em>');
    
    return text;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyCode(button) {
    const codeContainer = button.closest('.code-container');
    const codeElement = codeContainer.querySelector('code');
    const text = codeElement.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = '✅ Copié!';
        button.style.background = '#28a745';
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '#4a5568';
        }, 2000);
    }).catch(err => {
        console.error('Erreur lors de la copie:', err);
        button.textContent = '❌ Erreur';
        button.style.background = '#dc3545';
        
        setTimeout(() => {
            button.textContent = '📋 Copier';
            button.style.background = '#4a5568';
        }, 2000);
    });
}

function setLoading(loading) {
    isLoading = loading;
    const sendButton = document.getElementById('send-button');
    const messageInput = document.getElementById('message-input');
    const typingIndicator = document.getElementById('typing-indicator');
    
    if (loading) {
        sendButton.disabled = true;
        messageInput.disabled = true;
        typingIndicator.style.display = 'block';
    } else {
        sendButton.disabled = false;
        messageInput.disabled = false;
        typingIndicator.style.display = 'none';
        messageInput.focus();
    }
}

function loadSession(sessionId) {
    // Mettre à jour l'interface des sessions
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-session-id="${sessionId}"]`).classList.add('active');
    
    currentSessionId = sessionId;
    
    // Charger les messages de la session
    fetch(`/chatbot/api/session/${sessionId}/`)
    .then(response => response.json())
    .then(data => {
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = '';
        
        data.messages.forEach(msg => {
            addMessage(msg.type, msg.content);
        });
        
        // Afficher les PDFs uploadés pour cette session
        displayUploadedPDFs();
    })
    .catch(error => {
        console.error('Erreur lors du chargement de la session:', error);
    });
}

function createNewSession() {
    currentSessionId = null;
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML = '';
    
    addMessage('assistant', 'Bonjour ! Je suis votre assistant éducatif. Comment puis-je vous aider aujourd\'hui ?');
}

function updateSessionList() {
    // Recharger la liste des sessions
    fetch('/chatbot/')
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newSessionsList = doc.getElementById('sessions-list');
        if (newSessionsList) {
            document.getElementById('sessions-list').innerHTML = newSessionsList.innerHTML;
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
    }

    // Fonction pour afficher les PDFs uploadés
    function displayUploadedPDFs() {
        if (!currentSessionId) {
            console.log('⚠️ Aucune session active');
            return;
        }
        
        fetch(`/chatbot/api/files/${currentSessionId}/`)
        .then(response => response.json())
        .then(data => {
            const section = document.getElementById('uploaded-pdfs-section');
            const list = document.getElementById('uploaded-pdfs-list');
            
            if (data.files && data.files.length > 0) {
                section.style.display = 'block';
                list.innerHTML = '';
                
                data.files.forEach(file => {
                    if (file.file_type === 'pdf') {
                        const pdfItem = document.createElement('div');
                        pdfItem.className = 'uploaded-pdf-item';
                        pdfItem.innerHTML = `
                            <div class="pdf-info">
                                <i class="fas fa-file-pdf pdf-icon"></i>
                                <div class="pdf-details">
                                    <div class="pdf-name">${file.filename}</div>
                                    <div class="pdf-size">${file.file_size}</div>
                                </div>
                            </div>
                            <div class="pdf-actions">
                                <button class="btn-ask-pdf" onclick="askAboutPDF('${file.filename}')">
                                    <i class="fas fa-question-circle"></i> Poser une question
                                </button>
                                <button class="btn-remove-pdf" onclick="removePDF(${file.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        list.appendChild(pdfItem);
                    }
                });
            } else {
                section.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des PDFs:', error);
        });
    }
    
    // Fonction pour poser une question sur un PDF spécifique
    function askAboutPDF(filename) {
        const question = prompt(`Que voulez-vous savoir sur le fichier "${filename}" ?`);
        if (question && question.trim()) {
            const messageInput = document.getElementById('message-input');
            messageInput.value = `Question sur ${filename}: ${question.trim()}`;
            messageInput.focus();
        }
    }
    
    // Fonction pour supprimer un PDF
    function removePDF(fileId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce PDF ?')) {
            // Ici vous pouvez ajouter une fonction pour supprimer le PDF
            console.log('Suppression du PDF:', fileId);
            displayUploadedPDFs(); // Recharger la liste
        }
    }

// Fonction pour générer un PDF
function generatePDF() {
    console.log('📄 Génération de PDF demandée');
    
    // Récupérer le contenu de l'input du chatbot
    const messageInput = document.getElementById('message-input');
    const question = messageInput.value.trim();
    
    if (!question) {
        alert('Veuillez d\'abord écrire votre question dans le champ de saisie.');
        messageInput.focus();
        return;
    }
    
    // Afficher un message de chargement
    addMessage('assistant', '🔄 Génération de la réponse et du PDF en cours...');
    
    // D'abord, envoyer la question au chatbot pour obtenir une réponse complète
    fetch('/chatbot/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: question,
            session_id: currentSessionId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.response) {
            // Utiliser la réponse du chatbot pour générer le PDF
            const responseContent = data.response;
            
            // Détecter automatiquement le type de PDF basé sur la question
            const educationalKeywords = ['cours', 'leçon', 'chapitre', 'résumé', 'explication', 'théorie', 'concept', 'définition', 'article'];
            const isEducational = educationalKeywords.some(keyword => question.toLowerCase().includes(keyword));
            const pdfType = isEducational ? 'educational' : 'normal';
            
            // Créer un titre et nom de fichier basés sur la question
            const title = question.length > 50 ? question.substring(0, 47) + '...' : question;
            const filename = question.length > 30 ? question.substring(0, 27) + '...' + '.pdf' : question + '.pdf';
            const cleanFilename = filename.replace(/[<>:"/\\|?*]/g, '_');
            
            let topic = 'Sujet éducatif';
            let level = 'intermédiaire';
            
            if (pdfType === 'educational') {
                // Essayer d'extraire le sujet de la question
                if (question.toLowerCase().includes('math')) topic = 'Mathématiques';
                else if (question.toLowerCase().includes('physique')) topic = 'Physique';
                else if (question.toLowerCase().includes('chimie')) topic = 'Chimie';
                else if (question.toLowerCase().includes('informatique')) topic = 'Informatique';
                else if (question.toLowerCase().includes('histoire')) topic = 'Histoire';
                else if (question.toLowerCase().includes('français')) topic = 'Français';
                else if (question.toLowerCase().includes('ia') || question.toLowerCase().includes('intelligence artificielle')) topic = 'Intelligence Artificielle';
                
                // Détecter le niveau
                if (question.toLowerCase().includes('débutant') || question.toLowerCase().includes('facile')) level = 'débutant';
                else if (question.toLowerCase().includes('avancé') || question.toLowerCase().includes('difficile')) level = 'avancé';
            }
            
            // Préparer les données pour le PDF avec la réponse du chatbot
            const pdfData = {
                content: responseContent.trim(),
                title: title.trim(),
                filename: cleanFilename.trim(),
                type: pdfType
            };
            
            if (pdfType === 'educational') {
                pdfData.topic = topic.trim();
                pdfData.level = level.trim();
            }
            
            console.log('📊 Données PDF:', pdfData);
            
            // Générer le PDF avec la réponse du chatbot
            return fetch('/chatbot/api/generate-pdf/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(pdfData)
            }).then(response => {
                console.log('📡 Réponse PDF reçue:', response.status);
                
                if (response.ok) {
                    return response.blob().then(blob => {
                        console.log('✅ PDF généré avec succès');
                        
                        // Créer un lien de téléchargement
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = pdfData.filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Afficher un message de succès
                        addMessage('assistant', `✅ PDF généré et téléchargé avec la réponse complète !`);
                        
                        // Vider l'input après génération
                        messageInput.value = '';
                    });
                } else {
                    throw new Error('Erreur lors de la génération du PDF');
                }
            });
        } else {
            throw new Error('Aucune réponse reçue du chatbot');
        }
    })
    .catch(error => {
        console.error('❌ Erreur lors de la génération du PDF:', error);
        addMessage('assistant', '❌ Erreur lors de la génération du PDF. Veuillez réessayer.');
    });
}
</script>
{% endblock %}
