{% extends 'users/base.html' %}

{% block title %}Record Voice - GenEX{% endblock %}

{% block content %}
<h2>üé§ Voice Recording</h2>

<div style="max-width: 600px; margin: 0 auto;">
    <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <form id="voiceForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="language">Language:</label>
                <select id="language" name="language" required>
                    <option value="en">English</option>
                    <option value="fr">French</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="theme">Theme (Optional):</label>
                <input type="text" id="theme" name="theme" placeholder="e.g., My Daily Routine, My Favorite Book...">
            </div>
            
            <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <h4>Option 1: Record Live</h4>
                <button type="button" id="recordBtn" class="btn" style="margin: 10px;">
                    üéôÔ∏è Start Recording
                </button>
                <button type="button" id="stopBtn" class="btn" style="margin: 10px; display: none; background: #dc3545;">
                    ‚èπÔ∏è Stop Recording
                </button>
                <div id="recordingStatus" style="margin-top: 10px; font-weight: bold;"></div>
                <audio id="audioPlayback" controls style="margin-top: 10px; display: none; width: 100%;"></audio>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <strong>OR</strong>
            </div>
            
            <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="text-align: center;">Option 2: Upload Audio File</h4>
                <div class="form-group">
                    <input type="file" id="audioFile" name="audio_file" accept="audio/*">
                    <small>Accepted formats: MP3, WAV, M4A, OGG (Max 10MB)</small>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                <strong>Tips for Best Results:</strong>
                <ul style="margin: 10px 0;">
                    <li>Speak for 30-180 seconds</li>
                    <li>Choose a quiet environment</li>
                    <li>Speak naturally and clearly</li>
                    <li>Organize your thoughts before recording</li>
                </ul>
            </div>
            
            <button type="submit" class="btn" style="width: 100%; margin-top: 20px; font-size: 18px;">
                Submit for Evaluation
            </button>
        </form>
    </div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let recordedBlob;

const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const recordingStatus = document.getElementById('recordingStatus');
const audioPlayback = document.getElementById('audioPlayback');
const audioFileInput = document.getElementById('audioFile');
const voiceForm = document.getElementById('voiceForm');

recordBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(recordedBlob);
            audioPlayback.src = audioUrl;
            audioPlayback.style.display = 'block';
            recordingStatus.textContent = 'Recording complete! You can play it back or submit.';
            recordingStatus.style.color = '#28a745';
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        recordBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        recordingStatus.textContent = 'üî¥ Recording...';
        recordingStatus.style.color = '#dc3545';
    } catch (err) {
        alert('Error accessing microphone: ' + err.message);
    }
});

stopBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        stopBtn.style.display = 'none';
        recordBtn.style.display = 'inline-block';
    }
});

voiceForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(voiceForm);
    
    // If recorded audio exists and no file uploaded, use recorded audio
    if (recordedBlob && !audioFileInput.files[0]) {
        const file = new File([recordedBlob], 'recording.wav', { type: 'audio/wav' });
        formData.set('audio_file', file);
    } else if (!audioFileInput.files[0]) {
        alert('Please record audio or upload a file.');
        return;
    }
    
    // Show loading
    recordingStatus.textContent = 'Processing... This may take a minute.';
    recordingStatus.style.color = '#007bff';
    
    try {
        const response = await fetch('/voice/api/evaluations/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            window.location.href = `/voice/${result.id}/`;
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Processing failed'));
            recordingStatus.textContent = '';
        }
    } catch (err) {
        alert('Error submitting: ' + err.message);
        recordingStatus.textContent = '';
    }
});
</script>

<style>
.btn {
    padding: 12px 24px;
    font-size: 16px;
}
</style>
{% endblock %}